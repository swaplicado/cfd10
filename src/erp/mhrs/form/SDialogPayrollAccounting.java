/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package erp.mhrs.form;

import erp.SClient;
import erp.client.SClientInterface;
import erp.data.SDataConstants;
import erp.data.SDataConstantsSys;
import erp.data.SDataReadDescriptions;
import erp.data.SDataUtilities;
import erp.lib.SLibConstants;
import erp.lib.SLibUtilities;
import erp.lib.form.SFormUtilities;
import erp.lib.table.STableColumnForm;
import erp.lib.table.STableConstants;
import erp.lib.table.STablePaneGrid;
import erp.mbps.data.SDataBizPartner;
import erp.mfin.data.SDataAccount;
import erp.mfin.data.SDataRecord;
import erp.mfin.data.SDataRecordEntry;
import erp.mfin.data.SDataTax;
import erp.mfin.form.SDialogRecordPicker;
import erp.mhrs.data.SDataFormerPayroll;
import erp.mhrs.data.SDataFormerPayrollEmp;
import erp.mhrs.data.SDataFormerPayrollMove;
import erp.mhrs.data.SRowEmployee;
import erp.mitm.data.SDataItem;
import erp.mod.SModConsts;
import erp.mod.SModSysConsts;
import erp.mod.fin.db.SFinUtils;
import erp.mod.hrs.db.SDbAccountingPayroll;
import erp.mod.hrs.db.SDbAccountingPayrollEmployee;
import erp.mod.hrs.db.SDbPayroll;
import erp.mod.hrs.db.SHrsConsts;
import erp.mod.hrs.db.SHrsFinUtils;
import erp.mod.hrs.db.SHrsFormerConsts;
import erp.mod.utils.SDialogMessages;
import erp.server.SServerConstants;
import erp.server.SServerRequest;
import erp.server.SServerResponse;
import java.awt.BorderLayout;
import java.awt.Cursor;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.sql.ResultSet;
import java.sql.Statement;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Vector;
import javax.swing.JButton;
import javax.swing.JDialog;
import javax.swing.JOptionPane;
import sa.gui.util.SUtilConsts;
import sa.lib.SLibUtils;
import sa.lib.grid.SGridUtils;
import sa.lib.gui.SGuiClient;
import sa.lib.gui.SGuiConsts;
import sa.lib.gui.SGuiUtils;
import sa.lib.srv.SSrvConsts;

/**
 *
 * @author Sergio Flores, Juan Barajas, Sergio Flores
 */
public class SDialogPayrollAccounting extends JDialog implements ActionListener {
    
    private int mnFormResult;
    private boolean mbFirstTime;
    private java.util.Vector<erp.lib.form.SFormField> mvFields;
    private java.text.SimpleDateFormat moDateFormat;

    private erp.client.SClientInterface miClient;
    private erp.lib.table.STablePane moTablePaneEmpAvailable;
    private erp.lib.table.STablePane moTablePaneEmpSelected;
    private java.lang.String msPayType;
    private java.lang.String msPayTypeAbbr;
    private erp.mfin.form.SDialogRecordPicker moDialogRecordPicker;
    private erp.mfin.data.SDataRecord moCurrentRecord;
    private erp.mhrs.data.SDataFormerPayroll moFormerPayroll;
    private java.util.Vector<java.lang.Object[]> mvRecords; // idx 0: record registry (SDataRecord); idx 1: selected employees (Vector<Integer>)
    
    private SDbPayroll moPayroll;
    private SDbAccountingPayroll moAccountingPayroll;

    /** Creates new form SDialogPayrollAccounting
     * @param client
     * @param payroll
     */
    public SDialogPayrollAccounting(SClientInterface client, SDbPayroll payroll) {
        super(client.getFrame(), true);
        miClient = client;
        moPayroll = payroll;
        initComponents();
        initComponentsExtra();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jpGrid = new javax.swing.JPanel();
        jPanel1 = new javax.swing.JPanel();
        jPanel3 = new javax.swing.JPanel();
        jlPayroll = new javax.swing.JLabel();
        jtfPayrollPeriod = new javax.swing.JTextField();
        jtfPayrollNumber = new javax.swing.JTextField();
        jPanel5 = new javax.swing.JPanel();
        jlPayrollDates = new javax.swing.JLabel();
        jtfPayrollDates = new javax.swing.JTextField();
        jlPayrollNet = new javax.swing.JLabel();
        jtfPayrollNet = new javax.swing.JTextField();
        jtfPayrollNetCur = new javax.swing.JTextField();
        jPanel6 = new javax.swing.JPanel();
        jlPayrollNotes = new javax.swing.JLabel();
        jtfPayrollNotes = new javax.swing.JTextField();
        jPanel4 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jpAccountingRecord = new javax.swing.JPanel();
        jlRecord = new javax.swing.JLabel();
        jtfRecordDate = new javax.swing.JTextField();
        jtfRecordBkc = new javax.swing.JTextField();
        jtfRecordBranch = new javax.swing.JTextField();
        jtfRecordNumber = new javax.swing.JTextField();
        jbPickRecord = new javax.swing.JButton();
        jlDummy3 = new javax.swing.JLabel();
        jpPaymentType = new javax.swing.JPanel();
        jlBankFilter = new javax.swing.JLabel();
        jcbBankFilter = new javax.swing.JComboBox();
        jlBankFilterHint = new javax.swing.JLabel();
        jpEmployeesAvailable = new javax.swing.JPanel();
        jlTotalAvailables = new javax.swing.JLabel();
        jpEmployeesSelected = new javax.swing.JPanel();
        jlTotalSelected = new javax.swing.JLabel();
        jpControls = new javax.swing.JPanel();
        jPanel7 = new javax.swing.JPanel();
        jlDummy01 = new javax.swing.JLabel();
        jbAdd = new javax.swing.JButton();
        jbAddAll = new javax.swing.JButton();
        jbRemove = new javax.swing.JButton();
        jbRemoveAll = new javax.swing.JButton();
        jPanel2 = new javax.swing.JPanel();
        jbOk = new javax.swing.JButton();
        jbCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Contabilización de nóminas");
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jpGrid.setLayout(new java.awt.BorderLayout());

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos de la nómina:"));
        jPanel1.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jPanel3.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayroll.setText("Nómina:");
        jlPayroll.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel3.add(jlPayroll);

        jtfPayrollPeriod.setEditable(false);
        jtfPayrollPeriod.setText("2001-01");
        jtfPayrollPeriod.setFocusable(false);
        jtfPayrollPeriod.setPreferredSize(new java.awt.Dimension(70, 23));
        jPanel3.add(jtfPayrollPeriod);

        jtfPayrollNumber.setEditable(false);
        jtfPayrollNumber.setText("QNA. 1");
        jtfPayrollNumber.setFocusable(false);
        jtfPayrollNumber.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel3.add(jtfPayrollNumber);

        jPanel1.add(jPanel3);

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayrollDates.setText("Período nómina:");
        jlPayrollDates.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel5.add(jlPayrollDates);

        jtfPayrollDates.setEditable(false);
        jtfPayrollDates.setText("01/01/2001 - 01/01/2001");
        jtfPayrollDates.setFocusable(false);
        jtfPayrollDates.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel5.add(jtfPayrollDates);

        jlPayrollNet.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlPayrollNet.setText("Alcance neto:");
        jlPayrollNet.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel5.add(jlPayrollNet);

        jtfPayrollNet.setEditable(false);
        jtfPayrollNet.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfPayrollNet.setText("9,999,999.99");
        jtfPayrollNet.setFocusable(false);
        jtfPayrollNet.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel5.add(jtfPayrollNet);

        jtfPayrollNetCur.setEditable(false);
        jtfPayrollNetCur.setText("MXN");
        jtfPayrollNetCur.setFocusable(false);
        jtfPayrollNetCur.setPreferredSize(new java.awt.Dimension(35, 23));
        jPanel5.add(jtfPayrollNetCur);

        jPanel1.add(jPanel5);

        jPanel6.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayrollNotes.setText("Comentarios:");
        jlPayrollNotes.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel6.add(jlPayrollNotes);

        jtfPayrollNotes.setEditable(false);
        jtfPayrollNotes.setText("PAYROLL NOTES");
        jtfPayrollNotes.setFocusable(false);
        jtfPayrollNotes.setPreferredSize(new java.awt.Dimension(650, 23));
        jPanel6.add(jtfPayrollNotes);

        jPanel1.add(jPanel6);

        jpGrid.add(jPanel1, java.awt.BorderLayout.PAGE_START);

        jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder("Detalles de la contabilización de la nómina:"));
        jPanel4.setLayout(new java.awt.BorderLayout(5, 5));

        jPanel8.setLayout(new java.awt.GridLayout(2, 0, 0, 5));

        jpAccountingRecord.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlRecord.setText("Póliza contable:");
        jlRecord.setPreferredSize(new java.awt.Dimension(100, 23));
        jpAccountingRecord.add(jlRecord);

        jtfRecordDate.setEditable(false);
        jtfRecordDate.setText("01/01/2000");
        jtfRecordDate.setToolTipText("Fecha de la póliza contable");
        jtfRecordDate.setFocusable(false);
        jtfRecordDate.setPreferredSize(new java.awt.Dimension(65, 23));
        jpAccountingRecord.add(jtfRecordDate);

        jtfRecordBkc.setEditable(false);
        jtfRecordBkc.setText("BKC");
        jtfRecordBkc.setToolTipText("Centro contable");
        jtfRecordBkc.setFocusable(false);
        jtfRecordBkc.setPreferredSize(new java.awt.Dimension(35, 23));
        jpAccountingRecord.add(jtfRecordBkc);

        jtfRecordBranch.setEditable(false);
        jtfRecordBranch.setText("BRA");
        jtfRecordBranch.setToolTipText("Sucursal de la empresa");
        jtfRecordBranch.setFocusable(false);
        jtfRecordBranch.setPreferredSize(new java.awt.Dimension(35, 23));
        jpAccountingRecord.add(jtfRecordBranch);

        jtfRecordNumber.setEditable(false);
        jtfRecordNumber.setText("TP-000001");
        jtfRecordNumber.setToolTipText("Número de póliza contable");
        jtfRecordNumber.setFocusable(false);
        jtfRecordNumber.setPreferredSize(new java.awt.Dimension(65, 23));
        jpAccountingRecord.add(jtfRecordNumber);

        jbPickRecord.setText("...");
        jbPickRecord.setToolTipText("Seleccionar póliza contable");
        jbPickRecord.setPreferredSize(new java.awt.Dimension(23, 23));
        jpAccountingRecord.add(jbPickRecord);

        jlDummy3.setPreferredSize(new java.awt.Dimension(122, 23));
        jpAccountingRecord.add(jlDummy3);

        jPanel8.add(jpAccountingRecord);

        jpPaymentType.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlBankFilter.setText("Filtro banco:");
        jlBankFilter.setPreferredSize(new java.awt.Dimension(100, 23));
        jpPaymentType.add(jlBankFilter);

        jcbBankFilter.setPreferredSize(new java.awt.Dimension(300, 23));
        jpPaymentType.add(jcbBankFilter);

        jlBankFilterHint.setForeground(java.awt.SystemColor.textInactiveText);
        jlBankFilterHint.setText("(al seleccionar empleados)");
        jlBankFilterHint.setPreferredSize(new java.awt.Dimension(200, 23));
        jpPaymentType.add(jlBankFilterHint);

        jPanel8.add(jpPaymentType);

        jPanel4.add(jPanel8, java.awt.BorderLayout.NORTH);

        jpEmployeesAvailable.setBorder(javax.swing.BorderFactory.createTitledBorder("Empleados disponibles:"));
        jpEmployeesAvailable.setPreferredSize(new java.awt.Dimension(450, 100));
        jpEmployeesAvailable.setLayout(new java.awt.BorderLayout());

        jlTotalAvailables.setText("n");
        jlTotalAvailables.setPreferredSize(new java.awt.Dimension(100, 20));
        jpEmployeesAvailable.add(jlTotalAvailables, java.awt.BorderLayout.SOUTH);

        jPanel4.add(jpEmployeesAvailable, java.awt.BorderLayout.LINE_START);

        jpEmployeesSelected.setBorder(javax.swing.BorderFactory.createTitledBorder("Empleados seleccionados:"));
        jpEmployeesSelected.setPreferredSize(new java.awt.Dimension(475, 100));
        jpEmployeesSelected.setLayout(new java.awt.BorderLayout());

        jlTotalSelected.setText("n");
        jlTotalSelected.setPreferredSize(new java.awt.Dimension(100, 20));
        jpEmployeesSelected.add(jlTotalSelected, java.awt.BorderLayout.SOUTH);

        jPanel4.add(jpEmployeesSelected, java.awt.BorderLayout.LINE_END);

        jpControls.setLayout(new java.awt.BorderLayout());

        jPanel7.setLayout(new java.awt.GridLayout(5, 1, 0, 5));
        jPanel7.add(jlDummy01);

        jbAdd.setText(">");
        jbAdd.setToolTipText("Agregar");
        jbAdd.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel7.add(jbAdd);

        jbAddAll.setText(">>");
        jbAddAll.setToolTipText("Agregar todos");
        jbAddAll.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel7.add(jbAddAll);

        jbRemove.setText("<");
        jbRemove.setToolTipText("Remover");
        jbRemove.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel7.add(jbRemove);

        jbRemoveAll.setText("<<");
        jbRemoveAll.setToolTipText("Remover todos");
        jbRemoveAll.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel7.add(jbRemoveAll);

        jpControls.add(jPanel7, java.awt.BorderLayout.PAGE_START);

        jPanel4.add(jpControls, java.awt.BorderLayout.CENTER);

        jpGrid.add(jPanel4, java.awt.BorderLayout.CENTER);

        getContentPane().add(jpGrid, java.awt.BorderLayout.CENTER);

        jPanel2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jbOk.setText("Aceptar");
        jbOk.setToolTipText("[Ctrl + Enter]");
        jbOk.setPreferredSize(new java.awt.Dimension(75, 23));
        jbOk.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbOkActionPerformed(evt);
            }
        });
        jPanel2.add(jbOk);

        jbCancel.setText("Cancelar");
        jbCancel.setToolTipText("[Escape]");
        jbCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbCancelActionPerformed(evt);
            }
        });
        jPanel2.add(jbCancel);

        getContentPane().add(jPanel2, java.awt.BorderLayout.PAGE_END);

        setSize(new java.awt.Dimension(1056, 689));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        windowActivated();
    }//GEN-LAST:event_formWindowActivated

    private void jbOkActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbOkActionPerformed
        actionOk();
    }//GEN-LAST:event_jbOkActionPerformed

    private void jbCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbCancelActionPerformed
        actionCancel();
    }//GEN-LAST:event_jbCancelActionPerformed

    private void initComponentsExtra() {
        int i = 0;
        STableColumnForm[] aoTableColumns = null;

        mvFields = new Vector<>();

        moTablePaneEmpAvailable = new STablePaneGrid(miClient);
        moTablePaneEmpAvailable.setDoubleClickAction(this, "actionAdd");
        jpEmployeesAvailable.add(moTablePaneEmpAvailable, BorderLayout.CENTER);

        moTablePaneEmpSelected = new STablePaneGrid(miClient);
        moTablePaneEmpSelected.setDoubleClickAction(this, "actionRemove");
        jpEmployeesSelected.add(moTablePaneEmpSelected, BorderLayout.CENTER);

        moDateFormat = new SimpleDateFormat("yyyyMMdd");
        moAccountingPayroll = new SDbAccountingPayroll();

        msPayType = "";
        msPayTypeAbbr = "";
        moDialogRecordPicker = new SDialogRecordPicker(miClient, SDataConstants.FINX_REC_USER);
        moFormerPayroll = null;
        moCurrentRecord = null;
        mvRecords = new Vector<>();

        i = 0;
        aoTableColumns = new STableColumnForm[8];
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Nombre empleado", 150);
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_INTEGER, "Clave empleado", STableConstants.WIDTH_NUM_SMALLINT);
        aoTableColumns[i++].setCellRenderer(SGridUtils.CellRendererIntegerRaw);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Departamento", 100);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Código departamento", 50);
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Percepciones $", STableConstants.WIDTH_VALUE);
        aoTableColumns[i++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererValue());
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Deducciones $", STableConstants.WIDTH_VALUE);
        aoTableColumns[i++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererValue());
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Alcance neto $", STableConstants.WIDTH_VALUE);
        aoTableColumns[i++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererValue());
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Banco", 100);

        for (i = 0; i < aoTableColumns.length; i++) {
            moTablePaneEmpAvailable.addTableColumn(aoTableColumns[i]);
        }

        i = 0;
        aoTableColumns = new STableColumnForm[13];
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Nombre empleado", 150);
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_INTEGER, "Clave empleado", STableConstants.WIDTH_NUM_SMALLINT);
        aoTableColumns[i++].setCellRenderer(SGridUtils.CellRendererIntegerRaw);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Departamento", 100);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Código departamento", 50);
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Percepciones $", STableConstants.WIDTH_VALUE);
        aoTableColumns[i++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererValue());
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Deducciones $", STableConstants.WIDTH_VALUE);
        aoTableColumns[i++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererValue());
        aoTableColumns[i] = new STableColumnForm(SLibConstants.DATA_TYPE_DOUBLE, "Alcance neto $", STableConstants.WIDTH_VALUE);
        aoTableColumns[i++].setCellRenderer(miClient.getSessionXXX().getFormatters().getTableCellRendererValue());
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Banco", 100);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Período póliza", STableConstants.WIDTH_YEAR_PERIOD);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Centro contable", STableConstants.WIDTH_CODE_COB);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Sucursal empresa", STableConstants.WIDTH_CODE_COB);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_STRING, "Folio póliza", STableConstants.WIDTH_RECORD_NUM);
        aoTableColumns[i++] = new STableColumnForm(SLibConstants.DATA_TYPE_DATE, "Fecha póliza", STableConstants.WIDTH_DATE);

        for (i = 0; i < aoTableColumns.length; i++) {
            moTablePaneEmpSelected.addTableColumn(aoTableColumns[i]);
        }

        jbPickRecord.addActionListener(this);
        jbAdd.addActionListener(this);
        jbAddAll.addActionListener(this);
        jbRemove.addActionListener(this);
        jbRemoveAll.addActionListener(this);

        SFormUtilities.createActionMap(rootPane, this, "actionOk", "ok", KeyEvent.VK_ENTER, KeyEvent.CTRL_DOWN_MASK);
        SFormUtilities.createActionMap(rootPane, this, "actionCancel", "cancel", KeyEvent.VK_ESCAPE, 0);
    }

    private void windowActivated() {
        if (mbFirstTime) {
            mbFirstTime = false;

            if (miClient.getSessionXXX().getCurrentCompanyBranchId() == 0) {
                miClient.showMsgBoxWarning(SLibConstants.MSG_ERR_GUI_SESSION_BRANCH);
                actionCancel();
            }
            else {
                try {
                    populatePayroll();
                    jbPickRecord.requestFocus();
                }
                catch (Exception e) {
                    SLibUtilities.renderException(this, e);
                }
            }
        }
    }

    private void computeTotals() {
        int countAvailables = 0;
        int countSelected = 0;
        
        for (int i = 0; i < moTablePaneEmpAvailable.getTableGuiRowCount(); i++) {
            countAvailables++;
        }
        for (int i = 0; i < moTablePaneEmpSelected.getTableGuiRowCount(); i++) {
            countSelected++;
        }
        
        jlTotalAvailables.setText(" " + countAvailables + " empleados disponibles.");
        jlTotalSelected.setText(" " + countSelected + " empleados seleccionados.");
    }
    
    @SuppressWarnings("unchecked")
    private void populatePayroll() {
        // Display payroll:

        jtfPayrollPeriod.setText(moPayroll.getPeriodYear() + "-" + SLibUtils.DecimalFormatCalendarMonth.format(moPayroll.getPeriod()));
        jtfPayrollNumber.setText((moPayroll.getFkPaymentTypeId() == SModSysConsts.HRSS_TP_PAY_WEE ? "SEM " : "QNA " ) + moPayroll.getNumber());
        jtfPayrollDates.setText(SLibUtils.DateFormatDate.format(moPayroll.getDateStart()) + " - " + SLibUtils.DateFormatDate.format(moPayroll.getDateEnd()));
        jtfPayrollNotes.setText(moPayroll.getNotes());
        jtfPayrollNet.setText(SLibUtils.getDecimalFormatAmount().format(moPayroll.getAuxTotalNet()));

        jtfPayrollPeriod.setCaretPosition(0);
        jtfPayrollNumber.setCaretPosition(0);
        jtfPayrollDates.setCaretPosition(0);
        jtfPayrollNotes.setCaretPosition(0);
        jtfPayrollNet.setCaretPosition(0);

        try {
            Statement statement = miClient.getSession().getStatement();

            String sql = "SELECT per_year, per, num, fk_tp_pay, nts, dt_sta, dt_end, fk_tp_pay_sht, b_clo " +
                    "FROM hrs_pay " +
                    "WHERE id_pay = " + moPayroll.getPkPayrollId() + " ";

            ResultSet resultSet = statement.executeQuery(sql);
            if (!resultSet.next()) {
                throw new Exception("No fue posible leer el registro de la nómina.");
            }
            else {
                // Prepare payroll registry:

                switch (moPayroll.getFkPaymentTypeId()) {
                    case SModSysConsts.HRSS_TP_PAY_WEE:
                        msPayType = SHrsFormerConsts.PAY_WEE;
                        msPayTypeAbbr = SHrsFormerConsts.PAY_WEE_ABB;
                        break;
                    case SModSysConsts.HRSS_TP_PAY_FOR:
                        msPayType = SHrsFormerConsts.PAY_FOR;
                        msPayTypeAbbr = SHrsFormerConsts.PAY_FOR_ABB;
                        break;
                    default:
                }

                moFormerPayroll = new SDataFormerPayroll();
                moFormerPayroll.setPkPayrollId(moPayroll.getPkPayrollId());
                moFormerPayroll.setYear(moPayroll.getPeriodYear());
                moFormerPayroll.setPeriod(moPayroll.getPeriod());
                moFormerPayroll.setNumber(moPayroll.getNumber());
                moFormerPayroll.setType(msPayType);
                moFormerPayroll.setNote(SLibUtils.textLeft(moPayroll.getNotes(), 100));
                moFormerPayroll.setDateBegin(moPayroll.getDateStart());
                moFormerPayroll.setDateEnd(moPayroll.getDateEnd());
                moFormerPayroll.setDatePayment(moPayroll.getDateEnd());
                moFormerPayroll.setDebit_r(0);
                moFormerPayroll.setCredit_r(0);
                moFormerPayroll.setIsRegular(moPayroll.isPayrollNormal());
                moFormerPayroll.setIsClosed(moPayroll.isClosed());
                moFormerPayroll.setIsDeleted(false);
                moFormerPayroll.setFkUserNewId(miClient.getSession().getUser().getPkUserId());
                moFormerPayroll.setFkUserEditId(miClient.getSession().getUser().getPkUserId());
                moFormerPayroll.setFkUserDeleteId(miClient.getSession().getUser().getPkUserId());
                
                // Prepare bank filter:
                
                HashSet<String> banksSet = new HashSet<>();
                boolean isEmptyBankAdded = false;

                // Display payroll data:

                sql = "SELECT bp.bp, emp.id_emp, CAST(emp.num AS UNSIGNED INTEGER) AS _emp_num, dep.name, dep.code, dep.id_dep, " +
                        "p.fk_tp_pay, pr.ear_r, pr.ded_r, pr.pay_r, pr.pay_day_r, pr.day_wrk, pr.day_not_wrk_r, pr.day_pad, " +
                        "tpsal.name, tpsal.code, tpemp.name, tpemp.code, tpwrk.name, tpwrk.code, COALESCE(bnk.name, '') AS _bank " +
                        "FROM hrs_pay AS p " +
                        "INNER JOIN hrs_pay_rcp AS pr ON pr.id_pay = p.id_pay " +
                        "INNER JOIN erp.hrsu_emp AS emp ON emp.id_emp = pr.id_emp " +
                        "INNER JOIN erp.hrsu_dep AS dep ON dep.id_dep = pr.fk_dep " +
                        "INNER JOIN erp.bpsu_bp AS bp ON bp.id_bp = pr.id_emp " +
                        "INNER JOIN erp.hrss_tp_sal AS tpsal ON tpsal.id_tp_sal = pr.fk_tp_sal " +
                        "INNER JOIN erp.hrsu_tp_emp AS tpemp ON tpemp.id_tp_emp = pr.fk_tp_emp " +
                        "INNER JOIN erp.hrsu_tp_wrk AS tpwrk ON tpwrk.id_tp_wrk = pr.fk_tp_wrk " +
                        "LEFT OUTER JOIN erp.hrss_bank AS bnk ON emp.fk_bank_n = bnk.id_bank " +
                        "WHERE p.id_pay = " + moPayroll.getPkPayrollId() + " AND NOT pr.b_del " +
                        "ORDER BY bp.bp, emp.id_emp ";

                resultSet = statement.executeQuery(sql);
                while (resultSet.next()) {
                    SRowEmployee row = new SRowEmployee();

                    row.setPrimaryKey(new int[] { resultSet.getInt("emp.id_emp") });
                    row.getValues().add(resultSet.getString("bp.bp"));
                    row.getValues().add(resultSet.getInt("_emp_num"));
                    row.getValues().add(resultSet.getString("dep.name"));
                    row.getValues().add(resultSet.getString("dep.code"));
                    row.getValues().add(resultSet.getDouble("pr.ear_r"));
                    row.getValues().add(resultSet.getDouble("pr.ded_r"));
                    row.getValues().add(resultSet.getDouble("pr.pay_r"));
                    row.getValues().add(resultSet.getString("_bank"));
                    
                    row.setEmployeeCategory(resultSet.getString("tpwrk.code"));
                    row.setEmployeeType(resultSet.getString("tpemp.code"));
                    row.setSalaryType(SLibUtils.textLeft(resultSet.getString("tpsal.name"), 3)); // system's catalog, name can be truncated to length of 3
                    row.setBank(resultSet.getString("_bank"));
                    row.setSalary(resultSet.getDouble("pr.pay_day_r"));
                    row.setDaysWorked(resultSet.getInt("pr.day_wrk"));
                    row.setDaysNotWorked(resultSet.getInt("pr.day_not_wrk_r"));
                    row.setDaysPayed(resultSet.getInt("pr.day_pad"));
                    row.setFkBizPartnerId(resultSet.getInt("emp.id_emp"));
                    row.setFkPaymentSystemTypeId(0); // not supported yet!

                    moTablePaneEmpAvailable.addTableRow(row);
                    
                    // Process bank filter:
                    
                    if (row.getBank().isEmpty()) {
                        if (!isEmptyBankAdded) {
                            isEmptyBankAdded = true;
                            banksSet.add(SHrsConsts.EMPTY_BANK);
                        }
                    }
                    else {
                        banksSet.add(row.getBank());
                    }
                }

                moTablePaneEmpAvailable.renderTableRows();
                moTablePaneEmpAvailable.setTableRowSelection(0);
                
                // Set bank filter:
                
                Object[] banksArray = banksSet.toArray();
                Arrays.sort(banksArray);
                
                jcbBankFilter.removeAllItems();
                jcbBankFilter.addItem("- " + SUtilConsts.TXT_SELECT + " " + SGuiUtils.getLabelName(jlBankFilter) + " -");
                
                for (Object bank : banksArray) {
                    jcbBankFilter.addItem(bank);
                }
            }
            
            computeTotals();
        }
        catch (Exception e) {
            SLibUtilities.renderException(this, e);
        }
    }

    private boolean readRecord(Object key) {
        moCurrentRecord = (SDataRecord) SDataUtilities.readRegistry(miClient, SDataConstants.FIN_REC, key, SLibConstants.EXEC_MODE_VERBOSE);
        return true;
    }

    private void renderRecord() {
        if (moCurrentRecord == null) {
            jtfRecordDate.setText("");
            jtfRecordBranch.setText("");
            jtfRecordNumber.setText("");
        }
        else {
            jtfRecordDate.setText(miClient.getSessionXXX().getFormatters().getDateFormat().format(moCurrentRecord.getDate()));
            jtfRecordBkc.setText(SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FIN_BKC, new int[] { moCurrentRecord.getPkBookkeepingCenterId() }, SLibConstants.DESCRIPTION_CODE));
            jtfRecordBranch.setText(SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.BPSU_BPB, new int[] { moCurrentRecord.getFkCompanyBranchId() }, SLibConstants.DESCRIPTION_CODE));
            jtfRecordNumber.setText(moCurrentRecord.getPkRecordTypeId() + "-" + moCurrentRecord.getPkNumberId());
        }
    }

    @SuppressWarnings("unchecked")
    private void initPayrollRecords() {
        boolean add = false;
        Object[] recordKey = null;
        Vector<Integer> employees = null;
        SDataRecord record = null;
        SDataFormerPayrollEmp formerPayrollEmp = null;
        SRowEmployee row = null;

        mvRecords.clear();
        moFormerPayroll.getDbmsDataFormerPayrollEmps().clear();
        moFormerPayroll.getDbmsDataFormerPayrollMoves().clear();
        moFormerPayroll.getAuxDataRecords().clear();
        
        moAccountingPayroll.setRegistryNew(true);
        moAccountingPayroll.setPkPayrollId(moPayroll.getPkPayrollId());
        moAccountingPayroll.getChildAccountingPayrollEmployees().clear();

        for (int i = 0; i < moTablePaneEmpSelected.getTableGuiRowCount(); i++) {
            add = true;
            row = (SRowEmployee) moTablePaneEmpSelected.getTableRow(i);
            recordKey = (Object[]) row.getData();

            for (Object[] records : mvRecords) {
                if (SLibUtilities.compareKeys(((SDataRecord) records[0]).getPrimaryKey(), recordKey)) {
                    add = false;
                    employees = (Vector<Integer>) records[1];
                }
            }

            if (add) {
                record = (SDataRecord) SDataUtilities.readRegistry(miClient, SDataConstants.FIN_REC, recordKey, SLibConstants.EXEC_MODE_VERBOSE);
                for (SDataRecordEntry entry : record.getDbmsRecordEntries()) {
                    if (entry.getFkPayrollId_n() == moPayroll.getPkPayrollId() && !entry.getIsDeleted()) {
                        entry.setIsDeleted(true);
                        entry.setFkUserEditId(miClient.getSession().getUser().getPkUserId());
                        entry.setFkUserDeleteId(miClient.getSession().getUser().getPkUserId());
                    }
                }

                employees = new Vector<>();
                employees.add(((int[]) row.getPrimaryKey())[0]);

                mvRecords.add(new Object[] { record, employees });
            }
            else {
                employees.add(((int[]) row.getPrimaryKey())[0]);
            }

            formerPayrollEmp = new SDataFormerPayrollEmp();
            formerPayrollEmp.setPkPayrollId(moPayroll.getPkPayrollId());
            formerPayrollEmp.setPkEmployeeId(((int[]) row.getPrimaryKey())[0]);
            formerPayrollEmp.setEmployee((String) row.getValues().get(0));
            formerPayrollEmp.setDepartment((String) row.getValues().get(2));
            formerPayrollEmp.setDepartmentKey((String) row.getValues().get(3));
            formerPayrollEmp.setEmployeeCategory(row.getEmployeeCategory());
            formerPayrollEmp.setEmployeeType(row.getEmployeeType());
            formerPayrollEmp.setSalaryType(row.getSalaryType());
            formerPayrollEmp.setDebit((Double) row.getValues().get(4));
            formerPayrollEmp.setCredit((Double) row.getValues().get(5));
            formerPayrollEmp.setSalary(row.getSalary());
            formerPayrollEmp.setDaysNotWorked(row.getDaysNotWorked());
            formerPayrollEmp.setDaysWorked(row.getDaysWorked());
            formerPayrollEmp.setDaysPayed(row.getDaysPayed());
            formerPayrollEmp.setNumberSeries(SHrsConsts.CFD_SERIES);
            formerPayrollEmp.setNumber(0);
            formerPayrollEmp.setIsDeleted(false);
            formerPayrollEmp.setFkBizPartnerId_n(row.getFkBizPartnerId());
            formerPayrollEmp.setFkPaymentSystemTypeId(SDataConstantsSys.TRNU_TP_PAY_SYS_NA);
            formerPayrollEmp.setFkYearId((Integer) recordKey[0]);
            formerPayrollEmp.setFkPeriodId((Integer) recordKey[1]);
            formerPayrollEmp.setFkBookkeepingCenterId((Integer) recordKey[2]);
            formerPayrollEmp.setFkRecordTypeId((String) recordKey[3]);
            formerPayrollEmp.setFkNumberId((Integer) recordKey[4]);

            moFormerPayroll.getDbmsDataFormerPayrollEmps().add(formerPayrollEmp);
            
            moAccountingPayroll.getChildAccountingPayrollEmployees().add(row.getAccountingPayrollEmployee());
        }
    }

    private java.lang.String composeEmployeeQuery(java.util.Vector<java.lang.Integer> employees) {
        String sql = "";

        for (Integer employee : employees) {
            sql += (sql.length() == 0 ? "" : ", ") + employee;
        }

        return sql;
    }

    private erp.mfin.data.SDataRecordEntry createRecordEntry(java.lang.Object recordPk, java.lang.String concept,
            double debit, double credit, java.lang.String accountId, java.lang.String costCenterId,
            int itemId, int bpId, int bpbId, int[] taxKey, int[] sysAccountTypeKey, int[] sysMoveTypeKey, int[] sysMoveTypeKeyXXX) {
        SDataRecordEntry entry = new SDataRecordEntry();

        entry.setPkYearId((Integer) ((Object[]) recordPk)[0]);
        entry.setPkPeriodId((Integer) ((Object[]) recordPk)[1]);
        entry.setPkBookkeepingCenterId((Integer) ((Object[]) recordPk)[2]);
        entry.setPkRecordTypeId((String) ((Object[]) recordPk)[3]);
        entry.setPkNumberId((Integer) ((Object[]) recordPk)[4]);
        entry.setPkEntryId(0);
        entry.setConcept(concept);
        entry.setReference("");
        entry.setIsReferenceTax(false);
        entry.setDebit(debit);
        entry.setCredit(credit);
        entry.setExchangeRate(1);
        entry.setExchangeRateSystem(1);
        entry.setDebitCy(debit);
        entry.setCreditCy(credit);
        entry.setUnits(0);
        entry.setSortingPosition(0);
        entry.setOccasionalFiscalId("");
        entry.setIsExchangeDifference(false);
        entry.setIsSystem(true);
        entry.setIsDeleted(false);
        entry.setFkAccountIdXXX(accountId);
        entry.setFkAccountingMoveTypeId(SDataConstantsSys.FINS_CLS_ACC_MOV_JOURNAL[0]);
        entry.setFkAccountingMoveClassId(SDataConstantsSys.FINS_CLS_ACC_MOV_JOURNAL[1]);
        entry.setFkAccountingMoveSubclassId(SDataConstantsSys.FINS_CLS_ACC_MOV_JOURNAL[2]);
        entry.setFkSystemMoveClassId(sysMoveTypeKey[0]);
        entry.setFkSystemMoveTypeId(sysMoveTypeKey[1]);
        entry.setFkSystemAccountClassId(sysAccountTypeKey[0]);
        entry.setFkSystemAccountTypeId(sysAccountTypeKey[1]);
        entry.setFkSystemMoveCategoryIdXXX(sysMoveTypeKeyXXX[0]);
        entry.setFkSystemMoveTypeIdXXX(sysMoveTypeKeyXXX[1]);
        entry.setFkCurrencyId(miClient.getSessionXXX().getParamsErp().getFkCurrencyId());
        entry.setFkCostCenterIdXXX_n(costCenterId);
        entry.setFkCheckWalletId_n(0);
        entry.setFkCheckId_n(0);
        entry.setFkBizPartnerId_nr(bpId);
        entry.setFkBizPartnerBranchId_n(bpbId);
        entry.setFkReferenceCategoryId_n(0);
        entry.setFkCompanyBranchId_n(0);
        entry.setFkEntityId_n(0);
        entry.setFkTaxBasicId_n(taxKey[0]);
        entry.setFkTaxId_n(taxKey[1]);
        entry.setFkYearId_n(0);
        entry.setFkDpsYearId_n(0);
        entry.setFkDpsDocId_n(0);
        entry.setFkDpsAdjustmentYearId_n(0);
        entry.setFkDpsAdjustmentDocId_n(0);
        entry.setFkDiogYearId_n(0);
        entry.setFkDiogDocId_n(0);
        entry.setFkPayrollFormerId_n(0);
        entry.setFkPayrollId_n(moPayroll.getPkPayrollId());
        entry.setFkItemId_n(itemId);
        entry.setFkItemAuxId_n(0);
        entry.setFkUserNewId(miClient.getSession().getUser().getPkUserId());
        entry.setFkUserEditId(miClient.getSession().getUser().getPkUserId());

        return entry;
    }

    @SuppressWarnings("unchecked")
    private void computePayroll() throws java.lang.Exception {
        int nType = 0;
        int nMoveId = 0;
        int nEntryId = 0;
        int nResult = 0;
        int[] anSysAccountTypeKey = null;
        int[] anSysMoveTypeKey = null;
        int[] anSysMoveTypeKeyXXX = null;
        String sql = "";
        String conceptType = "";
        String sEmployees = "";
        Statement oStatementCfg = null;
        ResultSet oResultSetCfg = null;
        Statement oStatementRec = null;
        ResultSet oResultSetRec = null;
        SServerRequest oRequest = null;
        SServerResponse oResponse = null;
        SDataRecord oRecord = null;
        SDataFormerPayrollMove oPayrollMove = null;

        double totalDebit = 0;
        double totalCredit = 0;
        
        HashMap<String, SDataAccount> accountsMap = new HashMap<>();
        HashMap<String, SDataAccount> ledgerAccountsMap = new HashMap<>();
        HashMap<Integer, String> costCenterPksMap = new HashMap<>();

        oStatementCfg = miClient.getSession().getStatement().getConnection().createStatement();
        oStatementRec = miClient.getSession().getStatement().getConnection().createStatement();
        SDialogMessages messages = new SDialogMessages((SGuiClient) miClient, "Errores de configuración de contabilización", "Lista de errores de configuración de contabilización:");
        
        if (SHrsFinUtils.existsAccountingSettingsForPayrollAll(miClient.getSession(), moPayroll.getPkPayrollId())) {
            initPayrollRecords();

            for (Object[] records : mvRecords) {
                oRecord = (SDataRecord) records[0];
                sEmployees = composeEmployeeQuery((Vector<Integer>) records[1]);
                
                nEntryId = oRecord.getDbmsRecordEntries().size();
                
                /*
                iteration 1: processing of perceptions;
                iteration 2: processing of deductions.
                */

                for (nType = 1; nType <= 2; nType++) {
                    if (nType == 1) {
                        /* Perception:
                         * Accountable link level:
                         * 1. Global
                         * 2. By departatment
                         * 3. By employee
                         */

                        sql = "SELECT v.id_tp_acc AS f_tp_acc, ear.id_ear AS f_id_concept, rtrim(ear.code) AS f_concept_code, rtrim(ear.name) AS f_concept, rtrim(ear.name_abbr) AS f_concept_abbr, " +
                                "v.id_ref AS f_id_ref, '' AS f_ref, '' AS f_ref_cve, " +
                                "v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "FROM hrs_pay AS p " +
                                "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                "INNER JOIN hrs_pay_rcp_ear AS rcp_ear ON rcp_ear.id_pay = rcp.id_pay AND rcp_ear.id_emp = rcp.id_emp " +
                                "INNER JOIN hrs_ear AS ear ON ear.id_ear = rcp_ear.fk_ear " +
                                "INNER JOIN hrs_acc_ear AS v ON v.id_ear = ear.id_ear " +
                                "WHERE v.b_del = 0 AND p.b_del = 0 AND rcp.b_del = 0 AND rcp_ear.b_del = 0 AND v.id_tp_acc = " + SModSysConsts.HRSS_TP_ACC_GBL + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                "GROUP BY v.id_tp_acc, ear.id_ear, rtrim(ear.name_abbr), v.id_ref, v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +

                                "UNION " +

                                "SELECT v.id_tp_acc AS f_tp_acc, ear.id_ear AS f_id_concept, rtrim(ear.code) AS f_concept_code, rtrim(ear.name) AS f_concept, rtrim(ear.name_abbr) AS f_concept_abbr, " +
                                "v.id_ref AS f_id_ref, rtrim(d.name) AS f_ref, rtrim(d.code) AS f_ref_cve, " +
                                "v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "FROM hrs_pay AS p " +
                                "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                "INNER JOIN hrs_pay_rcp_ear AS rcp_ear ON rcp_ear.id_pay = rcp.id_pay AND rcp_ear.id_emp = rcp.id_emp " +
                                "INNER JOIN hrs_ear AS ear ON ear.id_ear = rcp_ear.fk_ear " +
                                "INNER JOIN hrs_acc_ear AS v ON v.id_ear = ear.id_ear " +
                                "INNER JOIN erp.hrsu_dep AS d ON d.id_dep = rcp.fk_dep AND v.id_ref = d.id_dep " +
                                "WHERE v.b_del = 0 AND p.b_del = 0 AND rcp.b_del = 0 AND rcp_ear.b_del = 0 AND v.id_tp_acc = " + SModSysConsts.HRSS_TP_ACC_DEP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                "GROUP BY v.id_tp_acc, ear.id_ear, rtrim(ear.name_abbr), v.id_ref, rtrim(d.name), rtrim(d.code), v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +

                                "UNION " +

                                "SELECT v.id_tp_acc AS f_tp_acc, ear.id_ear AS f_id_concept, rtrim(ear.code) AS f_concept_code, rtrim(ear.name) AS f_concept, rtrim(ear.name_abbr) AS f_concept_abbr, " +
                                "v.id_ref AS f_id_ref, rtrim(bp.bp) AS f_ref, emp.num AS f_ref_cve, " +
                                "v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "FROM hrs_pay AS p " +
                                "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                "INNER JOIN hrs_pay_rcp_ear AS rcp_ear ON rcp_ear.id_pay = rcp.id_pay AND rcp_ear.id_emp = rcp.id_emp " +
                                "INNER JOIN hrs_ear AS ear ON ear.id_ear = rcp_ear.fk_ear " +
                                "INNER JOIN hrs_acc_ear AS v ON v.id_ear = ear.id_ear " +
                                "INNER JOIN erp.hrsu_emp AS emp ON emp.id_emp = rcp.id_emp AND v.id_ref = emp.id_emp " +
                                "INNER JOIN erp.bpsu_bp AS bp ON bp.id_bp = emp.id_emp " +
                                "WHERE v.b_del = 0 AND p.b_del = 0 AND rcp.b_del = 0 AND rcp_ear.b_del = 0 AND v.id_tp_acc = " + SModSysConsts.HRSS_TP_ACC_EMP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                "GROUP BY v.id_tp_acc, ear.id_ear, rtrim(ear.name_abbr), v.id_ref, rtrim(bp.bp), v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "ORDER BY f_tp_acc, f_id_concept, f_id_ref; ";
                        conceptType = "percepción";
                    }
                    else {
                        /* Deduction:
                         * Accountable link level:
                         * 1. Global
                         * 2. By departatment
                         * 3. By employee
                         */

                        sql = "SELECT v.id_tp_acc AS f_tp_acc, ded.id_ded AS f_id_concept, rtrim(ded.code) AS f_concept_code, rtrim(ded.name) AS f_concept, rtrim(ded.name_abbr) AS f_concept_abbr, " +
                                "v.id_ref AS f_id_ref, '' AS f_ref, '' AS f_ref_cve, " +
                                "v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "FROM hrs_pay AS p " +
                                "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                "INNER JOIN hrs_pay_rcp_ded AS rcp_ded ON rcp_ded.id_pay = rcp.id_pay AND rcp_ded.id_emp = rcp.id_emp " +
                                "INNER JOIN hrs_ded AS ded ON ded.id_ded = rcp_ded.fk_ded " +
                                "INNER JOIN hrs_acc_ded AS v ON v.id_ded = ded.id_ded " +
                                "WHERE v.b_del = 0 AND p.b_del = 0 AND rcp.b_del = 0 AND rcp_ded.b_del = 0 AND v.id_tp_acc = " + SModSysConsts.HRSS_TP_ACC_GBL + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                "GROUP BY v.id_tp_acc, ded.id_ded, rtrim(ded.name_abbr), v.id_ref, v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +

                                "UNION " +

                                "SELECT v.id_tp_acc AS f_tp_acc, ded.id_ded AS f_id_concept, rtrim(ded.code) AS f_concept_code, rtrim(ded.name) AS f_concept, rtrim(ded.name_abbr) AS f_concept_abbr, " +
                                "v.id_ref AS f_id_ref, rtrim(d.name) AS f_ref, rtrim(d.code) AS f_ref_cve, " +
                                "v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "FROM hrs_pay AS p " +
                                "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                "INNER JOIN hrs_pay_rcp_ded AS rcp_ded ON rcp_ded.id_pay = rcp.id_pay AND rcp_ded.id_emp = rcp.id_emp " +
                                "INNER JOIN hrs_ded AS ded ON ded.id_ded = rcp_ded.fk_ded " +
                                "INNER JOIN hrs_acc_ded AS v ON v.id_ded = ded.id_ded " +
                                "INNER JOIN erp.hrsu_dep AS d ON d.id_dep = rcp.fk_dep AND v.id_ref = d.id_dep " +
                                "WHERE v.b_del = 0 AND p.b_del = 0 AND rcp.b_del = 0 AND rcp_ded.b_del = 0 AND v.id_tp_acc = " + SModSysConsts.HRSS_TP_ACC_DEP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                "GROUP BY v.id_tp_acc, ded.id_ded, rtrim(ded.name_abbr), v.id_ref, rtrim(d.name), rtrim(d.code), v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +

                                "UNION " +

                                "SELECT v.id_tp_acc AS f_tp_acc, ded.id_ded AS f_id_concept, rtrim(ded.code) AS f_concept_code, rtrim(ded.name) AS f_concept, rtrim(ded.name_abbr) AS f_concept_abbr, " +
                                "v.id_ref AS f_id_ref, rtrim(bp.bp) AS f_ref, emp.num AS f_ref_cve, " +
                                "v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "FROM hrs_pay AS p " +
                                "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                "INNER JOIN hrs_pay_rcp_ded AS rcp_ded ON rcp_ded.id_pay = rcp.id_pay AND rcp_ded.id_emp = rcp.id_emp " +
                                "INNER JOIN hrs_ded AS ded ON ded.id_ded = rcp_ded.fk_ded " +
                                "INNER JOIN hrs_acc_ded AS v ON v.id_ded = ded.id_ded " +
                                "INNER JOIN erp.hrsu_emp AS emp ON emp.id_emp = rcp.id_emp AND v.id_ref = emp.id_emp " +
                                "INNER JOIN erp.bpsu_bp AS bp ON bp.id_bp = emp.id_emp " +
                                "WHERE v.b_del = 0 AND p.b_del = 0 AND rcp.b_del = 0 AND rcp_ded.b_del = 0 AND v.id_tp_acc = " + SModSysConsts.HRSS_TP_ACC_EMP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                "GROUP BY v.id_tp_acc, ded.id_ded, rtrim(ded.name_abbr), v.id_ref, rtrim(bp.bp), v.fk_acc, v.fk_cc_n, v.fk_item_n, v.fk_bp_n, v.fk_tax_bas_n, v.fk_tax_tax_n " +
                                "ORDER BY f_tp_acc, f_id_concept, f_id_ref ";
                        conceptType = "deducción";
                    }

                    oResultSetCfg = oStatementCfg.executeQuery(sql);
                    while (oResultSetCfg.next()) {
                        int accountingType = oResultSetCfg.getInt("f_tp_acc");
                        int conceptId = oResultSetCfg.getInt("f_id_concept");
                        String conceptCode = oResultSetCfg.getString("f_concept_code");
                        String concept = oResultSetCfg.getString("f_concept");
                        String conceptAbbr = oResultSetCfg.getString("f_concept_abbr");
                        int referenceId = oResultSetCfg.getInt("f_id_ref");
                        String reference = oResultSetCfg.getString("f_ref");
                        String referenceCode = oResultSetCfg.getString("f_ref_cve");
                        int accountId = oResultSetCfg.getInt("fk_acc");
                        int costCenterId = oResultSetCfg.getInt("fk_cc_n");
                        int itemId = oResultSetCfg.getInt("fk_item_n");
                        int bizPartnerId = oResultSetCfg.getInt("fk_bp_n");
                        int taxBasicId = oResultSetCfg.getInt("fk_tax_bas_n");
                        int taxTaxId = oResultSetCfg.getInt("fk_tax_tax_n");

                        String message = "La configuración de contabilización de la " + conceptType + " código '" + conceptCode + "', '" + concept + "' ('" + conceptAbbr + "'), ";
                        
                        switch (accountingType) {
                            case SModSysConsts.HRSS_TP_ACC_GBL: // global link
                                message += "del ámbito global, tiene un problema:\n";
                                break;
                            case SModSysConsts.HRSS_TP_ACC_DEP: // link by department
                                message += "del departamento código '" + referenceCode + "', '" + reference + "', tiene un problema:\n";
                                break;
                            case SModSysConsts.HRSS_TP_ACC_EMP: // link by employee
                                message += "del empleado clave '" + referenceCode + "', '" + reference + "', tiene un problema:\n";
                                break;
                            default:
                        }

                        // Validate account:

                        if (accountId == 0) {
                            messages.appendMessage(message + "El campo 'cuenta contable' no ha sido especificada aún.");
                        }
                        else {
                            try {
                                // validates account and, if necessary, cost center:
                                SHrsFinUtils.validateAccount(miClient.getSession(), accountId, costCenterId, bizPartnerId, itemId, taxBasicId, taxTaxId);
                            }
                            catch (Exception e) {
                                messages.appendMessage(message + e.getMessage());
                            }
                        }

                        // Validate item:

                        SDataItem item = null;
                        
                        if (itemId > 0) {
                            item = (SDataItem) SDataUtilities.readRegistry(miClient, SDataConstants.ITMU_ITEM,  new int[] { itemId }, SLibConstants.EXEC_MODE_VERBOSE);
                            
                            if (item == null) {
                                messages.appendMessage(message + "El registro relacionado con el campo 'ítem' (ID: " + itemId + ") no existe.");
                            }
                            else if (item.getIsDeleted()) {
                                messages.appendMessage(message + "El registro relacionado con el campo 'ítem' (ID: " + itemId + ") está eliminado.");
                            }
                        }

                        // Validate business partner:

                        SDataBizPartner bizPartner = null;
                        
                        if (bizPartnerId == 0) {
                            if (accountingType == SModSysConsts.HRSS_TP_ACC_EMP) {
                                messages.appendMessage(message + "El campo 'asociado de negocios' no ha sido especificado aún.");
                            }
                        }
                        else {
                            bizPartner = (SDataBizPartner) SDataUtilities.readRegistry(miClient, SDataConstants.BPSU_BP, new int[] { bizPartnerId }, SLibConstants.EXEC_MODE_VERBOSE);
                            
                            if (bizPartner == null) {
                                messages.appendMessage(message + "El registro relacionado con el campo 'asociado de negocios' (ID: " + bizPartnerId + ") no existe.");
                            }
                            else if (bizPartner.getIsDeleted()) {
                                messages.appendMessage(message + "El registro relacionado con el campo 'asociado de negocios' (ID: " + bizPartnerId + ") está eliminado.");
                            }
                        }

                        // Validate tax:

                        SDataTax tax = null;
                        
                        if (taxBasicId != 0 && taxTaxId != 0) {
                            tax = (SDataTax) SDataUtilities.readRegistry(miClient, SDataConstants.FINU_TAX, new int[] { taxBasicId, taxTaxId }, SLibConstants.EXEC_MODE_VERBOSE);
                            
                            if (tax == null) {
                                messages.appendMessage(message + "El registro relacionado con el campo 'impuesto' (ID: " + taxBasicId + "-" + taxTaxId + ") no existe.");
                            }
                            else if (tax.getIsDeleted()) {
                                messages.appendMessage(message + "El registro relacionado con el campo 'impuesto' (ID: " + taxBasicId + "-" + taxTaxId + ") está eliminado.");
                            }
                        }

                        if (nType == 1) {
                            /* Perception:
                             * Accountable link level:
                             * 1. Global
                             * 2. By departatment
                             * 3. By employee
                             */

                            sql = "SELECT ear.fk_tp_acc_rec AS f_tp_acc_rec, ear.id_ear, ear.name_abbr, 0 AS f_id_ref, '' AS f_ref, '' AS f_ref_cve, SUM(rcp_ear.amt_r) AS f_amt " +
                                        "FROM hrs_pay AS p " +
                                        "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                        "INNER JOIN hrs_pay_rcp_ear AS rcp_ear ON rcp_ear.id_pay = rcp.id_pay AND rcp_ear.id_emp = rcp.id_emp " +
                                        "INNER JOIN hrs_ear AS ear ON ear.id_ear = rcp_ear.fk_ear " +
                                        "WHERE p.b_del = 0 AND rcp.b_del = 0 AND rcp_ear.b_del = 0 AND ear.fk_tp_acc_rec = " + SModSysConsts.HRSS_TP_ACC_GBL + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " " +
                                        "AND ear.id_ear = " + conceptId + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                        "GROUP BY ear.id_ear, ear.name_abbr " +

                                        "UNION " +

                                        "SELECT ear.fk_tp_acc_rec AS f_tp_acc_rec, ear.id_ear, ear.name_abbr, d.id_dep AS f_id_ref, d.name AS f_ref, d.code AS f_ref_cve, SUM(rcp_ear.amt_r) AS f_amt " +
                                        "FROM hrs_pay AS p " +
                                        "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                        "INNER JOIN hrs_pay_rcp_ear AS rcp_ear ON rcp_ear.id_pay = rcp.id_pay AND rcp_ear.id_emp = rcp.id_emp " +
                                        "INNER JOIN hrs_ear AS ear ON ear.id_ear = rcp_ear.fk_ear " +
                                        "INNER JOIN erp.hrsu_dep AS d ON d.id_dep = rcp.fk_dep " +
                                        "WHERE p.b_del = 0 AND rcp.b_del = 0 AND rcp_ear.b_del = 0 AND ear.fk_tp_acc_rec = " + SModSysConsts.HRSS_TP_ACC_DEP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " " +
                                        "AND ear.id_ear = " + conceptId + " AND rcp.id_emp IN (" + sEmployees + ")" + (accountingType == SModSysConsts.HRSS_TP_ACC_DEP ? (" AND d.id_dep = " + referenceId + " ") : "") + 
                                        "GROUP BY ear.id_ear, ear.name_abbr, d.id_dep, d.name, d.code " +

                                        "UNION " +

                                        "SELECT ear.fk_tp_acc_rec AS f_tp_acc_rec, ear.id_ear, ear.name_abbr, bp.id_bp AS f_id_ref, bp.bp AS f_ref, '' AS f_ref_cve, SUM(rcp_ear.amt_r) AS f_amt " +
                                        "FROM hrs_pay AS p " +
                                        "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                        "INNER JOIN hrs_pay_rcp_ear AS rcp_ear ON rcp_ear.id_pay = rcp.id_pay AND rcp_ear.id_emp = rcp.id_emp " +
                                        "INNER JOIN hrs_ear AS ear ON ear.id_ear = rcp_ear.fk_ear " +
                                        "INNER JOIN erp.hrsu_emp AS emp ON emp.id_emp = rcp.id_emp " +
                                        "INNER JOIN erp.bpsu_bp AS bp ON bp.id_bp = emp.id_emp " +
                                        "INNER JOIN erp.hrsu_dep AS d ON d.id_dep = rcp.fk_dep " +
                                        "WHERE p.b_del = 0 AND rcp.b_del = 0 AND rcp_ear.b_del = 0 AND ear.fk_tp_acc_rec = " + SModSysConsts.HRSS_TP_ACC_EMP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " " +
                                        "AND ear.id_ear = " + conceptId + " AND rcp.id_emp IN (" + sEmployees + ") " + ((accountingType == SModSysConsts.HRSS_TP_ACC_EMP) ? ("AND emp.id_emp = " + referenceId + " ") : (accountingType == SModSysConsts.HRSS_TP_ACC_DEP) ? ("AND d.id_dep = " + referenceId + " ") : "") + //AND emp.id_emp IN (" + sEmployees + ") " +
                                        "GROUP BY ear.id_ear, ear.name_abbr, bp.id_bp, bp.bp " +
                                        "ORDER BY f_tp_acc_rec, id_ear, f_ref; ";
                            conceptType = "percepción";
                        }
                        else {
                            /* Deduction:
                             * Accountable link level:
                             * 1. Global
                             * 2. By departatment
                             * 3. By employee
                             */

                            sql = "SELECT ded.fk_tp_acc_rec AS f_tp_acc_rec, ded.id_ded, ded.name_abbr, 0 AS f_id_ref, '' AS f_ref, '' AS f_ref_cve, SUM(rcp_ded.amt_r) AS f_amt " +
                                        "FROM hrs_pay AS p " +
                                        "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                        "INNER JOIN hrs_pay_rcp_ded AS rcp_ded ON rcp_ded.id_pay = rcp.id_pay AND rcp_ded.id_emp = rcp.id_emp " +
                                        "INNER JOIN hrs_ded AS ded ON ded.id_ded = rcp_ded.fk_ded " +
                                        "WHERE p.b_del = 0 AND rcp.b_del = 0 AND rcp_ded.b_del = 0 AND ded.fk_tp_acc_rec = " + SModSysConsts.HRSS_TP_ACC_GBL + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " " +
                                        "AND ded.id_ded = " + conceptId + " AND rcp.id_emp IN (" + sEmployees + ") " +
                                        "GROUP BY ded.id_ded, ded.name_abbr " +

                                        "UNION " +

                                        "SELECT ded.fk_tp_acc_rec AS f_tp_acc_rec, ded.id_ded, ded.name_abbr, d.id_dep AS f_id_ref, d.name AS f_ref, d.code AS f_ref_cve, SUM(rcp_ded.amt_r) AS f_amt " +
                                        "FROM hrs_pay AS p " +
                                        "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                        "INNER JOIN hrs_pay_rcp_ded AS rcp_ded ON rcp_ded.id_pay = rcp.id_pay AND rcp_ded.id_emp = rcp.id_emp " +
                                        "INNER JOIN hrs_ded AS ded ON ded.id_ded = rcp_ded.fk_ded " +
                                        "INNER JOIN erp.hrsu_dep AS d ON d.id_dep = rcp.fk_dep " +
                                        "WHERE p.b_del = 0 AND rcp.b_del = 0 AND rcp_ded.b_del = 0 AND ded.fk_tp_acc_rec = " + SModSysConsts.HRSS_TP_ACC_DEP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " " +
                                        "AND ded.id_ded = " + conceptId + " AND rcp.id_emp IN (" + sEmployees + ")" + (accountingType == SModSysConsts.HRSS_TP_ACC_DEP ? (" AND d.id_dep = " + referenceId + " ") : "") +
                                        "GROUP BY ded.id_ded, ded.name_abbr, d.id_dep, d.name, d.code " +

                                        "UNION " +

                                        "SELECT ded.fk_tp_acc_rec AS f_tp_acc_rec, ded.id_ded, ded.name_abbr, bp.id_bp AS f_id_ref, bp.bp AS f_ref, emp.num AS f_ref_cve, SUM(rcp_ded.amt_r) AS f_amt " +
                                        "FROM hrs_pay AS p " +
                                        "INNER JOIN hrs_pay_rcp AS rcp ON rcp.id_pay = p.id_pay " +
                                        "INNER JOIN hrs_pay_rcp_ded AS rcp_ded ON rcp_ded.id_pay = rcp.id_pay AND rcp_ded.id_emp = rcp.id_emp " +
                                        "INNER JOIN hrs_ded AS ded ON ded.id_ded = rcp_ded.fk_ded " +
                                        "INNER JOIN erp.hrsu_emp AS emp ON emp.id_emp = rcp.id_emp " +
                                        "INNER JOIN erp.bpsu_bp AS bp ON bp.id_bp = emp.id_emp " +
                                        "INNER JOIN erp.hrsu_dep AS d ON d.id_dep = rcp.fk_dep " +
                                        "WHERE p.b_del = 0 AND rcp.b_del = 0 AND rcp_ded.b_del = 0 AND ded.fk_tp_acc_rec = " + SModSysConsts.HRSS_TP_ACC_EMP + " AND p.id_pay = " + moPayroll.getPkPayrollId() + " " +
                                        "AND ded.id_ded = " + conceptId + " AND rcp.id_emp IN (" + sEmployees + ") " + ((accountingType == SModSysConsts.HRSS_TP_ACC_EMP) ? ("AND emp.id_emp = " + referenceId + " ") : (accountingType == SModSysConsts.HRSS_TP_ACC_DEP) ? ("AND d.id_dep = " + referenceId + " ") : "") + //AND emp.id_emp IN (" + sEmployees + ") " +
                                        "GROUP BY ded.id_ded, ded.name_abbr, bp.id_bp, bp.bp " +
                                        "ORDER BY f_tp_acc_rec, id_ded, f_ref; ";
                            conceptType = "deducción";
                        }

                        oResultSetRec = oStatementRec.executeQuery(sql);
                        while (oResultSetRec.next()) {
                            int accountingRecordType = oResultSetRec.getInt("f_tp_acc_rec");
                            referenceId = oResultSetRec.getInt("f_id_ref");
                            reference = oResultSetRec.getString("f_ref");
                            referenceCode = oResultSetRec.getString("f_ref_cve");
                            double amount = oResultSetRec.getDouble("f_amt");
                            double debit = 0;
                            double credit = 0;

                            // Create record entry:
                            
                            String entryConcept = "";

                            switch (accountingRecordType) {
                                case SModSysConsts.HRSS_TP_ACC_GBL: // global link
                                    entryConcept = msPayTypeAbbr + ". " + moFormerPayroll.getNumber() + "; " + conceptAbbr;
                                    break;
                                case SModSysConsts.HRSS_TP_ACC_DEP: // link by department
                                    entryConcept = msPayTypeAbbr + ". " + moFormerPayroll.getNumber() + "; " + conceptAbbr + "; " + referenceCode + ". " + reference;
                                    break;
                                case SModSysConsts.HRSS_TP_ACC_EMP: // link by employee
                                    entryConcept = msPayTypeAbbr + ". " + moFormerPayroll.getNumber() + "; " + conceptAbbr + "; " + referenceCode + ". " + reference;
                                    break;
                                default:
                            }

                            if (nType == 1) {
                                if (amount >= 0d) {
                                    debit = amount;
                                    credit = 0;
                                }
                                else {
                                    debit = 0;
                                    credit = -amount;
                                }
                            }
                            else {
                                if (amount >= 0d) {
                                    debit = 0;
                                    credit = amount;
                                }
                                else {
                                    debit = -amount;
                                    credit = 0;
                                }
                            }

                            totalDebit = SLibUtils.roundAmount(totalDebit + debit);
                            totalCredit = SLibUtils.roundAmount(totalCredit + credit);

                            String accountPk = SFinUtils.getAccountFormerIdXXX(miClient.getSession(), accountId);
                            
                            SDataAccount account = accountsMap.get(accountPk);
                            if (account == null) {
                                account = (SDataAccount) SDataUtilities.readRegistry(miClient, SDataConstants.FIN_ACC, new Object[] { accountPk }, SLibConstants.EXEC_MODE_VERBOSE);
                                accountsMap.put(accountPk, account);
                            }
                            
                            SDataAccount ledgerAccount = account.getDeep() == 1 ? account : ledgerAccountsMap.get(account.getDbmsPkAccountMajorId());
                            if (ledgerAccount == null) {
                                ledgerAccount = (SDataAccount) SDataUtilities.readRegistry(miClient, SDataConstants.FIN_ACC, new Object[] { account.getDbmsPkAccountMajorId() }, SLibConstants.EXEC_MODE_VERBOSE);
                                ledgerAccountsMap.put(account.getDbmsPkAccountMajorId(), ledgerAccount);
                            }
                            
                            String costCenterPk = "";
                                    
                            if (costCenterId != 0) {
                                costCenterPk = costCenterPksMap.get(costCenterId);
                                if (costCenterPk == null) {
                                    costCenterPk = SFinUtils.getCostCenterFormerIdXXX(miClient.getSession(), costCenterId);
                                    costCenterPksMap.put(costCenterId, costCenterPk);
                                }
                            }
        
                            switch (ledgerAccount.getFkAccountSystemTypeId()) {
                                case SDataConstantsSys.FINS_TP_ACC_SYS_SUP:
                                    anSysAccountTypeKey = SModSysConsts.FINS_TP_SYS_ACC_BPR_SUP_BAL;
                                    anSysMoveTypeKey = debit >= 0 ? SModSysConsts.FINS_TP_SYS_MOV_SUP_BAL_DEC_ADJ : SModSysConsts.FINS_TP_SYS_MOV_SUP_BAL_INC_ADJ;
                                    anSysMoveTypeKeyXXX = SDataConstantsSys.FINS_TP_SYS_MOV_BPS_SUP;
                                    break;
                                case SDataConstantsSys.FINS_TP_ACC_SYS_CUS:
                                    anSysAccountTypeKey = SModSysConsts.FINS_TP_SYS_ACC_BPR_CUS_BAL;
                                    anSysMoveTypeKey = debit >= 0 ? SModSysConsts.FINS_TP_SYS_MOV_CUS_BAL_INC_ADJ : SModSysConsts.FINS_TP_SYS_MOV_CUS_BAL_DEC_ADJ;
                                    anSysMoveTypeKeyXXX = SDataConstantsSys.FINS_TP_SYS_MOV_BPS_CUS;
                                    break;
                                case SDataConstantsSys.FINS_TP_ACC_SYS_CDR:
                                    anSysAccountTypeKey = SModSysConsts.FINS_TP_SYS_ACC_BPR_CDR_BAL;
                                    anSysMoveTypeKey = debit >= 0 ? SModSysConsts.FINS_TP_SYS_MOV_CDR_BAL_DEC_ADJ : SModSysConsts.FINS_TP_SYS_MOV_CDR_BAL_INC_ADJ;
                                    anSysMoveTypeKeyXXX = SDataConstantsSys.FINS_TP_SYS_MOV_BPS_CDR;
                                    break;
                                case SDataConstantsSys.FINS_TP_ACC_SYS_DBR:
                                    anSysAccountTypeKey = SModSysConsts.FINS_TP_SYS_ACC_BPR_DBR_BAL;
                                    anSysMoveTypeKey = debit >= 0 ? SModSysConsts.FINS_TP_SYS_MOV_DBR_BAL_INC_ADJ : SModSysConsts.FINS_TP_SYS_MOV_DBR_BAL_DEC_ADJ;
                                    anSysMoveTypeKeyXXX = SDataConstantsSys.FINS_TP_SYS_MOV_BPS_DBR;
                                    break;
                                default:
                                    anSysAccountTypeKey = SModSysConsts.FINS_TP_SYS_ACC_NA_NA;
                                    anSysMoveTypeKey = debit >= 0 ? SModSysConsts.FINS_TP_SYS_MOV_JOU_DBT : SModSysConsts.FINS_TP_SYS_MOV_JOU_CDT;
                                    anSysMoveTypeKeyXXX = SDataConstantsSys.FINS_TP_SYS_MOV_NA;
                            }

                            oRecord.getDbmsRecordEntries().add(createRecordEntry(oRecord.getPrimaryKey(), SLibUtilities.textLeft(entryConcept, 100),
                                    debit, credit, account.getPkAccountIdXXX(), costCenterPk, itemId,
                                    bizPartner == null ? 0 : bizPartner.getPkBizPartnerId(),
                                    bizPartner == null ? 0 : bizPartner.getDbmsBizPartnerBranches().get(0).getPkBizPartnerBranchId(),
                                    new int[] { taxBasicId, taxTaxId }, anSysAccountTypeKey, anSysMoveTypeKey, anSysMoveTypeKeyXXX));

                            // Create payroll move:

                            oPayrollMove = new SDataFormerPayrollMove();
                            oPayrollMove.setPkPayrollId(moPayroll.getPkPayrollId());
                            oPayrollMove.setPkMoveId(++nMoveId);
                            oPayrollMove.setType(nType);
                            oPayrollMove.setTransactionId(conceptId);
                            oPayrollMove.setTransaction(conceptAbbr);
                            oPayrollMove.setReferenceId(referenceId);
                            oPayrollMove.setReference(reference);
                            oPayrollMove.setReferenceKey(referenceCode);
                            oPayrollMove.setAmount(amount);
                            oPayrollMove.setFkYearId(oRecord.getPkYearId());
                            oPayrollMove.setFkPeriodId(oRecord.getPkPeriodId());
                            oPayrollMove.setFkBookkeepingCenterId(oRecord.getPkBookkeepingCenterId());
                            oPayrollMove.setFkRecordTypeId(oRecord.getPkRecordTypeId());
                            oPayrollMove.setFkNumberId(oRecord.getPkNumberId());
                            oPayrollMove.setFkEntryId(++nEntryId);

                            moFormerPayroll.getDbmsDataFormerPayrollMoves().add(oPayrollMove);
                        } // end record
                    } // end configuration
                } // end processing of perceptions and deductions

                moFormerPayroll.getAuxDataRecords().add(oRecord);
            }
        }
        
        if (messages.getMessagesCount() > 0) {
            if (messages.getMessagesCount() == 1) {
                throw new Exception(messages.getMessages()); // throw exception with a simple message
            }
            else {
                messages.setVisible(true);
                throw new Exception("Corregir los problemas de configuración de contabilización de nóminas.");
            }
        }
        
        moFormerPayroll.setDebit_r(totalDebit);
        moFormerPayroll.setCredit_r(totalCredit);

        // Validate that fully accounted payroll
        
        if (SLibUtils.roundAmount(totalDebit - totalCredit) != SLibUtils.roundAmount(moPayroll.getAuxTotalNet())) {
            throw new Exception("¡Hay una diferencia entre el alcance neto de la nómina, $" + SLibUtils.getDecimalFormatAmount().format(moPayroll.getAuxTotalNet()) +", y "
                    + "el monto neto de la afectación contable, $" + SLibUtils.getDecimalFormatAmount().format(totalDebit - totalCredit) +"!");
        }
        
        moAccountingPayroll.save(miClient.getSession());
        
        oRequest = new SServerRequest(SServerConstants.REQ_DB_ACTION_SAVE);
        oRequest.setPacket(moFormerPayroll);
        oResponse = miClient.getSessionXXX().request(oRequest);

        if (oResponse.getResponseType() != SSrvConsts.RESP_TYPE_OK) {
            throw new Exception(oResponse.getMessage());
        }
        else {
            nResult = oResponse.getResultType();
            if (nResult != SLibConstants.DB_ACTION_SAVE_OK) {
                throw new Exception(SLibConstants.MSG_ERR_DB_REG_SAVE + (oResponse.getMessage().length() == 0 ? "" : "\n" + oResponse.getMessage()));
            }
        }

        miClient.getGuiModule(SDataConstants.MOD_FIN).refreshCatalogues(SDataConstants.FIN_REC);
        miClient.getGuiModule(SDataConstants.MOD_HRS).refreshCatalogues(SDataConstants.HRS_SIE_PAY);
        miClient.showMsgBoxInformation("La nómina ha sido contabilizada.");
        ((SClient) miClient).getSession().notifySuscriptors(SModConsts.HRS_SIE_PAY);
    }

    public void actionPickRecord() {
        Object key = null;
        String message = "";

        moDialogRecordPicker.formReset();
        moDialogRecordPicker.setFilterKey(miClient.getSessionXXX().getWorkingDate());
        moDialogRecordPicker.formRefreshOptionPane();

        if (moCurrentRecord != null) {
            moDialogRecordPicker.setSelectedPrimaryKey(moCurrentRecord.getPrimaryKey());
        }

        moDialogRecordPicker.setFormVisible(true);

        if (moDialogRecordPicker.getFormResult() == SLibConstants.FORM_RESULT_OK) {
            key = moDialogRecordPicker.getSelectedPrimaryKey();

            // XXX set registry lock to accounting record

            if (readRecord(key)) {
                if (moCurrentRecord != null) {
                    if (moCurrentRecord.getIsSystem()) {
                        message = "No puede seleccionarse esta póliza contable porque es de sistema.";
                    }
                    else if (moCurrentRecord.getIsAudited()) {
                        message = "No puede seleccionarse esta póliza contable porque está auditada.";
                    }
                    else if (moCurrentRecord.getIsAuthorized()) {
                        message = "No puede seleccionarse esta póliza contable porque está autorizada.";
                    }
                    else if (!SDataUtilities.isPeriodOpen(miClient, moCurrentRecord.getDate())) {
                        message = "No puede seleccionarse esta póliza contable porque su período contable correspondiente está cerrado.";
                    }

                    if (message.length() > 0) {
                        miClient.showMsgBoxWarning(message);
                        moCurrentRecord = null;
                    }
                    else {
                        renderRecord();
                    }
                }
            }
        }
    }
    
    public SDbAccountingPayrollEmployee createAccountingPayrollEmployee(int employeeId) {
        SDbAccountingPayrollEmployee accountingPayrollEmployee = new SDbAccountingPayrollEmployee();
        
        accountingPayrollEmployee.setPkPayrollId(moPayroll.getPkPayrollId());
        //accountingPayrollEmployee.setPkAccountingId(int n);
        accountingPayrollEmployee.setPkEmployeeId(employeeId);
        accountingPayrollEmployee.setFkRecordYearId(moCurrentRecord.getPkYearId());
        accountingPayrollEmployee.setFkRecordPeriodId(moCurrentRecord.getPkPeriodId());
        accountingPayrollEmployee.setFkRecordBookkeepingCenterId(moCurrentRecord.getPkBookkeepingCenterId());
        accountingPayrollEmployee.setFkRecordRecordTypeId(moCurrentRecord.getPkRecordTypeId());
        accountingPayrollEmployee.setFkRecordNumberId(moCurrentRecord.getPkNumberId());
        
        return accountingPayrollEmployee;
    }

    public boolean actionAdd() {
        int index = 0;
        boolean error = true;
        SRowEmployee row = null;

        if (moCurrentRecord == null) {
            miClient.showMsgBoxWarning(SLibConstants.MSG_ERR_GUI_FIELD_EMPTY + "'" + jlRecord.getText() + "'.");
            jbPickRecord.requestFocus();
        }
        else {
            index = moTablePaneEmpAvailable.getTable().getSelectedRow();
            if (index != -1) {
                row = (SRowEmployee) moTablePaneEmpAvailable.getSelectedTableRow();
                row.setData(moCurrentRecord.getPrimaryKey());
                row.getValues().add("" + moCurrentRecord.getPkYearId() + "-" + (moCurrentRecord.getPkPeriodId() >= 10 ? "" : "0") + moCurrentRecord.getPkPeriodId());
                row.getValues().add(jtfRecordBkc.getText());
                row.getValues().add(jtfRecordBranch.getText());
                row.getValues().add(jtfRecordNumber.getText());
                row.getValues().add(moCurrentRecord.getDate());
                
                row.setAccountingPayrollEmployee(createAccountingPayrollEmployee(row.getFkBizPartnerId()));
                
                moTablePaneEmpAvailable.removeTableRow(index);
                moTablePaneEmpAvailable.renderTableRows();
                moTablePaneEmpAvailable.setTableRowSelection(index < moTablePaneEmpAvailable.getTableGuiRowCount() ? index : moTablePaneEmpAvailable.getTableGuiRowCount() - 1);

                moTablePaneEmpSelected.addTableRow(row);
                moTablePaneEmpSelected.renderTableRows();
                moTablePaneEmpSelected.setTableRowSelection(moTablePaneEmpSelected.getTableGuiRowCount() - 1);

                error = false;
            }
        }
        
        computeTotals();

        return !error;
    }

    public void actionAddAll() {
        int rows = moTablePaneEmpAvailable.getTableModel().getRowCount();
        
        if (rows > 0) {
            String bank = "";
            boolean bankSelected = jcbBankFilter.getSelectedIndex() > 0;

            if (bankSelected) {
                bank = jcbBankFilter.getSelectedItem().toString();

                if (bank.equals(SHrsConsts.EMPTY_BANK)) {
                    bank = "";
                }
            }

            int from = 0;
            int employeesAdded = 0;

            for (int row = 0; row < rows; row++) {
                moTablePaneEmpAvailable.setTableRowSelection(from);

                if (bankSelected) {
                    if (!((SRowEmployee) moTablePaneEmpAvailable.getSelectedTableRow()).getBank().equals(bank)) {
                        from++;
                        continue;
                    }
                }

                if (actionAdd()) {
                    employeesAdded++;
                }
                else {
                    break;
                }
            }
            
            if (bankSelected && employeesAdded == 0) {
                miClient.showMsgBoxInformation("Ninguno de los empleados disponibles coincide con el banco: '" + (!bank.isEmpty() ? bank : SHrsConsts.EMPTY_BANK) + "'.");
            }
        }
    }

    public boolean actionRemove() {
        int index = 0;
        boolean error = true;
        SRowEmployee row = null;

        index = moTablePaneEmpSelected.getTable().getSelectedRow();
        if (index != -1) {
            row = (SRowEmployee) moTablePaneEmpSelected.getSelectedTableRow();
            for (int i = 1; i <= 5; i++) { // XXX really bizarre!!!
                row.getValues().remove(8); // XXX really bizarre!!!
            }

            moTablePaneEmpSelected.removeTableRow(index);
            moTablePaneEmpSelected.renderTableRows();
            moTablePaneEmpSelected.setTableRowSelection(index < moTablePaneEmpSelected.getTableGuiRowCount() ? index : moTablePaneEmpSelected.getTableGuiRowCount() - 1);

            moTablePaneEmpAvailable.addTableRow(row);
            moTablePaneEmpAvailable.renderTableRows();
            moTablePaneEmpAvailable.setTableRowSelection(moTablePaneEmpAvailable.getTableGuiRowCount() - 1);

            error = false;
        }
        
        computeTotals();

        return !error;
    }

    public void actionRemoveAll() {
        while (moTablePaneEmpSelected.getTableGuiRowCount() > 0) {
            moTablePaneEmpSelected.setTableRowSelection(0);
            if (!actionRemove()) {
                break;
            }
        }
    }

    public void actionOk() {
        String msg = "";
        Boolean compute = true;

        if (moTablePaneEmpAvailable.getTableGuiRowCount() > 0) {
            miClient.showMsgBoxWarning("Todavía quedan empleados disponibles sin ser seleccionados.");
            moTablePaneEmpAvailable.requestFocus();
        }
        else if (moTablePaneEmpSelected.getTableGuiRowCount() == 0) {
            miClient.showMsgBoxWarning("No hay empleados seleccionados.");
            moTablePaneEmpAvailable.requestFocus();
        }
        else {
            try {
                if (moCurrentRecord.getPkYearId() != moPayroll.getPeriodYear()) {
                    msg = "El año de la nómina es diferente al año de la póliza contable.\n";
                    if (miClient.showMsgBoxConfirm(msg + SGuiConsts.MSG_CNF_CONT) != JOptionPane.YES_OPTION) {
                        compute = false;
                        miClient.showMsgBoxWarning(msg);
                        moTablePaneEmpAvailable.requestFocus();
                    }
                }
                else if (moCurrentRecord.getPkPeriodId() != moPayroll.getPeriod()) {
                        msg = "El periodo de la nómina es diferente al periodo de la póliza contable.\n";
                        if (miClient.showMsgBoxConfirm(msg + SGuiConsts.MSG_CNF_CONT) != JOptionPane.YES_OPTION) {
                            compute = false;
                            miClient.showMsgBoxWarning(msg);
                            moTablePaneEmpAvailable.requestFocus();
                        }
                }
                
                if (compute) {
                    setCursor(new Cursor(Cursor.WAIT_CURSOR));

                    computePayroll();

                    mnFormResult = SLibConstants.FORM_RESULT_OK;
                    setVisible(false);
                }
            }
            catch (Exception e) {
                SLibUtilities.renderException(this, e);
            }
            finally {
                setCursor(new Cursor(Cursor.DEFAULT_CURSOR));
            }
        }
    }

    public void actionCancel() {
        mnFormResult = SLibConstants.FORM_RESULT_CANCEL;
        setVisible(false);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JButton jbAdd;
    private javax.swing.JButton jbAddAll;
    private javax.swing.JButton jbCancel;
    private javax.swing.JButton jbOk;
    private javax.swing.JButton jbPickRecord;
    private javax.swing.JButton jbRemove;
    private javax.swing.JButton jbRemoveAll;
    private javax.swing.JComboBox jcbBankFilter;
    private javax.swing.JLabel jlBankFilter;
    private javax.swing.JLabel jlBankFilterHint;
    private javax.swing.JLabel jlDummy01;
    private javax.swing.JLabel jlDummy3;
    private javax.swing.JLabel jlPayroll;
    private javax.swing.JLabel jlPayrollDates;
    private javax.swing.JLabel jlPayrollNet;
    private javax.swing.JLabel jlPayrollNotes;
    private javax.swing.JLabel jlRecord;
    private javax.swing.JLabel jlTotalAvailables;
    private javax.swing.JLabel jlTotalSelected;
    private javax.swing.JPanel jpAccountingRecord;
    private javax.swing.JPanel jpControls;
    private javax.swing.JPanel jpEmployeesAvailable;
    private javax.swing.JPanel jpEmployeesSelected;
    private javax.swing.JPanel jpGrid;
    private javax.swing.JPanel jpPaymentType;
    private javax.swing.JTextField jtfPayrollDates;
    private javax.swing.JTextField jtfPayrollNet;
    private javax.swing.JTextField jtfPayrollNetCur;
    private javax.swing.JTextField jtfPayrollNotes;
    private javax.swing.JTextField jtfPayrollNumber;
    private javax.swing.JTextField jtfPayrollPeriod;
    private javax.swing.JTextField jtfRecordBkc;
    private javax.swing.JTextField jtfRecordBranch;
    private javax.swing.JTextField jtfRecordDate;
    private javax.swing.JTextField jtfRecordNumber;
    // End of variables declaration//GEN-END:variables

    public void resetForm() {
        mnFormResult = SLibConstants.UNDEFINED;
        mbFirstTime = true;

        jtfPayrollPeriod.setText("");
        jtfPayrollNumber.setText("");
        jtfPayrollDates.setText("");
        jtfPayrollNet.setText("");
        jtfPayrollNetCur.setText(miClient.getSessionXXX().getParamsErp().getDbmsDataCurrency().getKey());
        jtfPayrollNotes.setText("");

        jtfRecordDate.setText("");
        jtfRecordBkc.setText("");
        jtfRecordBranch.setText("");
        jtfRecordNumber.setText("");

        moCurrentRecord = null;
        moTablePaneEmpAvailable.createTable();
        moTablePaneEmpAvailable.clearTableRows();
        moTablePaneEmpSelected.createTable();
        moTablePaneEmpSelected.clearTableRows();
    }

    public int getFormResult() {
        return mnFormResult;
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof JButton) {
            JButton button = (JButton) e.getSource();

            if (button == jbPickRecord) {
                actionPickRecord();
            }
            else if (button == jbAdd) {
                actionAdd();
            }
            else if (button == jbAddAll) {
                actionAddAll();
            }
            else if (button == jbRemove) {
                actionRemove();
            }
            else if (button == jbRemoveAll) {
                actionRemoveAll();
            }
        }
    }
}
