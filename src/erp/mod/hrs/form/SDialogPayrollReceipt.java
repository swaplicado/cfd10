/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package erp.mod.hrs.form;

import erp.mod.SModConsts;
import erp.mod.SModSysConsts;
import erp.mod.hrs.db.SDbAbsence;
import erp.mod.hrs.db.SDbAbsenceConsumption;
import erp.mod.hrs.db.SDbBenefitTable;
import erp.mod.hrs.db.SDbDeduction;
import erp.mod.hrs.db.SDbEarning;
import erp.mod.hrs.db.SDbEmployee;
import erp.mod.hrs.db.SDbLoan;
import erp.mod.hrs.db.SDbPayrollReceiptDeduction;
import erp.mod.hrs.db.SDbPayrollReceiptEarning;
import erp.mod.hrs.db.SHrsBenefit;
import erp.mod.hrs.db.SHrsBenefitParams;
import erp.mod.hrs.db.SHrsEmployeeDays;
import erp.mod.hrs.db.SHrsReceipt;
import erp.mod.hrs.db.SHrsReceiptDeduction;
import erp.mod.hrs.db.SHrsReceiptEarning;
import erp.mod.hrs.db.SHrsUtils;
import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Vector;
import javax.swing.JButton;
import javax.swing.JOptionPane;
import javax.swing.event.CellEditorListener;
import javax.swing.event.ChangeEvent;
import sa.lib.SLibConsts;
import sa.lib.SLibTimeUtils;
import sa.lib.SLibUtils;
import sa.lib.db.SDbConsts;
import sa.lib.db.SDbRegistry;
import sa.lib.grid.SGridColumnForm;
import sa.lib.grid.SGridConsts;
import sa.lib.grid.SGridPaneForm;
import sa.lib.grid.SGridPaneFormOwner;
import sa.lib.grid.SGridRow;
import sa.lib.gui.SGuiClient;
import sa.lib.gui.SGuiConsts;
import sa.lib.gui.SGuiParams;
import sa.lib.gui.SGuiUtils;
import sa.lib.gui.SGuiValidation;
import sa.lib.gui.bean.SBeanFieldKey;
import sa.lib.gui.bean.SBeanFieldText;
import sa.lib.gui.bean.SBeanFormDialog;

/**
 *
 * @author Juan Barajas, Sergio Flores
 */
public class SDialogPayrollReceipt extends SBeanFormDialog implements SGridPaneFormOwner, ActionListener, ItemListener, FocusListener, CellEditorListener {

    private static final int COL_VAL = 2;
    private static final int COL_AMT_UNT = 4;
    
    public static final String LABEL_AUX_AMT = "Monto auxiliar";
    public static final String LABEL_AUX_VAL = "Valor auxiliar";

    protected SHrsReceipt moHrsReceipt;
    protected SHrsBenefit moHrsBenefit;
    /** Key: ID of earning. */
    protected HashMap<Integer, SDbEarning> moEarnigsMap;
    /** Key: ID of deduction. */
    protected HashMap<Integer, SDbDeduction> moDeductionsMap;
    protected SDbEarning moEarning;
    protected SDbDeduction moDeduction;
    protected String msOriginalEarningCode;
    protected String msOriginalDeductionCode;
    protected SGridPaneForm moGridReceiptEarnings;
    protected SGridPaneForm moGridReceiptDeductions;
    protected SGridPaneForm moGridAbsenceConsumptions;
    protected boolean mbEditable;

    /**
     * Creates new form SDialogPayrollReceipt
     * @param client
     * @param title
     */
    public SDialogPayrollReceipt(SGuiClient client, String title) {
        setFormSettings(client, SGuiConsts.BEAN_FORM_EDIT, SModConsts.HRS_PAY_RCP, SLibConsts.UNDEFINED, title);
        initComponents();
        initComponentsCustom();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jPanel12 = new javax.swing.JPanel();
        jPanel15 = new javax.swing.JPanel();
        jPanel16 = new javax.swing.JPanel();
        jlName = new javax.swing.JLabel();
        moTextName = new sa.lib.gui.bean.SBeanFieldText();
        moTextNumber = new sa.lib.gui.bean.SBeanFieldText();
        jPanel17 = new javax.swing.JPanel();
        jlPaymentType = new javax.swing.JLabel();
        moTextPaymentType = new sa.lib.gui.bean.SBeanFieldText();
        jlDateBirth = new javax.swing.JLabel();
        moTextDateBirth = new sa.lib.gui.bean.SBeanFieldText();
        jlDepartament = new javax.swing.JLabel();
        moTextDepartament = new sa.lib.gui.bean.SBeanFieldText();
        jlSalaryType = new javax.swing.JLabel();
        moTextSalaryType = new sa.lib.gui.bean.SBeanFieldText();
        jlFiscalId = new javax.swing.JLabel();
        moTextFiscalId = new sa.lib.gui.bean.SBeanFieldText();
        jPanel29 = new javax.swing.JPanel();
        jlSalary = new javax.swing.JLabel();
        moDecSalary = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlDateBenefits = new javax.swing.JLabel();
        moTextDateBenefits = new sa.lib.gui.bean.SBeanFieldText();
        jlPosition = new javax.swing.JLabel();
        moTextPosition = new sa.lib.gui.bean.SBeanFieldText();
        jlEmployeeType = new javax.swing.JLabel();
        moTextEmployeeType = new sa.lib.gui.bean.SBeanFieldText();
        jlAlternativeId = new javax.swing.JLabel();
        moTextAlternativeId = new sa.lib.gui.bean.SBeanFieldText();
        jPanel18 = new javax.swing.JPanel();
        jlWage = new javax.swing.JLabel();
        moDecWage = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlDateLastHire = new javax.swing.JLabel();
        moTextDateLastHire = new sa.lib.gui.bean.SBeanFieldText();
        jlShift = new javax.swing.JLabel();
        moTextShift = new sa.lib.gui.bean.SBeanFieldText();
        jlWorkerType = new javax.swing.JLabel();
        moTextWorkerType = new sa.lib.gui.bean.SBeanFieldText();
        jlSocialSecurityNumber = new javax.swing.JLabel();
        moTextSocialSecurityNumber = new sa.lib.gui.bean.SBeanFieldText();
        jPanel19 = new javax.swing.JPanel();
        jlSalarySscBase = new javax.swing.JLabel();
        moDecSalarySscBase = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlDateLastDismissal_n = new javax.swing.JLabel();
        moTextDateLastDismissal_n = new sa.lib.gui.bean.SBeanFieldText();
        jlWorkingHoursDay = new javax.swing.JLabel();
        moIntWorkingHoursDay = new sa.lib.gui.bean.SBeanFieldInteger();
        jLabel1 = new javax.swing.JLabel();
        jlRecruitmentSchemeType = new javax.swing.JLabel();
        moTextRecruitmentSchemeType = new sa.lib.gui.bean.SBeanFieldText();
        jPanel14 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jpEarnings = new javax.swing.JPanel();
        jPanel6 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        moTextEarningCode = new sa.lib.gui.bean.SBeanFieldText();
        jbPickEarning = new javax.swing.JButton();
        moTextEarningName = new sa.lib.gui.bean.SBeanFieldText();
        moKeyEarningOtherPaymentType = new sa.lib.gui.bean.SBeanFieldKey();
        jPanel2 = new javax.swing.JPanel();
        jlEarningLoan_n = new javax.swing.JLabel();
        moKeyEarningLoan_n = new sa.lib.gui.bean.SBeanFieldKey();
        jPanel25 = new javax.swing.JPanel();
        jlEarningValue = new javax.swing.JLabel();
        moCompEarningValue = new sa.lib.gui.bean.SBeanCompoundField();
        jlEarningAuxAmount1 = new javax.swing.JLabel();
        moCurEarningAuxAmount1 = new sa.lib.gui.bean.SBeanCompoundFieldCurrency();
        jlEarningAuxAmount1Hint = new javax.swing.JLabel();
        jPanel10 = new javax.swing.JPanel();
        jbAddEarning = new javax.swing.JButton();
        jPanel27 = new javax.swing.JPanel();
        jlEarningAuxValue = new javax.swing.JLabel();
        moCompEarningAuxValue = new sa.lib.gui.bean.SBeanCompoundField();
        jlEarningAuxAmount2 = new javax.swing.JLabel();
        moCurEarningAuxAmount2 = new sa.lib.gui.bean.SBeanCompoundFieldCurrency();
        jlEarningAuxAmount2Hint = new javax.swing.JLabel();
        jpDeductions = new javax.swing.JPanel();
        jPanel7 = new javax.swing.JPanel();
        jPanel9 = new javax.swing.JPanel();
        moTextDeductionCode = new sa.lib.gui.bean.SBeanFieldText();
        jbPickDeduction = new javax.swing.JButton();
        moTextDeductionName = new sa.lib.gui.bean.SBeanFieldText();
        jPanel3 = new javax.swing.JPanel();
        jlDeductionLoan_n = new javax.swing.JLabel();
        moKeyDeductionLoan_n = new sa.lib.gui.bean.SBeanFieldKey();
        jPanel26 = new javax.swing.JPanel();
        jlDeductionValue = new javax.swing.JLabel();
        moCompDeductionValue = new sa.lib.gui.bean.SBeanCompoundField();
        jPanel11 = new javax.swing.JPanel();
        jbAddDeduction = new javax.swing.JButton();
        jPanel21 = new javax.swing.JPanel();
        jPanel20 = new javax.swing.JPanel();
        jpAbsenceConsumption = new javax.swing.JPanel();
        jPanel13 = new javax.swing.JPanel();
        jPanel22 = new javax.swing.JPanel();
        jPanel5 = new javax.swing.JPanel();
        jlEarningsTotal = new javax.swing.JLabel();
        moCurEarningsTotal = new sa.lib.gui.bean.SBeanCompoundFieldCurrency();
        jPanel23 = new javax.swing.JPanel();
        jlDeductionsTotal = new javax.swing.JLabel();
        moCurDeductionsTotal = new sa.lib.gui.bean.SBeanCompoundFieldCurrency();
        jPanel24 = new javax.swing.JPanel();
        jlNetTotal = new javax.swing.JLabel();
        moCurNetTotal = new sa.lib.gui.bean.SBeanCompoundFieldCurrency();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Recibo de n√≥mina");

        jPanel1.setLayout(new java.awt.BorderLayout());

        jPanel12.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos del empleado:"));
        jPanel12.setLayout(new java.awt.BorderLayout());

        jPanel15.setLayout(new java.awt.GridLayout(5, 1, 0, 5));

        jPanel16.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlName.setText("Nombre:");
        jlName.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel16.add(jlName);

        moTextName.setEditable(false);
        moTextName.setText("TEXT");
        moTextName.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        moTextName.setPreferredSize(new java.awt.Dimension(350, 23));
        jPanel16.add(moTextName);

        moTextNumber.setEditable(false);
        moTextNumber.setText("TEXT");
        moTextNumber.setToolTipText("Clave");
        moTextNumber.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        moTextNumber.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel16.add(moTextNumber);

        jPanel15.add(jPanel16);

        jPanel17.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlPaymentType.setText("Per√≠odo pago:");
        jlPaymentType.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel17.add(jlPaymentType);

        moTextPaymentType.setEditable(false);
        moTextPaymentType.setText("TEXT");
        moTextPaymentType.setPreferredSize(new java.awt.Dimension(85, 23));
        jPanel17.add(moTextPaymentType);

        jlDateBirth.setText("Nacimiento:");
        jlDateBirth.setPreferredSize(new java.awt.Dimension(95, 23));
        jPanel17.add(jlDateBirth);

        moTextDateBirth.setEditable(false);
        moTextDateBirth.setText("TEXT");
        moTextDateBirth.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel17.add(moTextDateBirth);

        jlDepartament.setText("Departamento:");
        jlDepartament.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel17.add(jlDepartament);

        moTextDepartament.setEditable(false);
        moTextDepartament.setText("TEXT");
        moTextDepartament.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel17.add(moTextDepartament);

        jlSalaryType.setText("Tipo salario:");
        jlSalaryType.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel17.add(jlSalaryType);

        moTextSalaryType.setEditable(false);
        moTextSalaryType.setText("TEXT");
        jPanel17.add(moTextSalaryType);

        jlFiscalId.setText("RFC:");
        jlFiscalId.setPreferredSize(new java.awt.Dimension(40, 23));
        jPanel17.add(jlFiscalId);

        moTextFiscalId.setEditable(false);
        moTextFiscalId.setText("XAXX010101000");
        moTextFiscalId.setPreferredSize(new java.awt.Dimension(105, 23));
        jPanel17.add(moTextFiscalId);

        jPanel15.add(jPanel17);

        jPanel29.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlSalary.setText("Salario diario:");
        jlSalary.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel29.add(jlSalary);

        moDecSalary.setEditable(false);
        moDecSalary.setPreferredSize(new java.awt.Dimension(85, 23));
        jPanel29.add(moDecSalary);

        jlDateBenefits.setText("Inicio beneficios:");
        jlDateBenefits.setPreferredSize(new java.awt.Dimension(95, 23));
        jPanel29.add(jlDateBenefits);

        moTextDateBenefits.setEditable(false);
        moTextDateBenefits.setText("TEXT");
        moTextDateBenefits.setToolTipText("");
        moTextDateBenefits.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel29.add(moTextDateBenefits);

        jlPosition.setText("Puesto:");
        jlPosition.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel29.add(jlPosition);

        moTextPosition.setEditable(false);
        moTextPosition.setText("TEXT");
        moTextPosition.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel29.add(moTextPosition);

        jlEmployeeType.setText("Tipo empleado:");
        jlEmployeeType.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel29.add(jlEmployeeType);

        moTextEmployeeType.setEditable(false);
        moTextEmployeeType.setText("TEXT");
        jPanel29.add(moTextEmployeeType);

        jlAlternativeId.setText("CURP:");
        jlAlternativeId.setPreferredSize(new java.awt.Dimension(40, 23));
        jPanel29.add(jlAlternativeId);

        moTextAlternativeId.setEditable(false);
        moTextAlternativeId.setText("XAXX010101XXXXXX00");
        moTextAlternativeId.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel29.add(moTextAlternativeId);

        jPanel15.add(jPanel29);

        jPanel18.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlWage.setText("Sueldo mensual:");
        jlWage.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel18.add(jlWage);

        moDecWage.setEditable(false);
        moDecWage.setText("0");
        moDecWage.setPreferredSize(new java.awt.Dimension(85, 23));
        jPanel18.add(moDecWage);

        jlDateLastHire.setText("√öltima alta:");
        jlDateLastHire.setPreferredSize(new java.awt.Dimension(95, 23));
        jPanel18.add(jlDateLastHire);

        moTextDateLastHire.setEditable(false);
        moTextDateLastHire.setText("TEXT");
        moTextDateLastHire.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel18.add(moTextDateLastHire);

        jlShift.setText("Turno:");
        jlShift.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel18.add(jlShift);

        moTextShift.setEditable(false);
        moTextShift.setText("TEXT");
        moTextShift.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel18.add(moTextShift);

        jlWorkerType.setText("Tipo obrero:");
        jlWorkerType.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel18.add(jlWorkerType);

        moTextWorkerType.setEditable(false);
        moTextWorkerType.setText("TEXT");
        jPanel18.add(moTextWorkerType);

        jlSocialSecurityNumber.setText("NSS:");
        jlSocialSecurityNumber.setPreferredSize(new java.awt.Dimension(40, 23));
        jPanel18.add(jlSocialSecurityNumber);

        moTextSocialSecurityNumber.setEditable(false);
        moTextSocialSecurityNumber.setText("00000000000");
        moTextSocialSecurityNumber.setPreferredSize(new java.awt.Dimension(85, 23));
        jPanel18.add(moTextSocialSecurityNumber);

        jPanel15.add(jPanel18);

        jPanel19.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlSalarySscBase.setText("SBC:");
        jlSalarySscBase.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel19.add(jlSalarySscBase);

        moDecSalarySscBase.setEditable(false);
        moDecSalarySscBase.setPreferredSize(new java.awt.Dimension(85, 23));
        jPanel19.add(moDecSalarySscBase);

        jlDateLastDismissal_n.setText("√öltima baja:");
        jlDateLastDismissal_n.setPreferredSize(new java.awt.Dimension(95, 23));
        jPanel19.add(jlDateLastDismissal_n);

        moTextDateLastDismissal_n.setEditable(false);
        moTextDateLastDismissal_n.setText("TEXT");
        moTextDateLastDismissal_n.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel19.add(moTextDateLastDismissal_n);

        jlWorkingHoursDay.setText("Horas jornada:");
        jlWorkingHoursDay.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel19.add(jlWorkingHoursDay);

        moIntWorkingHoursDay.setEditable(false);
        moIntWorkingHoursDay.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel19.add(moIntWorkingHoursDay);

        jLabel1.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel19.add(jLabel1);

        jlRecruitmentSchemeType.setText("R√©gimen:");
        jlRecruitmentSchemeType.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel19.add(jlRecruitmentSchemeType);

        moTextRecruitmentSchemeType.setEditable(false);
        moTextRecruitmentSchemeType.setText("TEXT");
        moTextRecruitmentSchemeType.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel19.add(moTextRecruitmentSchemeType);

        jPanel15.add(jPanel19);

        jPanel12.add(jPanel15, java.awt.BorderLayout.CENTER);

        jPanel1.add(jPanel12, java.awt.BorderLayout.NORTH);

        jPanel14.setLayout(new java.awt.BorderLayout());

        jPanel4.setPreferredSize(new java.awt.Dimension(100, 300));
        jPanel4.setLayout(new java.awt.BorderLayout());

        jpEarnings.setBorder(javax.swing.BorderFactory.createTitledBorder("Percepciones:"));
        jpEarnings.setLayout(new java.awt.BorderLayout());

        jPanel6.setLayout(new java.awt.GridLayout(4, 1, 0, 5));

        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        moTextEarningCode.setText("TEXT");
        moTextEarningCode.setToolTipText("C√≥digo percepci√≥n");
        moTextEarningCode.setPreferredSize(new java.awt.Dimension(72, 23));
        jPanel8.add(moTextEarningCode);

        jbPickEarning.setText("...");
        jbPickEarning.setToolTipText("Seleccionar percepci√≥n");
        jbPickEarning.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel8.add(jbPickEarning);

        moTextEarningName.setEditable(false);
        moTextEarningName.setText("TEXT");
        moTextEarningName.setToolTipText("Nombre percepci√≥n");
        moTextEarningName.setPreferredSize(new java.awt.Dimension(225, 23));
        jPanel8.add(moTextEarningName);

        moKeyEarningOtherPaymentType.setToolTipText("Tipo otro pago");
        moKeyEarningOtherPaymentType.setPreferredSize(new java.awt.Dimension(225, 23));
        jPanel8.add(moKeyEarningOtherPaymentType);

        jPanel6.add(jPanel8);

        jPanel2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlEarningLoan_n.setText("Cr√©dito/pr√©stamo:*");
        jlEarningLoan_n.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel2.add(jlEarningLoan_n);

        moKeyEarningLoan_n.setPreferredSize(new java.awt.Dimension(325, 23));
        jPanel2.add(moKeyEarningLoan_n);

        jPanel6.add(jPanel2);

        jPanel25.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlEarningValue.setText("Cantidad/monto:");
        jlEarningValue.setToolTipText("");
        jlEarningValue.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel25.add(jlEarningValue);

        moCompEarningValue.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel25.add(moCompEarningValue);

        jlEarningAuxAmount1.setText("Monto auxiliar:");
        jlEarningAuxAmount1.setToolTipText("");
        jlEarningAuxAmount1.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel25.add(jlEarningAuxAmount1);

        moCurEarningAuxAmount1.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel25.add(moCurEarningAuxAmount1);

        jlEarningAuxAmount1Hint.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlEarningAuxAmount1Hint.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_view_help.png"))); // NOI18N
        jlEarningAuxAmount1Hint.setToolTipText("Monto auxiliar");
        jlEarningAuxAmount1Hint.setPreferredSize(new java.awt.Dimension(15, 23));
        jPanel25.add(jlEarningAuxAmount1Hint);

        jPanel6.add(jPanel25);

        jPanel10.setLayout(new java.awt.BorderLayout());

        jbAddEarning.setText("Agregar");
        jbAddEarning.setMargin(new java.awt.Insets(2, 0, 2, 0));
        jbAddEarning.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel10.add(jbAddEarning, java.awt.BorderLayout.EAST);

        jPanel27.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlEarningAuxValue.setText("Valor auxiliar:");
        jlEarningAuxValue.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel27.add(jlEarningAuxValue);

        moCompEarningAuxValue.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel27.add(moCompEarningAuxValue);

        jlEarningAuxAmount2.setText("Monto auxiliar:");
        jlEarningAuxAmount2.setToolTipText("");
        jlEarningAuxAmount2.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel27.add(jlEarningAuxAmount2);

        moCurEarningAuxAmount2.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel27.add(moCurEarningAuxAmount2);

        jlEarningAuxAmount2Hint.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlEarningAuxAmount2Hint.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/icon_view_help.png"))); // NOI18N
        jlEarningAuxAmount2Hint.setToolTipText("Monto auxiliar");
        jlEarningAuxAmount2Hint.setPreferredSize(new java.awt.Dimension(15, 23));
        jPanel27.add(jlEarningAuxAmount2Hint);

        jPanel10.add(jPanel27, java.awt.BorderLayout.CENTER);

        jPanel6.add(jPanel10);

        jpEarnings.add(jPanel6, java.awt.BorderLayout.NORTH);

        jPanel4.add(jpEarnings, java.awt.BorderLayout.CENTER);

        jpDeductions.setBorder(javax.swing.BorderFactory.createTitledBorder("Deducciones:"));
        jpDeductions.setPreferredSize(new java.awt.Dimension(455, 1));
        jpDeductions.setLayout(new java.awt.BorderLayout());

        jPanel7.setLayout(new java.awt.GridLayout(4, 1, 0, 5));

        jPanel9.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        moTextDeductionCode.setText("TEXT");
        moTextDeductionCode.setToolTipText("C√≥digo deducci√≥n");
        moTextDeductionCode.setPreferredSize(new java.awt.Dimension(72, 23));
        jPanel9.add(moTextDeductionCode);

        jbPickDeduction.setText("...");
        jbPickDeduction.setToolTipText("Seleccionar deducci√≥n");
        jbPickDeduction.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel9.add(jbPickDeduction);

        moTextDeductionName.setEditable(false);
        moTextDeductionName.setText("TEXT");
        moTextDeductionName.setToolTipText("Nombre deducci√≥n");
        moTextDeductionName.setPreferredSize(new java.awt.Dimension(225, 23));
        jPanel9.add(moTextDeductionName);

        jPanel7.add(jPanel9);

        jPanel3.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlDeductionLoan_n.setText("Cr√©dito/pr√©stamo:*");
        jlDeductionLoan_n.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel3.add(jlDeductionLoan_n);

        moKeyDeductionLoan_n.setPreferredSize(new java.awt.Dimension(325, 23));
        jPanel3.add(moKeyDeductionLoan_n);

        jPanel7.add(jPanel3);

        jPanel26.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEADING, 5, 0));

        jlDeductionValue.setText("Cantidad/monto:");
        jlDeductionValue.setToolTipText("");
        jlDeductionValue.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel26.add(jlDeductionValue);

        moCompDeductionValue.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel26.add(moCompDeductionValue);

        jPanel7.add(jPanel26);

        jPanel11.setLayout(new java.awt.BorderLayout());

        jbAddDeduction.setText("Agregar");
        jbAddDeduction.setMargin(new java.awt.Insets(2, 0, 2, 0));
        jbAddDeduction.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel11.add(jbAddDeduction, java.awt.BorderLayout.EAST);

        jPanel21.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));
        jPanel11.add(jPanel21, java.awt.BorderLayout.CENTER);

        jPanel7.add(jPanel11);

        jpDeductions.add(jPanel7, java.awt.BorderLayout.NORTH);

        jPanel4.add(jpDeductions, java.awt.BorderLayout.EAST);

        jPanel14.add(jPanel4, java.awt.BorderLayout.NORTH);

        jPanel20.setLayout(new java.awt.BorderLayout());

        jpAbsenceConsumption.setBorder(javax.swing.BorderFactory.createTitledBorder("Consumo incidencias:"));
        jpAbsenceConsumption.setLayout(new java.awt.BorderLayout());
        jPanel20.add(jpAbsenceConsumption, java.awt.BorderLayout.CENTER);

        jPanel13.setBorder(javax.swing.BorderFactory.createTitledBorder("Totales:"));
        jPanel13.setLayout(new java.awt.BorderLayout());

        jPanel22.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.TRAILING, 5, 0));

        jlEarningsTotal.setText("Total percepciones:");
        jlEarningsTotal.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel5.add(jlEarningsTotal);

        moCurEarningsTotal.setEditable(false);
        jPanel5.add(moCurEarningsTotal);

        jPanel22.add(jPanel5);

        jPanel23.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.TRAILING, 5, 0));

        jlDeductionsTotal.setText("Total deducciones:");
        jlDeductionsTotal.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel23.add(jlDeductionsTotal);

        moCurDeductionsTotal.setEditable(false);
        jPanel23.add(moCurDeductionsTotal);

        jPanel22.add(jPanel23);

        jPanel24.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.TRAILING, 5, 0));

        jlNetTotal.setText("Total neto:");
        jlNetTotal.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel24.add(jlNetTotal);

        moCurNetTotal.setEditable(false);
        jPanel24.add(moCurNetTotal);

        jPanel22.add(jPanel24);

        jPanel13.add(jPanel22, java.awt.BorderLayout.SOUTH);

        jPanel20.add(jPanel13, java.awt.BorderLayout.EAST);

        jPanel14.add(jPanel20, java.awt.BorderLayout.CENTER);

        jPanel1.add(jPanel14, java.awt.BorderLayout.CENTER);

        getContentPane().add(jPanel1, java.awt.BorderLayout.CENTER);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel12;
    private javax.swing.JPanel jPanel13;
    private javax.swing.JPanel jPanel14;
    private javax.swing.JPanel jPanel15;
    private javax.swing.JPanel jPanel16;
    private javax.swing.JPanel jPanel17;
    private javax.swing.JPanel jPanel18;
    private javax.swing.JPanel jPanel19;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel20;
    private javax.swing.JPanel jPanel21;
    private javax.swing.JPanel jPanel22;
    private javax.swing.JPanel jPanel23;
    private javax.swing.JPanel jPanel24;
    private javax.swing.JPanel jPanel25;
    private javax.swing.JPanel jPanel26;
    private javax.swing.JPanel jPanel27;
    private javax.swing.JPanel jPanel29;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JButton jbAddDeduction;
    private javax.swing.JButton jbAddEarning;
    private javax.swing.JButton jbPickDeduction;
    private javax.swing.JButton jbPickEarning;
    private javax.swing.JLabel jlAlternativeId;
    private javax.swing.JLabel jlDateBenefits;
    private javax.swing.JLabel jlDateBirth;
    private javax.swing.JLabel jlDateLastDismissal_n;
    private javax.swing.JLabel jlDateLastHire;
    private javax.swing.JLabel jlDeductionLoan_n;
    private javax.swing.JLabel jlDeductionValue;
    private javax.swing.JLabel jlDeductionsTotal;
    private javax.swing.JLabel jlDepartament;
    private javax.swing.JLabel jlEarningAuxAmount1;
    private javax.swing.JLabel jlEarningAuxAmount1Hint;
    private javax.swing.JLabel jlEarningAuxAmount2;
    private javax.swing.JLabel jlEarningAuxAmount2Hint;
    private javax.swing.JLabel jlEarningAuxValue;
    private javax.swing.JLabel jlEarningLoan_n;
    private javax.swing.JLabel jlEarningValue;
    private javax.swing.JLabel jlEarningsTotal;
    private javax.swing.JLabel jlEmployeeType;
    private javax.swing.JLabel jlFiscalId;
    private javax.swing.JLabel jlName;
    private javax.swing.JLabel jlNetTotal;
    private javax.swing.JLabel jlPaymentType;
    private javax.swing.JLabel jlPosition;
    private javax.swing.JLabel jlRecruitmentSchemeType;
    private javax.swing.JLabel jlSalary;
    private javax.swing.JLabel jlSalarySscBase;
    private javax.swing.JLabel jlSalaryType;
    private javax.swing.JLabel jlShift;
    private javax.swing.JLabel jlSocialSecurityNumber;
    private javax.swing.JLabel jlWage;
    private javax.swing.JLabel jlWorkerType;
    private javax.swing.JLabel jlWorkingHoursDay;
    private javax.swing.JPanel jpAbsenceConsumption;
    private javax.swing.JPanel jpDeductions;
    private javax.swing.JPanel jpEarnings;
    private sa.lib.gui.bean.SBeanCompoundField moCompDeductionValue;
    private sa.lib.gui.bean.SBeanCompoundField moCompEarningAuxValue;
    private sa.lib.gui.bean.SBeanCompoundField moCompEarningValue;
    private sa.lib.gui.bean.SBeanCompoundFieldCurrency moCurDeductionsTotal;
    private sa.lib.gui.bean.SBeanCompoundFieldCurrency moCurEarningAuxAmount1;
    private sa.lib.gui.bean.SBeanCompoundFieldCurrency moCurEarningAuxAmount2;
    private sa.lib.gui.bean.SBeanCompoundFieldCurrency moCurEarningsTotal;
    private sa.lib.gui.bean.SBeanCompoundFieldCurrency moCurNetTotal;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecSalary;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecSalarySscBase;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecWage;
    private sa.lib.gui.bean.SBeanFieldInteger moIntWorkingHoursDay;
    private sa.lib.gui.bean.SBeanFieldKey moKeyDeductionLoan_n;
    private sa.lib.gui.bean.SBeanFieldKey moKeyEarningLoan_n;
    private sa.lib.gui.bean.SBeanFieldKey moKeyEarningOtherPaymentType;
    private sa.lib.gui.bean.SBeanFieldText moTextAlternativeId;
    private sa.lib.gui.bean.SBeanFieldText moTextDateBenefits;
    private sa.lib.gui.bean.SBeanFieldText moTextDateBirth;
    private sa.lib.gui.bean.SBeanFieldText moTextDateLastDismissal_n;
    private sa.lib.gui.bean.SBeanFieldText moTextDateLastHire;
    private sa.lib.gui.bean.SBeanFieldText moTextDeductionCode;
    private sa.lib.gui.bean.SBeanFieldText moTextDeductionName;
    private sa.lib.gui.bean.SBeanFieldText moTextDepartament;
    private sa.lib.gui.bean.SBeanFieldText moTextEarningCode;
    private sa.lib.gui.bean.SBeanFieldText moTextEarningName;
    private sa.lib.gui.bean.SBeanFieldText moTextEmployeeType;
    private sa.lib.gui.bean.SBeanFieldText moTextFiscalId;
    private sa.lib.gui.bean.SBeanFieldText moTextName;
    private sa.lib.gui.bean.SBeanFieldText moTextNumber;
    private sa.lib.gui.bean.SBeanFieldText moTextPaymentType;
    private sa.lib.gui.bean.SBeanFieldText moTextPosition;
    private sa.lib.gui.bean.SBeanFieldText moTextRecruitmentSchemeType;
    private sa.lib.gui.bean.SBeanFieldText moTextSalaryType;
    private sa.lib.gui.bean.SBeanFieldText moTextShift;
    private sa.lib.gui.bean.SBeanFieldText moTextSocialSecurityNumber;
    private sa.lib.gui.bean.SBeanFieldText moTextWorkerType;
    // End of variables declaration//GEN-END:variables

    private void initComponentsCustom() {
        SGuiUtils.setWindowBounds(this, 1040, 650);

        jbSave.setText("Aceptar");

        moTextName.setTextSettings(SGuiUtils.getLabelName(jlName), 202);
        moTextNumber.setTextSettings(SGuiUtils.getLabelName(jlName), 10);
        moTextPaymentType.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moDecSalary.setDecimalSettings(SGuiUtils.getLabelName(jlSalary), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moDecWage.setDecimalSettings(SGuiUtils.getLabelName(jlWage), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moDecSalarySscBase.setDecimalSettings(SGuiUtils.getLabelName(jlSalarySscBase), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moTextDateBirth.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moTextDateBenefits.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moTextDateLastHire.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moTextDateLastDismissal_n.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moTextDepartament.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moTextPosition.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moTextShift.setTextSettings(SGuiUtils.getLabelName(jlName), 50);
        moIntWorkingHoursDay.setIntegerSettings(SGuiUtils.getLabelName(jlName), SGuiConsts.GUI_TYPE_INT, false);
        moTextSalaryType.setTextSettings(SGuiUtils.getLabelName(jlName), 100);
        moTextEmployeeType.setTextSettings(SGuiUtils.getLabelName(jlName), 100);
        moTextWorkerType.setTextSettings(SGuiUtils.getLabelName(jlName), 100);
        moTextRecruitmentSchemeType.setTextSettings(SGuiUtils.getLabelName(jlName), 100);
        moTextFiscalId.setTextSettings(SGuiUtils.getLabelName(jlName), 25);
        moTextAlternativeId.setTextSettings(SGuiUtils.getLabelName(jlName), 25);
        moTextSocialSecurityNumber.setTextSettings(SGuiUtils.getLabelName(jlName), 25);

        moTextEarningCode.setTextSettings(SGuiUtils.getLabelName(moTextEarningCode.getToolTipText()), 10, 0);
        moTextEarningCode.setFieldButton(jbPickEarning);
        moTextEarningName.setTextSettings(SGuiUtils.getLabelName(moTextEarningName.getToolTipText()), 100, 0);
        moKeyEarningOtherPaymentType.setKeySettings(miClient, SGuiUtils.getLabelName(moKeyEarningOtherPaymentType.getToolTipText()), true);
        moKeyEarningLoan_n.setKeySettings(miClient, SGuiUtils.getLabelName(jlEarningLoan_n), true);
        moCompEarningValue.setCompoundFieldSettings(miClient);
        moCompEarningValue.getField().setDecimalSettings(SGuiUtils.getLabelName(jlEarningValue), SGuiConsts.GUI_TYPE_DEC_QTY, false); // yes!, is NOT mandatory!
        moCompEarningAuxValue.setCompoundFieldSettings(miClient);
        moCompEarningAuxValue.getField().setDecimalSettings(SGuiUtils.getLabelName(jlEarningAuxValue), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurEarningAuxAmount1.setCompoundFieldSettings(miClient);
        moCurEarningAuxAmount1.getField().setDecimalSettings(SGuiUtils.getLabelName(jlEarningAuxAmount1), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurEarningAuxAmount2.setCompoundFieldSettings(miClient);
        moCurEarningAuxAmount2.getField().setDecimalSettings(SGuiUtils.getLabelName(jlEarningAuxAmount2), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        
        moTextDeductionCode.setTextSettings(SGuiUtils.getLabelName(moTextDeductionCode.getToolTipText()), 10, 0);
        moTextDeductionCode.setFieldButton(jbPickDeduction);
        moTextDeductionName.setTextSettings(SGuiUtils.getLabelName(moTextDeductionName.getToolTipText()), 100, 0);
        moKeyDeductionLoan_n.setKeySettings(miClient, SGuiUtils.getLabelName(jlDeductionLoan_n), true);
        moCompDeductionValue.setCompoundFieldSettings(miClient);
        moCompDeductionValue.getField().setDecimalSettings(SGuiUtils.getLabelName(jlDeductionValue), SGuiConsts.GUI_TYPE_DEC_QTY, false); // yes!, is NOT mandatory!

        moCurEarningsTotal.setCompoundFieldSettings(miClient);
        moCurEarningsTotal.getField().setDecimalSettings(SGuiUtils.getLabelName(jlEarningsTotal), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurDeductionsTotal.setCompoundFieldSettings(miClient);
        moCurDeductionsTotal.getField().setDecimalSettings(SGuiUtils.getLabelName(jlDeductionsTotal), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurNetTotal.setCompoundFieldSettings(miClient);
        moCurNetTotal.getField().setDecimalSettings(SGuiUtils.getLabelName(jlNetTotal), SGuiConsts.GUI_TYPE_DEC_AMT, false);
        
        moFields.addField(moTextEarningCode);
        moFields.addField(moTextEarningName);
        moFields.addField(moKeyEarningOtherPaymentType);
        moFields.addField(moKeyEarningLoan_n);
        moFields.addField(moCompEarningValue.getField());
        moFields.addField(moCompEarningAuxValue.getField());
        moFields.addField(moCurEarningAuxAmount1.getField());
        moFields.addField(moCurEarningAuxAmount2.getField());
        moFields.addField(moTextDeductionCode);
        moFields.addField(moTextDeductionName);
        moFields.addField(moKeyDeductionLoan_n);
        moFields.addField(moCompDeductionValue.getField());
        
        moFields.setFormButton(jbSave);
        
        // prevent from sending focus to next field when key 'enter' pressed:
        moTextEarningCode.setNextField(null);
        moTextDeductionCode.setNextField(null); 

        resetFieldsEarning();
        resetFieldsDeduction();
        mbEditable = true;
        setEnableFields(mbEditable);

        moGridReceiptEarnings = new SGridPaneForm(miClient, SModConsts.HRSX_PAY_REC_EAR, SLibConsts.UNDEFINED, "Percepciones") {
            @Override
            public void initGrid() {
                setRowButtonsEnabled(false, true, true);
            }

            @Override
            public ArrayList<SGridColumnForm> createGridColumns() {
                SGridColumnForm columnForm;
                ArrayList<SGridColumnForm> gridColumnsForm = new ArrayList<>();

                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_INT_1B, "#", 20));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "Percepci√≥n", 125));
                columnForm = new SGridColumnForm(SGridConsts.COL_TYPE_DEC_QTY, "Cantidad", 55);
                columnForm.setEditable(mbEditable);
                gridColumnsForm.add(columnForm);
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_CODE_UNT, "Unidad", 45));
                columnForm = new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto unitario $", 80);
                columnForm.setEditable(mbEditable);
                gridColumnsForm.add(columnForm);
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto $", 80));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_QTY, "Cantidad ajustada", 55));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_CODE_UNT, "Unidad", 45));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Parte exenta $", 80));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Parte gravada $", 80));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_CAT_M, "Cr√©dito/pr√©stamo"));
                
                return gridColumnsForm;
            }
            
            @Override
            public void actionRowEdit() {
                SHrsReceiptEarning hrsReceiptEarning = null;
                
                try {
                    hrsReceiptEarning = (SHrsReceiptEarning) moGridReceiptEarnings.getSelectedGridRow();

                    SDialogPayrollEarning dlgPayrollEarning = new SDialogPayrollEarning(miClient, hrsReceiptEarning.clone(), "Percepci√≥n");
                    dlgPayrollEarning.setVisible(true);
                    
                    if (dlgPayrollEarning.getFormResult() == SGuiConsts.FORM_RESULT_OK) {
                        refreshReceiptMovements();
                    }
                }
                catch (Exception e) {
                    SLibUtils.printException(this, e);
                }
            }
            
            @Override
            public void actionRowDelete() {
                int moveId = 0;
                boolean remove = false;
                SHrsReceiptEarning hrsReceiptEarning = null;

                if (jtTable.getSelectedRowCount() != 1) {
                    miClient.showMsgBoxInformation(SGridConsts.MSG_SELECT_ROW);
                }
                else {
                    hrsReceiptEarning = (SHrsReceiptEarning) moGridReceiptEarnings.getSelectedGridRow();
                    
                    if (hrsReceiptEarning.getPayrollReceiptEarning().isSystem()) {
                        miClient.showMsgBoxInformation(SDbConsts.MSG_REG_ + hrsReceiptEarning.getEarning().getName() + SDbConsts.MSG_REG_IS_SYSTEM + "\n" +
                        "Se debe eliminar mediante la eliminaci√≥n del consumo de incidencia respectivo.");
                    }
                    else {
                        for (SHrsReceiptEarning hrsReceiptEarningToRemove : moHrsReceipt.getHrsReceiptEarnings()) {
                            if (SLibUtils.compareKeys(hrsReceiptEarningToRemove.getRowPrimaryKey(), hrsReceiptEarning.getRowPrimaryKey())) {
                                remove = true;
                                moveId = hrsReceiptEarningToRemove.getPayrollReceiptEarning().getPkMoveId();
                                break;
                            }
                        }

                        if (remove) {
                            moHrsReceipt.removeHrsReceiptEarning(moveId);
                            refreshReceiptMovements();
                        }
                    }
                }
            }
        };

        moGridReceiptEarnings.setForm(null);
        moGridReceiptEarnings.setPaneFormOwner(this);
        jpEarnings.add(moGridReceiptEarnings, BorderLayout.CENTER);

        moGridReceiptDeductions = new SGridPaneForm(miClient, SModConsts.HRSX_PAY_REC_DED, SLibConsts.UNDEFINED, "Deducciones") {
            @Override
            public void initGrid() {
                setRowButtonsEnabled(false, false, true);
            }

            @Override
            public ArrayList<SGridColumnForm> createGridColumns() {
                SGridColumnForm columnForm;
                ArrayList<SGridColumnForm> gridColumnsForm = new ArrayList<>();

                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_INT_1B, "#", 20));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "Deducci√≥n", 125));
                columnForm = new SGridColumnForm(SGridConsts.COL_TYPE_DEC_QTY, "Cantidad", 55);
                columnForm.setEditable(mbEditable);
                gridColumnsForm.add(columnForm);
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_CODE_UNT, "Unidad", 45));
                columnForm = new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto unitario $", 80);
                columnForm.setEditable(mbEditable);
                gridColumnsForm.add(columnForm);
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_AMT, "Monto $", 80));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_NAME_CAT_M, "Cr√©dito/pr√©stamo"));

                moGridReceiptDeductions.getTable().getDefaultEditor(Double.class).addCellEditorListener(SDialogPayrollReceipt.this);

                return gridColumnsForm;
            }
            
            @Override
            public void actionRowDelete() {
                int moveId = 0;
                boolean remove = false;

                if (jtTable.getSelectedRowCount() != 1) {
                    miClient.showMsgBoxInformation(SGridConsts.MSG_SELECT_ROW);
                }
                else {
                    SHrsReceiptDeduction hrsReceiptDeduction = (SHrsReceiptDeduction) moGridReceiptDeductions.getSelectedGridRow();
                    
                    for (SHrsReceiptDeduction hrsReceiptDeductionToRemove : moHrsReceipt.getHrsReceiptDeductions()) {
                        if (SLibUtils.compareKeys(hrsReceiptDeductionToRemove.getRowPrimaryKey(), hrsReceiptDeduction.getRowPrimaryKey())) {
                            remove = true;
                            moveId = hrsReceiptDeductionToRemove.getPayrollReceiptDeduction().getPkMoveId();
                            break;
                        }
                    }
                    
                    if (remove) {
                        moHrsReceipt.removeHrsReceiptDeduction(moveId);
                        refreshReceiptMovements();
                    }
                }
            }
        };

        moGridReceiptDeductions.setForm(null);
        moGridReceiptDeductions.setPaneFormOwner(this);
        jpDeductions.add(moGridReceiptDeductions, BorderLayout.CENTER);
        
        moGridAbsenceConsumptions = new SGridPaneForm(miClient, SModConsts.HRS_ABS_CNS, SLibConsts.UNDEFINED, "Consumo incidencias") {
            @Override
            public void initGrid() {
                setRowButtonsEnabled(true, false, true);
            }

            @Override
            public ArrayList<SGridColumnForm> createGridColumns() {
                ArrayList<SGridColumnForm> gridColumnsForm = new ArrayList<>();

                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT, "Clase incidencia"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT, "Tipo incidencia"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_TEXT_CODE_CAT, "Folio"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE, "Inicial incidencia"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE, "Final incidencia"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_QTY, "D√≠as efectivos incidencia"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE, "Inicial consumo"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DATE, "Final consumo"));
                gridColumnsForm.add(new SGridColumnForm(SGridConsts.COL_TYPE_DEC_QTY, "D√≠as efectivos consumo"));

                return gridColumnsForm;
            }
            
            @Override
            public void actionRowNew() {
                SDialogPayrollReceiptAbsence dlgAbsence = new SDialogPayrollReceiptAbsence(miClient, "Consumo de incidencias");
                dlgAbsence.setValue(SModConsts.HRS_PAY_RCP, moHrsReceipt);
                dlgAbsence.setFormVisible(true);

                if (dlgAbsence.getFormResult() == SGuiConsts.FORM_RESULT_OK) {
                    populateAbsenceConsumption();
                    refreshReceiptMovements();
                }
            }
            
            @Override
            public void actionRowDelete() {
                try {
                    if (jtTable.getSelectedRowCount() == 0) {
                        miClient.showMsgBoxInformation(SGridConsts.MSG_SELECT_ROWS);
                    }
                    else if (miClient.showMsgBoxConfirm(SGridConsts.MSG_CONFIRM_REG_DEL) == JOptionPane.YES_OPTION) {
                        SGridRow[] gridRows = getSelectedGridRows();

                        for (int i = 0; i < gridRows.length; i++) {
                            SGridRow gridRow = gridRows[i];
                            SDbAbsenceConsumption absenceConsumption = (SDbAbsenceConsumption) gridRow;
                            
                            moHrsReceipt.updateHrsReceiptEarningAbsence(absenceConsumption, false);

                            moModel.getGridRows().remove(moModel.getGridRows().indexOf(gridRow));
                            
                            populateAbsenceConsumption();
                            refreshReceiptMovements();
                        }
                    }
                }
                catch (Exception e) {
                    SLibUtils.showException(this, e);
                }
            }
        };

        moGridAbsenceConsumptions.setForm(null);
        moGridAbsenceConsumptions.setPaneFormOwner(null);
        jpAbsenceConsumption.add(moGridAbsenceConsumptions, BorderLayout.CENTER);
        
        reloadCatalogues();
        addAllListeners();
    }
    
    private void renderEmployee() {
        SDbEmployee employee = moHrsReceipt.getHrsEmployee().getEmployee();
        
        moTextName.setValue(employee.getXtaEmployeeName());
        moTextNumber.setValue(employee.getNumber());
        moTextFiscalId.setValue(employee.getXtaEmployeeRfc());
        moTextAlternativeId.setValue(employee.getXtaEmployeeCurp());
        moTextSocialSecurityNumber.setValue(employee.getSocialSecurityNumber());
        moTextPaymentType.setValue(miClient.getSession().readField(SModConsts.HRSS_TP_PAY, new int[] { employee.getFkPaymentTypeId() }, SDbRegistry.FIELD_NAME));
        moDecSalary.setValue(employee.getSalary());
        moDecWage.setValue(employee.getWage());
        moDecSalarySscBase.setValue(employee.getSalarySscBase());
        moTextDateBirth.setValue(SLibUtils.DateFormatDate.format(employee.getDateBirth()));
        moTextDateBenefits.setValue(SLibUtils.DateFormatDate.format(employee.getDateBenefits()));
        moTextDateLastHire.setValue(SLibUtils.DateFormatDate.format(employee.getDateLastHire()));
        moTextDateLastDismissal_n.setValue(employee.getDateLastDismissal_n() != null ? SLibUtils.DateFormatDate.format(employee.getDateLastDismissal_n()) : "");
        moTextSalaryType.setValue(miClient.getSession().readField(SModConsts.HRSS_TP_SAL, new int[] { employee.getFkSalaryTypeId() }, SDbRegistry.FIELD_NAME));
        moTextEmployeeType.setValue(miClient.getSession().readField(SModConsts.HRSU_TP_EMP, new int[] { employee.getFkEmployeeTypeId() }, SDbRegistry.FIELD_NAME));
        moTextWorkerType.setValue(miClient.getSession().readField(SModConsts.HRSU_TP_WRK, new int[] { employee.getFkWorkerTypeId() }, SDbRegistry.FIELD_NAME));
        moTextDepartament.setValue(miClient.getSession().readField(SModConsts.HRSU_DEP, new int[] { employee.getFkDepartmentId() }, SDbRegistry.FIELD_NAME));
        moTextPosition.setValue(miClient.getSession().readField(SModConsts.HRSU_POS, new int[] { employee.getFkPositionId() }, SDbRegistry.FIELD_NAME));
        moTextShift.setValue(miClient.getSession().readField(SModConsts.HRSU_SHT, new int[] { employee.getFkShiftId() }, SDbRegistry.FIELD_NAME));
        moTextRecruitmentSchemeType.setValue(miClient.getSession().readField(SModConsts.HRSS_TP_REC_SCHE, new int[] { employee.getFkRecruitmentSchemeTypeId()}, SDbRegistry.FIELD_NAME));
        moIntWorkingHoursDay.setValue(employee.getWorkingHoursDay());
    }

    private SDbPayrollReceiptEarning createPayrollReceipEarning(SHrsReceipt hrsReceipt, SHrsEmployeeDays hrsEmployeeDays) {
        double unitsAlleged;
        double amountUnitAlleged;
        int[] loanKey = moKeyEarningLoan_n.getSelectedIndex() <= 0 ? new int[] { 0, 0 } : moKeyEarningLoan_n.getValue();
        
        if (moHrsBenefit == null) {
            if (moEarning.isBasedOnUnits()) {
                unitsAlleged = moCompEarningValue.getField().getValue();
                amountUnitAlleged = 0;
            }
            else {
                unitsAlleged = 1;
                amountUnitAlleged = moCompEarningValue.getField().getValue();
            }
        }
        else {
            if (moEarning.isBasedOnUnits()) {
                unitsAlleged = moHrsBenefit.getValuePayedReceipt();
                amountUnitAlleged = 0;
            }
            else {
                unitsAlleged = 1;
                amountUnitAlleged = moHrsBenefit.getAmountPayedReceipt();
            }
        }
        
        SDbPayrollReceiptEarning earning = hrsReceipt.getHrsPayroll().createPayrollReceiptEarning(
                hrsReceipt, moEarning, hrsEmployeeDays, moHrsBenefit, 
                unitsAlleged, amountUnitAlleged, false, 
                loanKey[0], loanKey[1], moGridReceiptEarnings.getTable().getRowCount() + 1);
        
        // consider specialized inputs:
        
        earning.setFkOtherPaymentTypeId(moKeyEarningOtherPaymentType.getValue()[0]);
        earning.setAuxiliarValue(moCompEarningAuxValue.getField().getValue());
        earning.setAuxiliarAmount1(moCurEarningAuxAmount1.getField().getValue());
        earning.setAuxiliarAmount2(moCurEarningAuxAmount2.getField().getValue());
        
        return earning;
    }

    private SDbPayrollReceiptDeduction createPayrollReceipDeduction(SHrsReceipt hrsReceipt) {
        double unitsAlleged;
        double amountUnitAlleged;
        int[] loanKey = moKeyDeductionLoan_n.getSelectedIndex() <= 0 ? new int[] { 0, 0 } : moKeyDeductionLoan_n.getValue();
        
        if (moDeduction.isBasedOnUnits()) {
            unitsAlleged = moCompDeductionValue.getField().getValue();
            amountUnitAlleged = 0;
        }
        else {
            unitsAlleged = 1;
            amountUnitAlleged = moCompDeductionValue.getField().getValue();
        }
        
        SDbPayrollReceiptDeduction deduction = hrsReceipt.getHrsPayroll().createPayrollReceiptDeduction(
                hrsReceipt, moDeduction, 
                unitsAlleged, amountUnitAlleged, false, 
                loanKey[0], loanKey[1], moGridReceiptDeductions.getTable().getRowCount() + 1);
        
        return deduction;
    }
    
    private void createBenefit(final SDbEarning earning) throws Exception {
        int benefitType = 0;
        Date dateCutOff = null;
        SDbBenefitTable benefitTable = null;
        SDbBenefitTable benefitTableAux = null;
        SHrsBenefitParams benefitParams = null;
        
        benefitTable = SHrsUtils.getBenefitTableByEarning(miClient.getSession(), 
                earning.getPkEarningId(), 
                moHrsReceipt.getHrsPayroll().getPayroll().getFkPaymentTypeId(), 
                moHrsReceipt.getHrsPayroll().getPayroll().getDateEnd());
        
        benefitType = benefitTable.getFkBenefitTypeId();
        
        if (benefitType == SLibConsts.UNDEFINED) {
            throw new Exception("No se encontr√≥ ninguna prestaci√≥n para el tipo de prestaci√≥n definido en la percepci√≥n '" + earning.getName() + "'.");
        }
        else if (earning.getFkBenefitTypeId() != benefitType) {
            throw new Exception("El tipo de prestaci√≥n de la percepci√≥n '" + earning.getName() + "', es diferente al tipo de prestaci√≥n de la prestaci√≥n '" + benefitTable.getName() + "'.");
        }
        
        // check if benefit is vacation bonus:
        if (benefitType == SModSysConsts.HRSS_TP_BEN_VAC_BON) {
            int tableAuxId = SHrsUtils.getRecentBenefitTable(miClient.getSession(), 
                    SModSysConsts.HRSS_TP_BEN_VAC, 
                    moHrsReceipt.getHrsPayroll().getPayroll().getFkPaymentTypeId(), 
                    moHrsReceipt.getHrsPayroll().getPayroll().getDateEnd());
            benefitTableAux = moHrsReceipt.getHrsPayroll().getBenefitTable(tableAuxId);
            
            if (benefitTableAux == null) {
                throw new Exception("No se encontr√≥ ninguna tabla para la prestaci√≥n 'Vacaciones' que es requerida para el pago de la prestaci√≥n 'Prima Vacacional'.");
            }
        }
        
        if (!moHrsReceipt.getHrsEmployee().getEmployee().isActive()) {
            dateCutOff = moHrsReceipt.getHrsEmployee().getEmployee().getDateLastDismissal_n();
            
            if (benefitType != SModSysConsts.HRSS_TP_BEN_ANN_BON && !SLibTimeUtils.isBelongingToPeriod(dateCutOff, moHrsReceipt.getHrsPayroll().getPayroll().getDateStart(), moHrsReceipt.getHrsPayroll().getPayroll().getDateEnd())) {
                dateCutOff = moHrsReceipt.getHrsPayroll().getPayroll().getDateEnd();
            }
        }
        else if (benefitType == SModSysConsts.HRSS_TP_BEN_ANN_BON) {
            dateCutOff = SLibTimeUtils.getEndOfYear(moHrsReceipt.getHrsPayroll().getPayroll().getDateEnd());
        }
        else {
            dateCutOff = moHrsReceipt.getHrsPayroll().getPayroll().getDateEnd();
        }
        
        // Create benefit params:
        benefitParams = new SHrsBenefitParams(earning, benefitTable, benefitTableAux, moHrsReceipt, dateCutOff);
        
        SDialogPayrollBenefit dlgBenefit = new SDialogPayrollBenefit(miClient, benefitType, "Agregar prestaci√≥n");
        dlgBenefit.setValue(SGuiConsts.PARAM_ROWS, benefitParams);
        dlgBenefit.setVisible(true);
        
        if (dlgBenefit.getFormResult() == SGuiConsts.FORM_RESULT_OK) {
            moHrsBenefit = (SHrsBenefit) dlgBenefit.getValue(SGuiConsts.PARAM_ROWS);
            if (moEarning.isBasedOnUnits()) {
                moCompEarningValue.getField().setValue(moHrsBenefit.getValuePayedReceipt());
            }
            else {
                moCompEarningValue.getField().setValue(moHrsBenefit.getAmountPayedReceipt());
            }
            
            actionAddEarning();
        }
    }

    private void computeTotal() {
        double earningTotal = 0;
        double deductionTotal = 0;

        for (SHrsReceiptEarning hrsReceiptEarning : moHrsReceipt.getHrsReceiptEarnings()) {
            earningTotal += hrsReceiptEarning.getPayrollReceiptEarning().getAmount_r();
        }
        
        for (SHrsReceiptDeduction hrsReceiptDeduction : moHrsReceipt.getHrsReceiptDeductions()) {
            deductionTotal += hrsReceiptDeduction.getPayrollReceiptDeduction().getAmount_r();
        }

        moCurEarningsTotal.getField().setValue(earningTotal);
        moCurDeductionsTotal.getField().setValue(deductionTotal);
        moCurNetTotal.getField().setValue(earningTotal - deductionTotal);
    }

    private void setEnableFields(boolean enable) {
        moTextEarningCode.setEnabled(enable);
        jbPickEarning.setEnabled(enable);
        moCompEarningValue.setEditable(enable);
        jbAddEarning.setEnabled(enable);
        moKeyEarningLoan_n.setEnabled(enable && moKeyEarningLoan_n.getItemCount() > 0);
        
        if (!enable) {
            moKeyEarningOtherPaymentType.setEnabled(false);
            
            jlEarningAuxValue.setEnabled(false);
            moCompEarningAuxValue.setEnabled(false);
            jlEarningAuxAmount1.setEnabled(false);
            jlEarningAuxAmount1Hint.setEnabled(false);
            moCurEarningAuxAmount1.setEnabled(false);
            jlEarningAuxAmount2.setEnabled(false);
            jlEarningAuxAmount2Hint.setEnabled(false);
            moCurEarningAuxAmount2.setEnabled(false);
        }
        
        moTextDeductionCode.setEnabled(enable);
        jbPickDeduction.setEnabled(enable);
        moCompDeductionValue.setEditable(enable);
        jbAddDeduction.setEnabled(enable);
        moKeyDeductionLoan_n.setEnabled(enable && moKeyDeductionLoan_n.getItemCount() > 0);
        
        jbSave.setEnabled(enable);
    }

    private void resetFieldsEarningAux() {
        jlEarningAuxValue.setText(LABEL_AUX_VAL + ":");
        jlEarningAuxValue.setEnabled(false);
        //jlEarningAuxValueHint.setToolTipText(null);
        //jlEarningAuxValueHint.setEnabled(false);
        moCompEarningAuxValue.setEnabled(false); // field rarely used; preferable disabling it when not used
        moCompEarningAuxValue.getField().setMandatory(false);
        moCompEarningAuxValue.setCompoundText("");
        moCompEarningAuxValue.getField().setGuiType(SGuiConsts.GUI_TYPE_DEC_AMT);
        moCompEarningAuxValue.getField().setMinDouble(0);
        moCompEarningAuxValue.getField().setMaxDouble(Double.MAX_VALUE);
        moCompEarningAuxValue.getField().resetField();
        
        jlEarningAuxAmount1.setText(LABEL_AUX_AMT + ":");
        jlEarningAuxAmount1.setEnabled(false);
        jlEarningAuxAmount1Hint.setToolTipText(null);
        jlEarningAuxAmount1Hint.setEnabled(false);
        moCurEarningAuxAmount1.setEnabled(false); // field rarely used; preferable disabling it when not used
        moCurEarningAuxAmount1.getField().setMandatory(false);
        moCurEarningAuxAmount1.getField().resetField();
        
        jlEarningAuxAmount2.setText(LABEL_AUX_AMT + ":");
        jlEarningAuxAmount2.setEnabled(false);
        jlEarningAuxAmount2Hint.setToolTipText(null);
        jlEarningAuxAmount2Hint.setEnabled(false);
        moCurEarningAuxAmount2.setEnabled(false); // field rarely used; preferable disabling it when not used
        moCurEarningAuxAmount2.getField().setMandatory(false);
        moCurEarningAuxAmount2.getField().resetField();
    }
    
    private void resetFieldsEarning() {
        moEarning = null;
        msOriginalEarningCode = "";
        
        moTextEarningCode.resetField();
        moTextEarningName.resetField();
        moCompEarningValue.getField().resetField();
        moCompEarningValue.setCompoundText("");
        
        moKeyEarningLoan_n.setEnabled(false);
        moKeyEarningLoan_n.removeAllItems();

        // resetting of specialized fields:
        moKeyEarningOtherPaymentType.setEnabled(false);
        moKeyEarningOtherPaymentType.resetField(); // may trigger an item-state-changed event
        itemStateChangedKeyEarningOtherPayment(); // force triggering an item-state-changed event
    }

    private void resetFieldsDeduction() {
        moDeduction = null;
        msOriginalDeductionCode = "";
        
        moTextDeductionCode.resetField();
        moTextDeductionName.resetField();
        moCompDeductionValue.getField().resetField();
        moCompDeductionValue.setCompoundText("");
        
        moKeyDeductionLoan_n.setEnabled(false);
        moKeyDeductionLoan_n.removeAllItems();
    }
    
    private void prepareFocusFieldsEarning() {
        moCompEarningValue.getField().setNextButton(null);
        moCompEarningAuxValue.getField().setNextButton(null);
        moCurEarningAuxAmount1.getField().setNextButton(null);
        moCurEarningAuxAmount2.getField().setNextButton(null);

        if (moCurEarningAuxAmount2.isEnabled()) { // field rarely used; preferable disabling it when not used
            moCurEarningAuxAmount2.getField().setNextButton(jbAddEarning);
        }
        else if (moCurEarningAuxAmount1.isEnabled()) { // field rarely used; preferable disabling it when not used
            moCurEarningAuxAmount1.getField().setNextButton(jbAddEarning);
        }
        else if (moCompEarningAuxValue.isEnabled()) { // field rarely used; preferable disabling it when not used
            moCompEarningAuxValue.getField().setNextButton(jbAddEarning);
        }
        else {
            moCompEarningValue.getField().setNextButton(jbAddEarning);
        }
    }
    
    private void prepareFocusFieldsDeduction() {
        moCompDeductionValue.getField().setNextButton(jbAddDeduction);
    }

    private void addHrsReceiptEarning() {
        if (moEarning != null) {
            SHrsEmployeeDays hrsEmployeeDays = moHrsReceipt.getHrsEmployee().createEmployeeDays();
            
            SHrsReceiptEarning hrsReceiptEarning = new SHrsReceiptEarning();
            hrsReceiptEarning.setHrsReceipt(moHrsReceipt);
            hrsReceiptEarning.setEarning(moEarning);
            hrsReceiptEarning.setPayrollReceiptEarning(createPayrollReceipEarning(moHrsReceipt, hrsEmployeeDays));

            try {
                if (moKeyEarningLoan_n.isEnabled() && moKeyEarningLoan_n.getSelectedIndex() > 0) {
                    SDbLoan loan = moHrsReceipt.getHrsEmployee().getLoan(moKeyEarningLoan_n.getValue()[1]);
                    hrsReceiptEarning.getPayrollReceiptEarning().setUserEdited(true);
                    hrsReceiptEarning.getPayrollReceiptEarning().setFkLoanEmployeeId_n(moKeyEarningLoan_n.getValue()[0]);
                    hrsReceiptEarning.getPayrollReceiptEarning().setFkLoanLoanId_n(moKeyEarningLoan_n.getValue()[1]);
                    hrsReceiptEarning.getPayrollReceiptEarning().setFkLoanTypeId_n(loan.getFkLoanTypeId());
                }
                
                moHrsReceipt.addHrsReceiptEarning(hrsReceiptEarning);
                populateEarnings();
                
                populateDeductions();
            }
            catch (Exception e) {
                SLibUtils.printException(this, e);
            }
        }
    }

    private void addHrsReceiptDeduction() {
        if (moDeduction != null) {
            SHrsReceiptDeduction hrsReceiptDeduction = new SHrsReceiptDeduction();
            hrsReceiptDeduction.setHrsReceipt(moHrsReceipt);
            hrsReceiptDeduction.setDeduction(moDeduction);
            hrsReceiptDeduction.setPayrollReceiptDeduction(createPayrollReceipDeduction(moHrsReceipt));

            try {
                if (moKeyDeductionLoan_n.isEnabled() && moKeyDeductionLoan_n.getSelectedIndex() > 0) {
                    SDbLoan loan = moHrsReceipt.getHrsEmployee().getLoan(moKeyDeductionLoan_n.getValue()[1]);
                    hrsReceiptDeduction.getPayrollReceiptDeduction().setUserEdited(true);
                    hrsReceiptDeduction.getPayrollReceiptDeduction().setFkLoanEmployeeId_n(moKeyDeductionLoan_n.getValue()[0]);
                    hrsReceiptDeduction.getPayrollReceiptDeduction().setFkLoanLoanId_n(moKeyDeductionLoan_n.getValue()[1]);
                    hrsReceiptDeduction.getPayrollReceiptDeduction().setFkLoanTypeId_n(loan.getFkLoanTypeId());
                }
                
                moHrsReceipt.addHrsReceiptDeduction(hrsReceiptDeduction);
                populateDeductions();
            }
            catch (Exception e) {
                SLibUtils.printException(this, e);
            }
        }
    }

    private void refreshReceiptMovements() {
        populateEarnings();
        populateDeductions();
    }

    private void populateEarnings() {
        Vector<SGridRow> rows = new Vector<>();

        moGridReceiptEarnings.setRowButtonsEnabled(false, mbEditable, mbEditable);
        for (SHrsReceiptEarning hrsReceiptEarning : moHrsReceipt.getHrsReceiptEarnings()) {
            SHrsReceiptEarning hrsReceiptEarningNew = new SHrsReceiptEarning();
            hrsReceiptEarningNew.setHrsReceipt(moHrsReceipt);
            hrsReceiptEarningNew.setEarning(hrsReceiptEarning.getEarning());
            hrsReceiptEarningNew.setPayrollReceiptEarning(hrsReceiptEarning.getPayrollReceiptEarning());

            rows.add(hrsReceiptEarningNew);
        }

        moGridReceiptEarnings.populateGrid(rows);
        moGridReceiptEarnings.getTable().getDefaultEditor(Double.class).addCellEditorListener(this);

        computeTotal();
    }

    private void populateDeductions() {
        Vector<SGridRow> rows = new Vector<>();

        moGridReceiptDeductions.setRowButtonsEnabled(false, false, mbEditable);
        for (SHrsReceiptDeduction hrsReceiptDeduction : moHrsReceipt.getHrsReceiptDeductions()) {
            SHrsReceiptDeduction hrsReceiptDeductionNew = new SHrsReceiptDeduction();
            hrsReceiptDeductionNew.setHrsReceipt(moHrsReceipt);
            hrsReceiptDeductionNew.setDeduction(hrsReceiptDeduction.getDeduction());
            hrsReceiptDeductionNew.setPayrollReceiptDeduction(hrsReceiptDeduction.getPayrollReceiptDeduction());
            
            rows.add(hrsReceiptDeductionNew);
        }

        moGridReceiptDeductions.populateGrid(rows);
        moGridReceiptDeductions.getTable().getDefaultEditor(Double.class).addCellEditorListener(this);
        
        computeTotal();
    }
    
    private void populateAbsenceConsumption() {
        Vector<SGridRow> rows = new Vector<>();

        moGridAbsenceConsumptions.setRowButtonsEnabled(mbEditable, false, mbEditable);
        for (SDbAbsenceConsumption absenceConsumption : moHrsReceipt.getAbsenceConsumptions()) {
            SDbAbsence absence = (SDbAbsence) miClient.getSession().readRegistry(SModConsts.HRS_ABS, new int[] { absenceConsumption.getPkEmployeeId(), absenceConsumption.getPkAbsenceId() });
            
            absenceConsumption.setAuxNumber(absence.getNumber());
            absenceConsumption.setAuxDateStart(absence.getDateStart());
            absenceConsumption.setAuxDateEnd(absence.getDateEnd());
            absenceConsumption.setAuxEffectiveDays(absence.getEffectiveDays());
            
            rows.add(absenceConsumption);
        }
        
        moGridAbsenceConsumptions.populateGrid(rows);
        moGridAbsenceConsumptions.setSelectedGridRow(0);
    }
    
    private void updateReceipt() {
        for (SGridRow row : moGridReceiptEarnings.getModel().getGridRows()) {
            SHrsReceiptEarning hrsReceiptEarningRow = (SHrsReceiptEarning) row;

            for (SHrsReceiptEarning hrsReceiptEarning : moHrsReceipt.getHrsReceiptEarnings()) {
                if (SLibUtils.compareKeys(hrsReceiptEarning.getRowPrimaryKey(), hrsReceiptEarningRow.getRowPrimaryKey())) {
                    if (!hrsReceiptEarning.getPayrollReceiptEarning().isAutomatic() && hrsReceiptEarningRow.getPayrollReceiptEarning().getUnits() == 0) {
                        moHrsReceipt.removeHrsReceiptEarning(hrsReceiptEarning.getPayrollReceiptEarning().getPkMoveId());
                        break;
                    }
                }
            }
        }

        for (SGridRow row : moGridReceiptDeductions.getModel().getGridRows()) {
            SHrsReceiptDeduction hrsReceiptDeductionRow = (SHrsReceiptDeduction) row;

            for (SHrsReceiptDeduction hrsReceiptDeduction : moHrsReceipt.getHrsReceiptDeductions()) {
                if (SLibUtils.compareKeys(hrsReceiptDeduction.getRowPrimaryKey(), hrsReceiptDeductionRow.getRowPrimaryKey())) {
                    if (!hrsReceiptDeduction.getPayrollReceiptDeduction().isAutomatic() && hrsReceiptDeductionRow.getPayrollReceiptDeduction().getAmountUnitary() == 0) {
                        moHrsReceipt.removeHrsReceiptDeduction(hrsReceiptDeduction.getPayrollReceiptDeduction().getPkMoveId());
                        break;
                    }
                }
            }
        }
    }

    private void actionLoadEarning(boolean focusJustLost) {
        try {
            if (moTextEarningCode.getValue().isEmpty()) {
                if (focusJustLost) {
                    resetFieldsEarning();
                }
                else {
                    miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + moTextEarningCode.getFieldName() + "'.");
                    moTextEarningCode.requestFocus();
                }
            }
            else if (moEarning == null || !moEarning.getCode().equals(moTextEarningCode.getValue())) {
                // identify earning:
                
                moEarning = null;
                
                for (SDbEarning earning : moEarnigsMap.values()) {
                    if (earning.getCode().equals(moTextEarningCode.getValue())) {
                        moEarning = earning;
                        break;
                    }
                }
                
                // process earning, if any:

                if (moEarning == null) {
                    miClient.showMsgBoxWarning("No se encontr√≥ ninguna percepci√≥n con el c√≥digo '" + moTextEarningCode.getValue() + "'.");
                    moTextEarningName.resetField();
                    moTextEarningCode.requestFocus();
                }
                else if (moEarning.isAbsence()) {
                    miClient.showMsgBoxWarning("No se puede agregar la percepci√≥n '" + moEarning.getName() + " (" + moEarning.getCode() + ")' de forma directa, se debe agregar mediante una incidencia.");
                    moTextEarningCode.requestFocus();
                }
                else {
                    moTextEarningName.setValue(moEarning.getName());
                    moCompEarningValue.setCompoundText(moHrsReceipt.getHrsPayroll().getEarningComputationTypesMap().get(moEarning.getFkEarningComputationTypeId()));
                    moCompEarningValue.getField().setEditable(moEarning.areUnitsModifiable() || !moEarning.isBasedOnUnits());

                    // enable/disable specialized fields:

                    if (moEarning != null && moEarning.isLoan()) {
                        miClient.getSession().populateCatalogue(moKeyEarningLoan_n, SModConsts.HRS_LOAN, SLibConsts.UNDEFINED, new SGuiParams(new int[] { moHrsReceipt.getHrsEmployee().getEmployee().getPkEmployeeId(), moEarning.getFkLoanTypeId()}));
                        moKeyEarningLoan_n.setEnabled(true);
                    }
                    else {
                        moKeyEarningLoan_n.setEnabled(false);
                        moKeyEarningLoan_n.removeAllItems();
                    }

                    // resetting of specialized fields:
                    moKeyEarningOtherPaymentType.setEnabled(false);
                    moKeyEarningOtherPaymentType.setValue(new int[] { moEarning.getFkOtherPaymentTypeId() }); // may trigger an item-state-changed event
                    itemStateChangedKeyEarningOtherPayment(); // force triggering an item-state-changed event
                    
                    switch (moEarning.getFkEarningTypeId()) {
                        case SModSysConsts.HRSS_TP_EAR_TAX_SUB:
                            jlEarningAuxAmount1.setText(SDbEarning.TAX_SUB_LABEL + ":");
                            jlEarningAuxAmount1.setEnabled(true);
                            jlEarningAuxAmount1Hint.setToolTipText(SDbEarning.TAX_SUB_HINT);
                            jlEarningAuxAmount1Hint.setEnabled(true);
                            moCurEarningAuxAmount1.setEnabled(true); // field rarely used; preferable disabling it when used
                            moCurEarningAuxAmount1.getField().setMandatory(false); // yes!, is NOT mandatory!
                            break;
                            
                        case SModSysConsts.HRSS_TP_EAR_OTH:
                            moKeyEarningOtherPaymentType.setEnabled(moEarning.getFkOtherPaymentTypeId() == SModSysConsts.HRSS_TP_OTH_PAY_OTH);
                            break;
                            
                        default:
                    }
                    
                    prepareFocusFieldsEarning();

                    // set focus on next editable field:

                    if (moKeyEarningOtherPaymentType.isEnabled()) {
                        moKeyEarningOtherPaymentType.requestFocus();
                    }
                    else if (moKeyEarningLoan_n.isEnabled()) {
                        moKeyEarningLoan_n.requestFocus();
                    }
                    else if (moCompEarningValue.getField().isEditable()) {
                        moCompEarningValue.getField().getComponent().requestFocus();
                    }
                    else {
                        jbAddEarning.requestFocus();
                    }

                    // create benefit, if it is necessary:
                    
                    moHrsBenefit = null;
                    
                    if (moEarning.isBenefit()) {
                        createBenefit(moEarning);
                    }
                }
            }
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }

    private void actionLoadDeduction(boolean focusJustLost) {
        try {
            if (moTextDeductionCode.getValue().isEmpty()) {
                if (focusJustLost) {
                    resetFieldsDeduction();
                }
                else {
                    miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + moTextDeductionCode.getFieldName() + "'.");
                    moTextDeductionCode.requestFocus();
                }
            }
            else if (moDeduction == null || !moDeduction.getCode().equals(moTextDeductionCode.getValue())) {
                // identify deduction:
                
                moDeduction = null;
                
                for (SDbDeduction deduction : moDeductionsMap.values()) {
                    if (deduction.getCode().equals(moTextDeductionCode.getValue())) {
                        moDeduction = deduction;
                        break;
                    }
                }
                
                // process deduction, if any:

                if (moDeduction == null) {
                    miClient.showMsgBoxWarning("No se encontr√≥ ninguna deducci√≥n con el c√≥digo '" + moTextDeductionCode.getValue() + "'.");
                    moTextDeductionName.resetField();
                    moTextDeductionCode.requestFocus();
                }
                else if (moDeduction.isAbsence()) {
                    miClient.showMsgBoxWarning("No se puede agregar la deducci√≥n '" + moDeduction.getName() + " (" + moDeduction.getCode() + ")' de forma directa, se debe agregar mediante una incidencia.");
                    moTextDeductionCode.requestFocus();
                }
                else {
                    moTextDeductionName.setValue(moDeduction.getName());
                    moCompDeductionValue.setCompoundText(moHrsReceipt.getHrsPayroll().getDeductionComputationTypesMap().get(moDeduction.getFkDeductionComputationTypeId()));
                    moCompDeductionValue.getField().setEditable(moDeduction.areUnitsModifiable() || !moDeduction.isBasedOnUnits());
                    
                    // enable/disable specialized fields:

                    if (moDeduction != null && moDeduction.isLoan()) {
                        miClient.getSession().populateCatalogue(moKeyDeductionLoan_n, SModConsts.HRS_LOAN, SLibConsts.UNDEFINED, new SGuiParams(new int[] { moHrsReceipt.getHrsEmployee().getEmployee().getPkEmployeeId(), moDeduction.getFkLoanTypeId()}));
                        moKeyDeductionLoan_n.setEnabled(true);
                    }
                    else {
                        moKeyDeductionLoan_n.setEnabled(false);
                        moKeyDeductionLoan_n.removeAllItems();
                    }
                    
                    prepareFocusFieldsDeduction();
                    
                    // set focus on next editable field:

                    if (moKeyDeductionLoan_n.isEnabled()) {
                        moKeyDeductionLoan_n.requestFocus();
                    }
                    else if (moCompDeductionValue.getField().isEditable()) {
                        moCompDeductionValue.getField().getComponent().requestFocus();
                    }
                    else {
                        jbAddEarning.requestFocus();
                    }
                }
            }
        }
        catch (Exception e) {
            SLibUtils.printException(this, e);
        }
    }

    private void actionPickEarning() {
        miClient.getSession().showOptionPicker(SModConsts.HRS_EAR, SLibConsts.UNDEFINED, null, moTextEarningCode);
        
        if (!moTextEarningCode.getValue().isEmpty()) {
            actionLoadEarning(false);
        }
    }
    
    private void actionPickDeduction() {
        miClient.getSession().showOptionPicker(SModConsts.HRS_DED, SLibConsts.UNDEFINED, null, moTextDeductionCode);
        
        if (!moTextDeductionCode.getValue().isEmpty()) {
            actionLoadDeduction(false);
        }
    }

    private void actionAddEarning() {
        try {
            if (moEarning == null) {
                miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(moTextEarningCode.getToolTipText()) + "'.");
                moTextEarningCode.requestFocusInWindow();
            }
            else {
                SGuiValidation validation = moFields.validateFields();

                if (SGuiUtils.computeValidation(miClient, validation)) {
                    // special-case validations:
                    
                    if (moCompEarningValue.getField().getValue() == 0 && 
                            miClient.showMsgBoxConfirm(SGuiConsts.MSG_CNF_FIELD_VAL_ + "'" + moCompEarningValue.getField().getFieldName() + "'" + SGuiConsts.MSG_CNF_FIELD_VAL_UNDEF) != JOptionPane.YES_OPTION) {
                        miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + moCompEarningValue.getField().getFieldName() + "'. ");
                        moCompEarningValue.getField().getComponent().requestFocus();
                        return;
                    }

                    if (moKeyEarningOtherPaymentType.isEnabled() && moKeyEarningOtherPaymentType.getValue()[0] == SModSysConsts.HRSS_TP_OTH_PAY_NON) {
                        miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + SGuiUtils.getLabelName(moKeyEarningOtherPaymentType.getToolTipText()) + "'. ");
                        moKeyEarningOtherPaymentType.requestFocus();
                        return;
                    }

                    if (moEarning.isLoan()) {
                        if (moKeyEarningLoan_n.getSelectedIndex() <= 0) {
                            miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(jlEarningLoan_n.getText()) + "'. ");
                            moKeyEarningLoan_n.requestFocus();
                            return;
                        }
                    }

                    if (moEarning.isBenefit() && moHrsBenefit == null) {
                        miClient.showMsgBoxWarning("Se debe capturar la cantidad o monto de la prestaci√≥n '" + moEarning.getName() + "'.");
                        moTextEarningCode.requestFocus();
                        return;
                    }

                    // validate assimilated employees:

                    SDbEmployee employee = moHrsReceipt.getHrsEmployee().getEmployee(); // convenience variable

                    if (employee.isAssimilable() && moEarning.getFkEarningTypeId() != SModSysConsts.HRSS_TP_EAR_ASS_INC) {
                        // this message is duplicated as is in method validateForm(), please synchronize any change!
                        miClient.showMsgBoxWarning(employee.getXtaEmployeeName() + ", "
                        + "cuyo tipo de r√©gimen de contrataci√≥n es '" + miClient.getSession().readField(SModConsts.HRSS_TP_REC_SCHE, new int[] { employee.getFkRecruitmentSchemeTypeId() }, SDbRegistry.FIELD_NAME) + "',\n"
                        + "no puede tener percepciones distintas a '" + miClient.getSession().readField(SModConsts.HRSS_TP_EAR, new int[] { SModSysConsts.HRSS_TP_EAR_ASS_INC }, SDbRegistry.FIELD_NAME) + "'.");
                        moTextEarningCode.requestFocus();
                        return;
                    }

                    // confirm multiple earnings of the same type:
                    for (SHrsReceiptEarning hrsReceiptEarning : moHrsReceipt.getHrsReceiptEarnings()) {
                        if (hrsReceiptEarning.getEarning().getPkEarningId() == moEarning.getPkEarningId() && !moEarning.isLoan() && 
                                    miClient.showMsgBoxConfirm("La percepci√≥n '" + moEarning.getName() + "' ya existe en el recibo.\n"
                                            + "¬øEst√° seguro que desea agregarla otra vez?") != JOptionPane.YES_OPTION) {
                            moTextEarningCode.requestFocus();
                            return;
                        }
                    }

                    // add earning:
                    addHrsReceiptEarning();
                    resetFieldsEarning();
                    moTextEarningCode.requestFocusInWindow();
                }
            }
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }

    private void actionAddDeduction() {
        try {
            if (moDeduction == null) {
                miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(moTextDeductionCode.getToolTipText()) + "'.");
                moTextDeductionCode.requestFocusInWindow();
            }
            else {
                SGuiValidation validation = moFields.validateFields();
                
                if (SGuiUtils.computeValidation(miClient, validation)) {
                    // special-case validations:
                
                    if (moCompDeductionValue.getField().getValue() == 0 && 
                            miClient.showMsgBoxConfirm(SGuiConsts.MSG_CNF_FIELD_VAL_ + "'" + moCompDeductionValue.getField().getFieldName() + "'" + SGuiConsts.MSG_CNF_FIELD_VAL_UNDEF) != JOptionPane.YES_OPTION) {
                        miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + moCompDeductionValue.getField().getFieldName() + "'. ");
                        moCompDeductionValue.getField().getComponent().requestFocus();
                        return;
                    }

                    if (moDeduction.isLoan()) {
                        if (moKeyDeductionLoan_n.getSelectedIndex() <= 0) {
                            miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(jlDeductionLoan_n.getText()) + "'. ");
                            moKeyDeductionLoan_n.requestFocus();
                            return;
                        }
                        else {
                            SDbLoan loan = moHrsReceipt.getHrsEmployee().getLoan(moKeyDeductionLoan_n.getValue()[1]);

                            if (loan.isPlainLoan()) {
                                double loanBalance = SHrsUtils.getLoanBalance(loan, moHrsReceipt, null, null);

                                if (loanBalance <= 0) {
                                    miClient.showMsgBoxWarning("El pr√©stamo '" + loan.composeLoanDescription() + "' " + (loanBalance == 0 ? "est√° saldado" : "tiene un saldo negativo de $" + SLibUtils.getDecimalFormatAmount().format(loanBalance)) + ".");
                                    moCompDeductionValue.getField().getComponent().requestFocus();
                                    return;
                                }
                                else if (moCompDeductionValue.getField().getValue() > loanBalance) {
                                    miClient.showMsgBoxWarning(SGuiConsts.ERR_MSG_FIELD_VAL_ + "'" + SGuiUtils.getLabelName(jlDeductionValue.getText()) + "'" + SGuiConsts.ERR_MSG_FIELD_VAL_LESS_EQUAL + "$" + SLibUtils.getDecimalFormatAmount().format(loanBalance) + ".");
                                    moCompDeductionValue.getField().getComponent().requestFocus();
                                    return;
                                }
                            }
                        }
                    }

                    // validate assimilated employees:

                    SDbEmployee employee = moHrsReceipt.getHrsEmployee().getEmployee(); // convenience variable

                    if (employee.isAssimilable() && moDeduction.getFkDeductionTypeId() != SModSysConsts.HRSS_TP_DED_TAX) {
                        // this message is duplicated as is in method validateForm(), please synchronize any change!
                        miClient.showMsgBoxWarning(employee.getXtaEmployeeName() + ", "
                            + "cuyo tipo de r√©gimen de contrataci√≥n es '" + miClient.getSession().readField(SModConsts.HRSS_TP_REC_SCHE, new int[] { employee.getFkRecruitmentSchemeTypeId() }, SDbRegistry.FIELD_NAME) + "',\n"
                            + "no puede tener deducciones distintas a '" + miClient.getSession().readField(SModConsts.HRSS_TP_DED, new int[] { SModSysConsts.HRSS_TP_DED_TAX }, SDbRegistry.FIELD_NAME) + "'.");
                        moTextDeductionCode.requestFocus();
                        return;
                    }

                    // confirm multiple deductions of the same type:
                    for (SHrsReceiptDeduction hrsReceiptDeduction : moHrsReceipt.getHrsReceiptDeductions()) {
                        if (hrsReceiptDeduction.getDeduction().getPkDeductionId() == moDeduction.getPkDeductionId() && !moDeduction.isLoan() && 
                                miClient.showMsgBoxConfirm("La deducci√≥n '" + moDeduction.getName() + "' ya existe en el recibo.\n"
                                        + "¬øEst√° seguro que desea agregarla otra vez?") != JOptionPane.YES_OPTION) {
                            moTextDeductionCode.requestFocus();
                            return;
                        }
                    }

                    // add deduction:
                    addHrsReceiptDeduction();
                    resetFieldsDeduction();
                    moTextDeductionCode.requestFocusInWindow();
                }
            }
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }

    private void itemStateChangedEarningLoan_n() {
        if (moKeyEarningLoan_n.getSelectedIndex() <= 0) {
            moCompEarningValue.getField().resetField();
        }
    }

    private void itemStateChangedDeductionLoan_n() {
        if (moKeyDeductionLoan_n.getSelectedIndex() <= 0) {
            moCompDeductionValue.getField().resetField();
        }
        else {
            try {
                SDbLoan loan = moHrsReceipt.getHrsEmployee().getLoan(moKeyDeductionLoan_n.getValue()[1]);
                moCompDeductionValue.getField().setValue(SHrsUtils.computeLoanAmount(loan, moHrsReceipt, null, null));
            }
            catch (Exception e) {
                SLibUtils.printException(this, e);
            }
        }
    }
    
    private void itemStateChangedKeyEarningOtherPayment() {
        resetFieldsEarningAux();
        
        if (moKeyEarningOtherPaymentType.getSelectedIndex() > 0) {
            switch (moKeyEarningOtherPaymentType.getValue()[0]) {
                case SModSysConsts.HRSS_TP_OTH_PAY_TAX_BAL:
                    int year = SLibTimeUtils.digestYear(moHrsReceipt.getHrsPayroll().getPayroll().getDateEnd())[0];
                    jlEarningAuxValue.setText(SDbEarning.OTH_TAX_BAL_LABEL_YEAR + ":*");
                    jlEarningAuxValue.setEnabled(true);
                    //jlEarningAuxValueHint.setToolTipText(SDbEarning.OTH_TAX_BAL_HINT_YEAR);
                    //jlEarningAuxValueHint.setEnabled(true);
                    moCompEarningAuxValue.setEnabled(true); // field rarely used; preferable disabling it when used
                    moCompEarningAuxValue.getField().setMandatory(true); // yes!, is mandatory!
                    moCompEarningAuxValue.setCompoundText("");
                    moCompEarningAuxValue.getField().setDecimalFormat(SLibUtils.DecimalFormatCalendarYear);
                    moCompEarningAuxValue.getField().setMinDouble(year - 1);
                    moCompEarningAuxValue.getField().setMaxDouble(year);
                    moCompEarningAuxValue.getField().setValue((double) year);
                    
                    jlEarningAuxAmount1.setText(SDbEarning.OTH_TAX_BAL_LABEL_BAL + ":*");
                    jlEarningAuxAmount1.setEnabled(true);
                    jlEarningAuxAmount1Hint.setToolTipText(SDbEarning.OTH_TAX_BAL_HINT_BAL);
                    jlEarningAuxAmount1Hint.setEnabled(true);
                    moCurEarningAuxAmount1.setEnabled(true); // field rarely used; preferable disabling it when used
                    moCurEarningAuxAmount1.getField().setMandatory(true); // yes!, is mandatory!

                    jlEarningAuxAmount2.setText(SDbEarning.OTH_TAX_BAL_LABEL_REM_BAL + ":");
                    jlEarningAuxAmount2.setEnabled(true);
                    jlEarningAuxAmount2Hint.setToolTipText(SDbEarning.OTH_TAX_BAL_HINT_REM_BAL);
                    jlEarningAuxAmount2Hint.setEnabled(true);
                    moCurEarningAuxAmount2.setEnabled(true); // field rarely used; preferable disabling it when used
                    moCurEarningAuxAmount2.getField().setMandatory(false); // yes!, is NOT mandatory!
                    break;
                    
                default:
            }
        }
        
        prepareFocusFieldsEarning();
    }
    
    private void processCellEditionEarning() {
        boolean refresh = false;
        SHrsReceiptEarning hrsReceiptEarning = (SHrsReceiptEarning) moGridReceiptEarnings.getSelectedGridRow();
        
        if (hrsReceiptEarning != null) {
            switch (moGridReceiptEarnings.getTable().getSelectedColumn()) {
                case COL_VAL:
                    if (hrsReceiptEarning.isEditableValueAlleged()) {
                        refresh = true;
                    }
                    else {
                        miClient.showMsgBoxWarning("No se puede modificar la 'Cantidad' de la percepci√≥n '" + hrsReceiptEarning.getEarning().getName() + "'.");
                    }
                    break;
                case COL_AMT_UNT:
                    if (hrsReceiptEarning.isEditableAmountUnitary(hrsReceiptEarning.getAmountBeingEdited())) {
                        refresh = true;
                    }
                    else {
                        miClient.showMsgBoxWarning("No se puede modificar el 'Monto unitario' de la percepci√≥n '" + hrsReceiptEarning.getEarning().getName() + "'."
                                + (!hrsReceiptEarning.getEarning().isBenefit() ? "" : "El monto capturado no puede ser menor que " + SLibUtils.getDecimalFormatAmount().format(hrsReceiptEarning.getAmountOriginal()) + "."));
                    }
                    break;
                default:
            }
        }
        
        if (refresh) {
            try {
                moHrsReceipt.computeReceipt();
            }
            catch (Exception e) {
                SLibUtils.showException(this, e);
            }
            
            int row = moGridReceiptEarnings.getTable().getSelectedRow();
            refreshReceiptMovements();
            moGridReceiptEarnings.setSelectedGridRow(row);
        }
    }

    private void processCellEditionDeduction() {
        boolean refresh = false;
        SHrsReceiptDeduction hrsReceiptDeduction = (SHrsReceiptDeduction) moGridReceiptDeductions.getSelectedGridRow();
        
        if (hrsReceiptDeduction != null) {
            switch (moGridReceiptDeductions.getTable().getSelectedColumn()) {
                case COL_VAL:
                    if (hrsReceiptDeduction.isEditableValueAlleged()) {
                        refresh = true;
                    }
                    else {
                        miClient.showMsgBoxWarning("No se puede modificar la 'Cantidad' de la deducci√≥n '" + hrsReceiptDeduction.getDeduction().getName() + "'.");
                    }
                    break;
                case COL_AMT_UNT:
                    if (hrsReceiptDeduction.isEditableAmountUnitary(hrsReceiptDeduction.getAmountBeingEdited())) {
                        refresh = true;
                    }
                    else {
                        miClient.showMsgBoxWarning("No se puede modificar el 'Monto unitario' de la deducci√≥n '" + hrsReceiptDeduction.getDeduction().getName() + "'."
                                + (!hrsReceiptDeduction.getDeduction().isBenefit() ? "" : "El monto capturado no puede ser menor que " + SLibUtils.getDecimalFormatAmount().format(hrsReceiptDeduction.getAmountOriginal()) + "."));
                    }
                    break;
                default:
            }
        }
        
        if (refresh) {
            try {
                moHrsReceipt.computeReceipt();
            }
            catch (Exception e) {
                SLibUtils.showException(this, e);
            }
            
            int row = moGridReceiptDeductions.getTable().getSelectedRow();
            refreshReceiptMovements();
            moGridReceiptDeductions.setSelectedGridRow(row);
        }
    }

    @Override
    public void addAllListeners() {
        jbPickEarning.addActionListener(this);
        jbAddEarning.addActionListener(this);
        jbPickDeduction.addActionListener(this);
        jbAddDeduction.addActionListener(this);
        moTextEarningCode.addActionListener(this);
        moTextDeductionCode.addActionListener(this);
        moKeyEarningLoan_n.addItemListener(this);
        moKeyDeductionLoan_n.addItemListener(this);
        moKeyEarningOtherPaymentType.addItemListener(this);
        moTextEarningCode.addFocusListener(this);
        moTextDeductionCode.addFocusListener(this);
    }

    @Override
    public void removeAllListeners() {
        jbPickEarning.removeActionListener(this);
        jbAddEarning.removeActionListener(this);
        jbPickDeduction.removeActionListener(this);
        jbAddDeduction.removeActionListener(this);
        moTextEarningCode.removeActionListener(this);
        moTextDeductionCode.removeActionListener(this);
        moKeyEarningLoan_n.removeItemListener(this);
        moKeyDeductionLoan_n.removeItemListener(this);
        moKeyEarningOtherPaymentType.removeItemListener(this);
        moTextEarningCode.removeFocusListener(this);
        moTextDeductionCode.removeFocusListener(this);
    }

    @Override
    public void reloadCatalogues() {
        miClient.getSession().populateCatalogue(moKeyEarningOtherPaymentType, SModConsts.HRSS_TP_OTH_PAY, 0, null);
    }

    @Override
    public void setRegistry(SDbRegistry registry) throws Exception {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public SDbRegistry getRegistry() throws Exception {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public SGuiValidation validateForm() {
        SGuiValidation validation = moFields.validateFields();

        if (moHrsReceipt.getHrsPayroll().getPayroll().isPayrollNormal()) {
            double daysWorked = 0;
            for (SHrsReceiptEarning hrsReceiptEarning : moHrsReceipt.getHrsReceiptEarnings()) {
                if (hrsReceiptEarning.getEarning().isDaysWorked() && !hrsReceiptEarning.getEarning().isAbsence()) {
                    daysWorked += hrsReceiptEarning.getPayrollReceiptEarning().getUnitsAlleged();
                }
            }
            
            double daysAbsence = 0;
            for (SDbAbsenceConsumption absenceConsumption : moHrsReceipt.getAbsenceConsumptions()) {
                daysAbsence += absenceConsumption.getEffectiveDays();
            }
            
            SHrsEmployeeDays hrsEmployeeDays = moHrsReceipt.getHrsEmployee().createEmployeeDays();
            double maxWorkingDays = hrsEmployeeDays.getWorkingDays();
            double daysCovered = daysWorked + daysAbsence;
            double daysDiff = maxWorkingDays - daysCovered;
            
            if (Math.abs(daysDiff) > 0.0001) {
                String msg = "¬°ADVERTENCIA!\n"
                        + "Los d√≠as laborables del empleado (" + maxWorkingDays + " " + (maxWorkingDays == 1 ? "d√≠a" : "d√≠as") + ") no son consistentes con\n"
                        + "los d√≠as a pagar (" + daysWorked + " " + (daysWorked == 1 ? "d√≠a" : "d√≠as") + ")"
                        + (daysAbsence == 0 ? "" : " m√°s los d√≠as de incidencias (" + daysAbsence + " " + (daysAbsence == 1 ? "d√≠a" : "d√≠as") + ")" + "; esto es: "
                        + maxWorkingDays + " " + (maxWorkingDays == 1 ? "d√≠a" : "d√≠as") + " vs. " + daysCovered + " " + (daysCovered == 1 ? "d√≠a" : "d√≠as")) + ".\n"
                        + "¬°SE PAGAR√Å " + Math.abs(daysDiff) + " " + (Math.abs(daysDiff) == 1 ? "D√çA" : "D√çAS") + " DE " + (daysDiff > 0 ? "MENOS" : "M√ÅS") + " AL EMPLEADO!";
                if (miClient.showMsgBoxConfirm(msg + "\n" + SGuiConsts.MSG_CNF_CONT) == JOptionPane.NO_OPTION) {
                    validation.setMessage("Ajustarse a los d√≠as laborables del empleado (" + maxWorkingDays + " " + (maxWorkingDays == 1 ? "d√≠a" : "d√≠as") + ").");
                    validation.setComponent(moTextEarningCode);
                }
            }
        }
        
        SDbEmployee employee = moHrsReceipt.getHrsEmployee().getEmployee(); // convenience variable
        
        if (employee.isAssimilable()) {
            for (SHrsReceiptEarning hrsReceiptEarning : moHrsReceipt.getHrsReceiptEarnings()) {
                if (hrsReceiptEarning.getEarning().getFkEarningTypeId() != SModSysConsts.HRSS_TP_EAR_ASS_INC) {
                    // this message is duplicated as is in method actionAddEarning(), please synchronize any change!
                    validation.setMessage(employee.getXtaEmployeeName() + ", "
                    + "cuyo tipo de r√©gimen de contrataci√≥n es '" + miClient.getSession().readField(SModConsts.HRSS_TP_REC_SCHE, new int[] { employee.getFkRecruitmentSchemeTypeId() }, SDbRegistry.FIELD_NAME) + "',\n"
                    + "no puede tener percepciones distintas a '" + miClient.getSession().readField(SModConsts.HRSS_TP_EAR, new int[] { SModSysConsts.HRSS_TP_EAR_ASS_INC }, SDbRegistry.FIELD_NAME) + "'.");
                    validation.setComponent(moTextEarningCode);
                    break;
                }
            }
            
            if (validation.isValid()) {
                for (SHrsReceiptDeduction hrsReceiptDeduction : moHrsReceipt.getHrsReceiptDeductions()) {
                    if (hrsReceiptDeduction.getDeduction().getFkDeductionTypeId() != SModSysConsts.HRSS_TP_DED_TAX) {
                        // this message is duplicated as is in method actionAddDeduction(), please synchronize any change!
                        validation.setMessage(employee.getXtaEmployeeName() + ", "
                        + "cuyo tipo de r√©gimen de contrataci√≥n es '" + miClient.getSession().readField(SModConsts.HRSS_TP_REC_SCHE, new int[] { employee.getFkRecruitmentSchemeTypeId() }, SDbRegistry.FIELD_NAME) + "',\n"
                        + "no puede tener deducciones distintas a '" + miClient.getSession().readField(SModConsts.HRSS_TP_DED, new int[] { SModSysConsts.HRSS_TP_DED_TAX }, SDbRegistry.FIELD_NAME) + "'.");
                        validation.setComponent(moTextEarningCode);
                        break;
                    }
                }
            }
        }
        
        return validation;
    }

    @Override
    @SuppressWarnings("unchecked")
    public void setValue(final int type, final Object value) {
        switch (type) {
            case SGuiConsts.PARAM_REQ_PAY:
                mbEditable = (boolean) value;
                setEnableFields(mbEditable);
                break;
                
            case SModConsts.HRS_PAY_RCP:
                moHrsReceipt = (SHrsReceipt) value;
                renderEmployee();
                refreshReceiptMovements();
                populateAbsenceConsumption();
                break;
                
            case SModConsts.HRS_EAR:
                moEarnigsMap = new HashMap<>();
                for (SDbEarning earning : (ArrayList<SDbEarning>) value) {
                    moEarnigsMap.put(earning.getPkEarningId(), earning);
                }
                break;
                
            case SModConsts.HRS_DED:
                moDeductionsMap = new HashMap<>();
                for (SDbDeduction deduction : (ArrayList<SDbDeduction>) value) {
                    moDeductionsMap.put(deduction.getPkDeductionId(), deduction);
                }
                break;
                
            default:
        }
    }

    @Override
    public Object getValue(final int type) {
        Object value = null;

        switch (type) {
            case SModConsts.HRS_PAY_RCP:
                updateReceipt();
                value = moHrsReceipt;
                break;
                
            default:
                break;
        }

        return value;
    }

    @Override
    public void actionSave() {
        try {
            if (!mbEditable) {
                mnFormResult = SGuiConsts.FORM_RESULT_CANCEL;
                dispose();
            }
            else {
                updateReceipt();
                super.actionSave();
            }
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }

    @Override
    public void notifyRowNew(int gridType, int gridSubtype, int row, SGridRow gridRow) {
        computeTotal();
    }

    @Override
    public void notifyRowEdit(int gridType, int gridSubtype, int row, SGridRow gridRow) {
        computeTotal();
    }

    @Override
    public void notifyRowDelete(int gridType, int gridSubtype, int row, SGridRow gridRow) {
        
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof JButton) {
            JButton button = (JButton) e.getSource();

            if (button == jbPickEarning) {
                actionPickEarning();
            }
            else if (button == jbAddEarning) {
                actionAddEarning();
            }
            else if (button == jbPickDeduction) {
                actionPickDeduction();
            }
            else if (button == jbAddDeduction) {
                actionAddDeduction();
            }
        }
        else if (e.getSource() instanceof SBeanFieldText) {
            SBeanFieldText field = (SBeanFieldText) e.getSource();
            
            if (field == moTextEarningCode) {
                actionLoadEarning(false);
            }
            else if (field == moTextDeductionCode) {
                actionLoadDeduction(false);
            }
        }
    }

    @Override
    public void focusGained(FocusEvent e) {
        if (e.getSource() instanceof SBeanFieldText) {
            SBeanFieldText field = (SBeanFieldText) e.getSource();
            
            if (field == moTextEarningCode) {
                msOriginalEarningCode = moTextEarningCode.getValue();
            }
            else if (field == moTextDeductionCode) {
                msOriginalDeductionCode = moTextDeductionCode.getValue();
            }
        }
    }

    @Override
    public void focusLost(FocusEvent e) {
        if (e.getSource() instanceof SBeanFieldText) {
            SBeanFieldText field = (SBeanFieldText) e.getSource();
            
            if (field == moTextEarningCode) {
                if (!msOriginalEarningCode.equals(moTextEarningCode.getValue())) {
                    actionLoadEarning(true);
                }
            }
            else if (field == moTextDeductionCode) {
                if (!msOriginalDeductionCode.equals(moTextDeductionCode.getValue())) {
                    actionLoadDeduction(true);
                }
            }
        }
    }

    @Override
    public void itemStateChanged(ItemEvent e) {
        if (e.getSource() instanceof SBeanFieldKey && e.getStateChange() == ItemEvent.SELECTED) {
            SBeanFieldKey field = (SBeanFieldKey) e.getSource();

            if (field == moKeyEarningLoan_n) {
                itemStateChangedEarningLoan_n();
            }
            else if (field == moKeyDeductionLoan_n) {
                itemStateChangedDeductionLoan_n();
            }
            else if (field == moKeyEarningOtherPaymentType) {
                itemStateChangedKeyEarningOtherPayment();
            }
        }
    }

    @Override
    public void editingStopped(ChangeEvent e) {
        if (moGridReceiptEarnings.getTable().getDefaultEditor(Double.class).equals(e.getSource())) {
            processCellEditionEarning();
        }
        else if (moGridReceiptDeductions.getTable().getDefaultEditor(Double.class).equals(e.getSource())) {
            processCellEditionDeduction();
        }
    }

    @Override
    public void editingCanceled(ChangeEvent e) {
        
    }
}
