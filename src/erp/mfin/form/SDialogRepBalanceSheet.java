/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * SDialogRepBalanceSheet.java
 *
 * Created on 29/06/2010, 05:02:26 PM
 */

package erp.mfin.form;

import erp.data.SDataConstants;
import erp.data.SDataConstantsSys;
import erp.data.SDataReadDescriptions;
import erp.data.SDataUtilities;
import erp.lib.SLibConstants;
import erp.lib.SLibTimeUtilities;
import erp.lib.SLibUtilities;
import erp.lib.form.SFormComponentItem;
import erp.lib.form.SFormField;
import erp.lib.form.SFormUtilities;
import java.awt.BorderLayout;
import java.awt.Cursor;
import java.awt.event.ActionEvent;
import java.awt.event.FocusEvent;
import java.awt.event.ItemEvent;
import java.awt.event.KeyEvent;
import java.sql.ResultSet;
import java.util.Map;
import java.util.Vector;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JFormattedTextField;
import javax.swing.border.TitledBorder;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.view.JasperViewer;

/**
 *
 * @author Sergio Flores, Isabel Servín
 */
public class SDialogRepBalanceSheet extends javax.swing.JDialog implements java.awt.event.ActionListener, java.awt.event.ItemListener, java.awt.event.FocusListener {

    private final erp.client.SClientInterface miClient;
    private erp.lib.form.SFormField moFieldDate;
    private erp.lib.form.SFormField moFieldCurrencyId;
    private erp.lib.form.SFormField moFieldExchangeRate;
    private java.util.Vector<erp.lib.form.SFormField> mvFields;
    
    private erp.mfin.form.SPanelAccount moPanelCostCenterStartId;
    private erp.mfin.form.SPanelAccount moPanelCostCenterEndId;
    
    private java.lang.String msCostCenterBeginId;
    private java.lang.String msCostCenterEndId;

    /** Creates new form SDialogRepBalanceSheet
     * @param client */
    public SDialogRepBalanceSheet(erp.client.SClientInterface client) {
        super(client.getFrame(), false);
        miClient = client;
        initComponents();
        initComponentsExtra();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel2 = new javax.swing.JPanel();
        jPanel6 = new javax.swing.JPanel();
        jPanel3 = new javax.swing.JPanel();
        jlDate = new javax.swing.JLabel();
        jftDate = new javax.swing.JFormattedTextField();
        jbDate = new javax.swing.JButton();
        jPanel7 = new javax.swing.JPanel();
        jlCurrencyId = new javax.swing.JLabel();
        jcbCurrencyId = new javax.swing.JComboBox();
        jbCurrencyId = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        jlExchangeRate = new javax.swing.JLabel();
        jtfExchangeRate = new javax.swing.JTextField();
        jbExchangeRate = new javax.swing.JButton();
        jPanel10 = new javax.swing.JPanel();
        jckShowRecordAdjYearEnd = new javax.swing.JCheckBox();
        jPanel11 = new javax.swing.JPanel();
        jckShowRecordAdjAudit = new javax.swing.JCheckBox();
        jPanel5 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jpFilterBegin = new javax.swing.JPanel();
        jlFilterBegin = new javax.swing.JLabel();
        jpFilterEnd = new javax.swing.JPanel();
        jlFilterEnd = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jpPrint = new javax.swing.JButton();
        jpClose = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Balance general");
        setResizable(false);

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Parámetros del estado financiero:"));
        jPanel2.setLayout(new java.awt.BorderLayout());

        jPanel6.setLayout(new java.awt.GridLayout(5, 1, 0, 5));

        jPanel3.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDate.setText("Fecha de corte: *");
        jlDate.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel3.add(jlDate);

        jftDate.setText("dd/mm/yyyy");
        jftDate.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel3.add(jftDate);

        jbDate.setIcon(new javax.swing.ImageIcon(getClass().getResource("/erp/img/cal_cal.gif"))); // NOI18N
        jbDate.setToolTipText("Seleccionar fecha");
        jbDate.setFocusable(false);
        jbDate.setPreferredSize(new java.awt.Dimension(23, 23));
        jbDate.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbDateActionPerformed(evt);
            }
        });
        jPanel3.add(jbDate);

        jPanel6.add(jPanel3);

        jPanel7.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlCurrencyId.setText("Moneda: *");
        jlCurrencyId.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel7.add(jlCurrencyId);

        jcbCurrencyId.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        jcbCurrencyId.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel7.add(jcbCurrencyId);

        jbCurrencyId.setText("...");
        jbCurrencyId.setToolTipText("Selecionar moneda");
        jbCurrencyId.setFocusable(false);
        jbCurrencyId.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel7.add(jbCurrencyId);

        jPanel6.add(jPanel7);

        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlExchangeRate.setText("Tipo de cambio:");
        jlExchangeRate.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel4.add(jlExchangeRate);

        jtfExchangeRate.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        jtfExchangeRate.setText("0.0000");
        jtfExchangeRate.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel4.add(jtfExchangeRate);

        jbExchangeRate.setText("...");
        jbExchangeRate.setToolTipText("Seleccionar tipo de cambio");
        jbExchangeRate.setFocusable(false);
        jbExchangeRate.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel4.add(jbExchangeRate);

        jPanel6.add(jPanel4);

        jPanel10.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jckShowRecordAdjYearEnd.setText("Incluir ajustes de cierre");
        jckShowRecordAdjYearEnd.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel10.add(jckShowRecordAdjYearEnd);

        jPanel6.add(jPanel10);

        jPanel11.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jckShowRecordAdjAudit.setText("Incluir ajustes de auditoría");
        jckShowRecordAdjAudit.setOpaque(false);
        jckShowRecordAdjAudit.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel11.add(jckShowRecordAdjAudit);

        jPanel6.add(jPanel11);

        jPanel2.add(jPanel6, java.awt.BorderLayout.NORTH);

        jPanel5.setLayout(new java.awt.BorderLayout());

        jPanel8.setLayout(new java.awt.GridLayout(2, 1));

        jpFilterBegin.setBorder(javax.swing.BorderFactory.createTitledBorder("Centro de costo inicial:"));
        jpFilterBegin.setLayout(new java.awt.BorderLayout());

        jlFilterBegin.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jlFilterBegin.setText("[Panel centro de costo]");
        jlFilterBegin.setPreferredSize(new java.awt.Dimension(100, 50));
        jpFilterBegin.add(jlFilterBegin, java.awt.BorderLayout.PAGE_START);

        jPanel8.add(jpFilterBegin);

        jpFilterEnd.setBorder(javax.swing.BorderFactory.createTitledBorder("Centro de costo final:"));
        jpFilterEnd.setLayout(new java.awt.BorderLayout());

        jlFilterEnd.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jlFilterEnd.setText("[Panel centro de costo]");
        jlFilterEnd.setPreferredSize(new java.awt.Dimension(100, 50));
        jpFilterEnd.add(jlFilterEnd, java.awt.BorderLayout.PAGE_START);

        jPanel8.add(jpFilterEnd);

        jPanel5.add(jPanel8, java.awt.BorderLayout.NORTH);

        jPanel2.add(jPanel5, java.awt.BorderLayout.PAGE_END);

        getContentPane().add(jPanel2, java.awt.BorderLayout.CENTER);

        jPanel1.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jpPrint.setText("Imprimir");
        jpPrint.setToolTipText("[Ctrl + Enter]");
        jpPrint.setPreferredSize(new java.awt.Dimension(75, 23));
        jpPrint.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jpPrintActionPerformed(evt);
            }
        });
        jPanel1.add(jpPrint);

        jpClose.setText("Cerrar");
        jpClose.setToolTipText("[Escape]");
        jpClose.setPreferredSize(new java.awt.Dimension(75, 23));
        jpClose.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jpCloseActionPerformed(evt);
            }
        });
        jPanel1.add(jpClose);

        getContentPane().add(jPanel1, java.awt.BorderLayout.SOUTH);

        setSize(new java.awt.Dimension(576, 389));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void jpPrintActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jpPrintActionPerformed
        actionPrint();
    }//GEN-LAST:event_jpPrintActionPerformed

    private void jpCloseActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jpCloseActionPerformed
        actionClose();
    }//GEN-LAST:event_jpCloseActionPerformed

    private void jbDateActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbDateActionPerformed

    }//GEN-LAST:event_jbDateActionPerformed

    @SuppressWarnings("unchecked")
    private void initComponentsExtra() {
        moFieldDate = new SFormField(miClient, SLibConstants.DATA_TYPE_DATE, true, jftDate, jlDate);
        moFieldDate.setPickerButton(jbDate);
        moFieldCurrencyId = new SFormField(miClient, SLibConstants.DATA_TYPE_KEY, true, jcbCurrencyId, jlCurrencyId);
        moFieldCurrencyId.setPickerButton(jbCurrencyId);
        moFieldExchangeRate = new SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, true, jtfExchangeRate, jlExchangeRate);
        moFieldExchangeRate.setDecimalFormat(miClient.getSessionXXX().getFormatters().getDecimalsExchangeRateFormat());
        moFieldExchangeRate.setPickerButton(jbExchangeRate);

        SFormUtilities.populateComboBox(miClient, jcbCurrencyId, SDataConstants.CFGU_CUR);

        moFieldDate.setFieldValue(miClient.getSessionXXX().getWorkingDate());
        moFieldCurrencyId.setFieldValue(new int[] { miClient.getSessionXXX().getParamsErp().getFkCurrencyId() });
        itemStateCurrencyId();

        mvFields = new Vector<SFormField>();
        mvFields.add(moFieldDate);
        mvFields.add(moFieldCurrencyId);
        mvFields.add(moFieldExchangeRate);

        jbDate.addActionListener(this);
        jbCurrencyId.addActionListener(this);
        jbExchangeRate.addActionListener(this);
        jcbCurrencyId.addItemListener(this);

        jckShowRecordAdjYearEnd.setSelected(true);
        jckShowRecordAdjAudit.setSelected(true);
        
        try {
            moPanelCostCenterStartId = new SPanelAccount(miClient, SDataConstants.FIN_CC, false, false, false);
            moPanelCostCenterEndId = new SPanelAccount(miClient, SDataConstants.FIN_CC, false, false, false);
            moPanelCostCenterStartId.getFieldAccount().getComponent().addFocusListener(this);
        }
        catch(Exception e) {
            miClient.showMsgBoxWarning(e.getMessage());
        }

        moPanelCostCenterStartId.resetPanel();
        moPanelCostCenterEndId.resetPanel();
        
        jpFilterBegin.remove(jlFilterBegin);
        jpFilterEnd.remove(jlFilterEnd);

        ((TitledBorder) jpFilterBegin.getBorder()).setTitle("Centro de costo inicial:");
        ((TitledBorder) jpFilterEnd.getBorder()).setTitle("Centro de costo final:");
        jpFilterBegin.add(moPanelCostCenterStartId, BorderLayout.CENTER);
        jpFilterEnd.add(moPanelCostCenterEndId, BorderLayout.CENTER);
        
        msCostCenterBeginId = "";
        msCostCenterEndId = "";

        SFormUtilities.createActionMap(rootPane, this, "actionPrint", "print", KeyEvent.VK_ENTER, KeyEvent.CTRL_DOWN_MASK);
        SFormUtilities.createActionMap(rootPane, this, "actionClose", "close", KeyEvent.VK_ESCAPE, 0);
    }
    
    private void actionCostCenterIdFocusGained() {
    }

    private void actionCostCenterIdFocusLost() {
        if (!moPanelCostCenterStartId.isEmptyAccountId() && moPanelCostCenterEndId.isEmptyAccountId()) {
            moPanelCostCenterEndId.getFieldAccount().setFieldValue(moPanelCostCenterStartId.getFieldAccount().getFieldValue());
        }
    }

    private java.lang.String createParamSql(int section) {
        int[] year = SLibTimeUtilities.digestYear(moFieldDate.getDate());
        String sql = "";
        String sSqlWhere = "";
        String txtProfitLoss = "";
        String account = miClient.getSessionXXX().getParamsErp().getFormatAccountId().replace('9', '0');
        Vector<Integer> levels = SDataUtilities.getAccountLevels(account);

        sSqlWhere = (!jckShowRecordAdjYearEnd.isSelected() ? " AND b_adj_year = 0 " : "") +
                    (!jckShowRecordAdjAudit.isSelected() ? " AND b_adj_audit = 0 " : "");

        sql = "SELECT am.fid_cl_acc_usr, am.fid_cls_acc_usr, acl.cl_acc_usr, acls.cls_acc_usr, " +
                "LEFT(re.fid_acc, " + (levels.get(1) - 1) + ") AS f_id_acc, am.acc, ";

        switch (section) {
            case SDataConstantsSys.REPX_BAL_SHEET_ASSET:
            case SDataConstantsSys.REPX_BAL_SHEET_ORDER_DBT:
                sql += "SUM(re.debit - re.credit) / " + moFieldExchangeRate.getDouble() + " AS f_bal ";
                break;
            case SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY:
            case SDataConstantsSys.REPX_BAL_SHEET_ORDER_CDT:
                sql += "SUM(re.credit - re.debit) / " + moFieldExchangeRate.getDouble() + " AS f_bal ";
                break;
            default:
        }

        sql += "FROM fin_rec AS r INNER JOIN fin_rec_ety AS re ON " +
                "r.id_year = re.id_year AND r.id_per = re.id_per AND r.id_bkc = re.id_bkc AND r.id_tp_rec = re.id_tp_rec AND r.id_num = re.id_num AND " +
                "r.id_year = " + year[0] + " AND r.dt <= '" + miClient.getSessionXXX().getFormatters().getDbmsDateFormat().format(moFieldDate.getDate()) + "' AND " +
                "r.b_del = FALSE AND re.b_del = FALSE " + sSqlWhere +
                "INNER JOIN fin_acc AS am ON " +
                "CONCAT(LEFT(re.fid_acc, " + (levels.get(1) - 1) + "), '" + account.substring(levels.get(1) - 1) + "') = am.id_acc AND " +
                "am.fid_tp_acc_r = " + SDataConstantsSys.FINS_TP_ACC_BAL + " AND am.fid_cl_acc_r BETWEEN ";

        switch (section) {
            case SDataConstantsSys.REPX_BAL_SHEET_ASSET:
                sql += "" + SDataConstantsSys.FINS_CL_ACC_ASSET[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_ASSET[1] + " ";
                break;
            case SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY:
                sql += "" + SDataConstantsSys.FINS_CL_ACC_LIABTY[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_EQUITY[1] + " ";
                break;
            case SDataConstantsSys.REPX_BAL_SHEET_ORDER_DBT:
                sql += "" + SDataConstantsSys.FINS_CL_ACC_ORD_DBT[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_ORD_DBT[1] + " ";
                break;
            case SDataConstantsSys.REPX_BAL_SHEET_ORDER_CDT:
                sql += "" + SDataConstantsSys.FINS_CL_ACC_ORD_CDT[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_ORD_CDT[1] + " ";
                break;
            default:
        }
        
        String sqlWhere = msCostCenterBeginId.isEmpty() ? "" : "WHERE re.fid_cc_n >= '" + msCostCenterBeginId + "' "; 
        sqlWhere += (msCostCenterEndId.isEmpty() ? "" : (msCostCenterBeginId.isEmpty() ? "WHERE " : "AND ") + "re.fid_cc_n <= '" + msCostCenterEndId + "' ");

        sql += "INNER JOIN erp.finu_cl_acc_usr AS acl ON " +
                "am.fid_tp_acc_usr = acl.id_tp_acc_usr AND am.fid_cl_acc_usr = acl.id_cl_acc_usr " +
                "INNER JOIN erp.finu_cls_acc_usr AS acls ON " +
                "am.fid_tp_acc_usr = acls.id_tp_acc_usr AND am.fid_cl_acc_usr = acls.id_cl_acc_usr AND am.fid_cls_acc_usr = acls.id_cls_acc_usr " +
                sqlWhere +
                "GROUP BY am.fid_cl_acc_usr, am.fid_cls_acc_usr, acl.cl_acc_usr, acls.cls_acc_usr, LEFT(re.fid_acc, " + (levels.get(1) - 1) + "), am.acc ";

        // Complimentary query for profit and loss row:

        if (section == SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY) {
            switch (miClient.getSessionXXX().getParamsErp().getFkLanguageId()) {
                case SLibConstants.LAN_SPANISH:
                    txtProfitLoss = SDataConstantsSys.REP_TXT_PROF_LOSS_SPA;
                    break;
                case SLibConstants.LAN_ENGLISH:
                    txtProfitLoss = SDataConstantsSys.REP_TXT_PROF_LOSS_ENG;
                    break;
                default:
                    txtProfitLoss = "?";
            }

            sql += "UNION SELECT " +
                    SDataConstantsSys.FINU_CLS_ACC_USR_EQUITY_GAIN[1] + " AS fid_cl_acc_usr, " +
                    SDataConstantsSys.FINU_CLS_ACC_USR_EQUITY_GAIN[2] + " AS fid_cls_acc_usr, " +
                    "'" + SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINU_CL_ACC_USR, SDataConstantsSys.FINU_CL_ACC_USR_EQUITY) + "' AS cl_acc_usr, " +
                    "'" + SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINU_CLS_ACC_USR, SDataConstantsSys.FINU_CLS_ACC_USR_EQUITY_GAIN) + "' AS cls_acc_usr, " +
                    "'' AS f_id_acc, '" + txtProfitLoss + "' AS acc, " +
                    "SUM(re.credit - re.debit) / " + moFieldExchangeRate.getDouble() + " AS f_bal " +
                    "FROM fin_rec AS r INNER JOIN fin_rec_ety AS re ON " +
                    "r.id_year = re.id_year AND r.id_per = re.id_per AND r.id_bkc = re.id_bkc AND r.id_tp_rec = re.id_tp_rec AND r.id_num = re.id_num AND " +
                    "r.id_year = " + year[0] + " AND r.dt <= '" + miClient.getSessionXXX().getFormatters().getDbmsDateFormat().format(moFieldDate.getDate()) + "' AND " +
                    "r.b_del = FALSE AND re.b_del = FALSE " + sSqlWhere +
                    "INNER JOIN fin_acc AS am ON " +
                    "CONCAT(LEFT(re.fid_acc, " + (levels.get(1) - 1) + "), '" + account.substring(levels.get(1) - 1) + "') = am.id_acc AND " +
                    "am.fid_tp_acc_r = " + SDataConstantsSys.FINS_TP_ACC_RES + " ";
        }

        //sql += "ORDER BY am.fid_cl_acc_usr, am.fid_cls_acc_usr, acl.cl_acc_usr, acls.cls_acc_usr, LEFT(re.fid_acc, " + (levels.get(1) - 1) + "), am.acc ";
        sql += "ORDER BY fid_cl_acc_usr, fid_cls_acc_usr, cl_acc_usr, cls_acc_usr, f_id_acc, acc ";

        return sql;
    }

    @SuppressWarnings("unchecked")
    private double createParamTotal(int section) {
        int[] year = SLibTimeUtilities.digestYear(moFieldDate.getDate());
        double total = 0;
        String sql = "";
        String sqlWhere = "";
        ResultSet resulSet = null;
        String account = miClient.getSessionXXX().getParamsErp().getFormatAccountId().replace('9', '0');
        Vector<Integer> levels = SDataUtilities.getAccountLevels(account);

        
        try {
            sqlWhere = (!jckShowRecordAdjYearEnd.isSelected() ? " AND b_adj_year = 0 " : "") +
                        (!jckShowRecordAdjAudit.isSelected() ? " AND b_adj_audit = 0 " : "");

            sql = "SELECT ";

            switch (section) {
                case SDataConstantsSys.REPX_BAL_SHEET_ASSET:
                case SDataConstantsSys.REPX_BAL_SHEET_ORDER_DBT:
                    sql += "SUM(re.debit - re.credit) / " + moFieldExchangeRate.getDouble() + " AS f_bal ";
                    break;
                case SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY:
                case SDataConstantsSys.REPX_BAL_SHEET_ORDER_CDT:
                    sql += "SUM(re.credit - re.debit) / " + moFieldExchangeRate.getDouble() + " AS f_bal ";
                    break;
                default:
            }

            sql += "FROM fin_rec AS r INNER JOIN fin_rec_ety AS re ON " +
                    "r.id_year = re.id_year AND r.id_per = re.id_per AND r.id_bkc = re.id_bkc AND r.id_tp_rec = re.id_tp_rec AND r.id_num = re.id_num AND " +
                    "r.id_year = " + year[0] + " AND r.dt <= '" + miClient.getSessionXXX().getFormatters().getDbmsDateFormat().format(moFieldDate.getDate()) +
                    "' AND r.b_del = FALSE AND re.b_del = FALSE " + sqlWhere +
                    "INNER JOIN fin_acc AS am ON " +
                    "CONCAT(LEFT(re.fid_acc, " + (levels.get(1) - 1) + "), '" + account.substring(levels.get(1) - 1) + "') = am.id_acc AND " +
                    "am.fid_tp_acc_r = " + SDataConstantsSys.FINS_TP_ACC_BAL + " AND am.fid_cl_acc_r BETWEEN ";

            switch (section) {
                case SDataConstantsSys.REPX_BAL_SHEET_ASSET:
                    sql += "" + SDataConstantsSys.FINS_CL_ACC_ASSET[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_ASSET[1] + " ";
                    break;
                case SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY:
                    sql += "" + SDataConstantsSys.FINS_CL_ACC_LIABTY[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_EQUITY[1] + " ";
                    break;
                case SDataConstantsSys.REPX_BAL_SHEET_ORDER_DBT:
                    sql += "" + SDataConstantsSys.FINS_CL_ACC_ORD_DBT[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_ORD_DBT[1] + " ";
                    break;
                case SDataConstantsSys.REPX_BAL_SHEET_ORDER_CDT:
                    sql += "" + SDataConstantsSys.FINS_CL_ACC_ORD_CDT[1] + " AND " + SDataConstantsSys.FINS_CL_ACC_ORD_CDT[1] + " ";
                    break;
                default:
            }

            resulSet = miClient.getSession().getStatement().executeQuery(sql);
            while (resulSet.next()) {
                total = resulSet.getDouble("f_bal");
            }

            if (section == SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY) {
                sql = "SELECT SUM(re.credit - re.debit) / " + moFieldExchangeRate.getDouble() + " AS f_bal " +
                        "FROM fin_rec AS r INNER JOIN fin_rec_ety AS re ON " +
                        "r.id_year = re.id_year AND r.id_per = re.id_per AND r.id_bkc = re.id_bkc AND r.id_tp_rec = re.id_tp_rec AND r.id_num = re.id_num AND " +
                        "r.id_year = " + year[0] + " AND r.dt <= '" + miClient.getSessionXXX().getFormatters().getDbmsDateFormat().format(moFieldDate.getDate()) + "' AND " +
                        "r.b_del = FALSE AND re.b_del = FALSE " + sqlWhere +
                        "INNER JOIN fin_acc AS am ON " +
                        "CONCAT(LEFT(re.fid_acc, " + (levels.get(1) - 1) + "), '" + account.substring(levels.get(1) - 1) + "') = am.id_acc AND " +
                        "am.fid_tp_acc_r = " + SDataConstantsSys.FINS_TP_ACC_RES + " ";
                
                resulSet = miClient.getSession().getStatement().executeQuery(sql);
                while (resulSet.next()) {
                    total += resulSet.getDouble("f_bal");
                }
            }
        }
        catch (Exception e) {
            SLibUtilities.renderException(this, e);
        }

        return total;
    }

    private java.lang.String createParamTitle(int section) {
        String title = "";

        switch (section) {
            case SDataConstantsSys.REPX_BAL_SHEET_ASSET:
                title = SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINS_CL_ACC, SDataConstantsSys.FINS_CL_ACC_ASSET);
                break;
            case SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY:
                title = SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINS_CL_ACC, SDataConstantsSys.FINS_CL_ACC_LIABTY) + " Y " +
                        SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINS_CL_ACC, SDataConstantsSys.FINS_CL_ACC_EQUITY);
                break;
            case SDataConstantsSys.REPX_BAL_SHEET_ORDER_DBT:
                title = SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINS_CL_ACC, SDataConstantsSys.FINS_CL_ACC_ORD_DBT);
                break;
            case SDataConstantsSys.REPX_BAL_SHEET_ORDER_CDT:
                title = SDataReadDescriptions.getCatalogueDescription(miClient, SDataConstants.FINS_CL_ACC, SDataConstantsSys.FINS_CL_ACC_ORD_CDT);
                break;
            default:
        }

        return title;
    }

    private void print() {
        Cursor cursor = getCursor();
        Map<String, Object> map = null;
        JasperPrint jasperPrint = null;
        JasperViewer jasperViewer = null;

        try {
            setCursor(new Cursor(Cursor.WAIT_CURSOR));
            
            msCostCenterBeginId = moPanelCostCenterStartId.isEmptyAccountId() ? "" : moPanelCostCenterStartId.getFieldAccount().getString();
            msCostCenterEndId = moPanelCostCenterStartId.isEmptyAccountId() ? "" : moPanelCostCenterEndId.getFieldAccount().getString();
            String costCenterBeginName = moPanelCostCenterStartId.getCurrentInputCostCenter() == null ? "" : moPanelCostCenterStartId.getCurrentInputCostCenter().getCostCenter();
            String costCenterEndName = moPanelCostCenterEndId.getCurrentInputCostCenter() == null ? "" : moPanelCostCenterEndId.getCurrentInputCostCenter().getCostCenter();
            
            map = miClient.createReportParams();
            map.put("oDateTextFormat", miClient.getSessionXXX().getFormatters().getDateTextFormat());
            map.put("tDate", moFieldDate.getDate());
            map.put("sSqlAsset", createParamSql(SDataConstantsSys.REPX_BAL_SHEET_ASSET));
            map.put("sSqlLiabilityEquity", createParamSql(SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY));
            map.put("sSqlOrderDebit", createParamSql(SDataConstantsSys.REPX_BAL_SHEET_ORDER_DBT));
            map.put("sSqlOrderCredit", createParamSql(SDataConstantsSys.REPX_BAL_SHEET_ORDER_CDT));
            map.put("sTitleAsset", createParamTitle(SDataConstantsSys.REPX_BAL_SHEET_ASSET));
            map.put("sTitleLiabilityEquity", createParamTitle(SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY));
            map.put("dTotalAsset", createParamTotal(SDataConstantsSys.REPX_BAL_SHEET_ASSET));
            map.put("dTotalLiabilityEquity", createParamTotal(SDataConstantsSys.REPX_BAL_SHEET_LIABTY_EQUITY));
            map.put("sCurrency", ((SFormComponentItem) jcbCurrencyId.getSelectedItem()).getItem());
            map.put("sCurrencyLocal", miClient.getSessionXXX().getParamsErp().getDbmsDataCurrency().getCurrency());
            map.put("dExchangeRate", moFieldExchangeRate.getDouble());
            map.put("sCostCenterBeginId", msCostCenterBeginId);
            map.put("sCostCenterEndId", msCostCenterEndId);
            map.put("sCostCenterBeginName", costCenterBeginName);
            map.put("sCostCenterEndName", costCenterEndName);
            
            jasperPrint = SDataUtilities.fillReport(miClient, SDataConstantsSys.REP_FIN_STAT_BAL_SHEET, map);
            jasperViewer = new JasperViewer(jasperPrint, false);
            jasperViewer.setTitle(getTitle());
            jasperViewer.setVisible(true);
        }
        catch (Exception e) {
            SLibUtilities.renderException(this, e);
        }
        finally {
            setCursor(cursor);
        }
    }

    private void itemStateCurrencyId() {
        if (jcbCurrencyId.getSelectedIndex() <= 0 ||
                ((int[]) ((SFormComponentItem) jcbCurrencyId.getSelectedItem()).getPrimaryKey())[0] == miClient.getSessionXXX().getParamsErp().getFkCurrencyId()) {
            moFieldExchangeRate.setFieldValue(1d);
            jtfExchangeRate.setEnabled(false);
        }
        else {
            jtfExchangeRate.setEnabled(true);
        }
    }

    private void actionDate() {
        miClient.getGuiDatePickerXXX().pickDate(moFieldDate.getDate(), moFieldDate);
    }

    private void actionCurrencyId() {
        miClient.pickOption(SDataConstants.CFGU_CUR, moFieldCurrencyId, null);
    }

    private void actionExchangeRate() {
        double rate = miClient.pickExchangeRate(moFieldCurrencyId.getKeyAsIntArray()[0], moFieldDate.getDate());

        if (rate != 0d) {
            moFieldExchangeRate.setFieldValue(rate);
            jtfExchangeRate.requestFocus();
        }
    }

    public void actionPrint() {
        boolean error = false;
        JComponent component = null;

        for (SFormField field : mvFields) {
            if (!field.validateField()) {
                error = true;
                component = field.getComponent();
            }
        }

        if (error) {
            if (component != null) {
                component.requestFocus();
            }
        }
        else {
            print();
        }
    }

    public void actionClose() {
        setVisible(false);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JButton jbCurrencyId;
    private javax.swing.JButton jbDate;
    private javax.swing.JButton jbExchangeRate;
    private javax.swing.JComboBox jcbCurrencyId;
    private javax.swing.JCheckBox jckShowRecordAdjAudit;
    private javax.swing.JCheckBox jckShowRecordAdjYearEnd;
    private javax.swing.JFormattedTextField jftDate;
    private javax.swing.JLabel jlCurrencyId;
    private javax.swing.JLabel jlDate;
    private javax.swing.JLabel jlExchangeRate;
    private javax.swing.JLabel jlFilterBegin;
    private javax.swing.JLabel jlFilterEnd;
    private javax.swing.JButton jpClose;
    private javax.swing.JPanel jpFilterBegin;
    private javax.swing.JPanel jpFilterEnd;
    private javax.swing.JButton jpPrint;
    private javax.swing.JTextField jtfExchangeRate;
    // End of variables declaration//GEN-END:variables

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof JButton) {
            JButton button = (JButton) e.getSource();

            if (button == jbDate) {
                actionDate();
            }
            else if (button == jbCurrencyId) {
                actionCurrencyId();
            }
            else if (button == jbExchangeRate) {
                actionExchangeRate();
            }
        }
    }

    @Override
    public void itemStateChanged(ItemEvent e) {
        if (e.getSource() instanceof JComboBox) {
            JComboBox comboBox = (JComboBox) e.getSource();

            if (comboBox == jcbCurrencyId) {
                itemStateCurrencyId();
            }
        }
    }
    
    @Override
    public void focusGained(FocusEvent e) {
        if (e.getSource() instanceof javax.swing.JFormattedTextField) {
            JFormattedTextField formattedTextField = (JFormattedTextField) e.getSource();

            if (formattedTextField == moPanelCostCenterStartId.getFieldAccount().getComponent()) {
                actionCostCenterIdFocusGained();
            }
        }
    }

    @Override
    public void focusLost(FocusEvent e) {
        if (e.getSource() instanceof javax.swing.JFormattedTextField) {
            JFormattedTextField formattedTextField = (JFormattedTextField) e.getSource();

            if (formattedTextField == moPanelCostCenterStartId.getFieldAccount().getComponent()) {
                actionCostCenterIdFocusLost();
            }
        }
    }
}
